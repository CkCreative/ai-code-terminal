<!doctype html><html lang=en-us><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><title>Database Schema | AI Code Terminal: The AI-Native Shell</title><meta name=description content="Complete SQLite database schema with Prisma ORM implementation"><meta name=keywords content="AI development,Claude Code,self-hosted terminal,development environment,AI coding,browser terminal,Docker deployment"><meta name=author content="AI Code Terminal"><meta name=robots content="index, follow"><link rel=canonical href=https://act.drmhse.com/docs/database/schema/><meta property="og:type" content="article"><meta property="og:title" content="Database Schema | AI Code Terminal: The AI-Native Shell"><meta property="og:description" content="Complete SQLite database schema with Prisma ORM implementation"><meta property="og:url" content="https://act.drmhse.com/docs/database/schema/"><meta property="og:site_name" content="AI Code Terminal: The AI-Native Shell"><meta property="og:image" content="https://act.drmhse.com/images/claude_code_in_action.png"><meta property="og:image:width" content="1200"><meta property="og:image:height" content="630"><meta property="og:image:alt" content="AI Code Terminal - Browser-based development environment with Claude integration"><meta name=twitter:card content="summary_large_image"><meta name=twitter:title content="Database Schema | AI Code Terminal: The AI-Native Shell"><meta name=twitter:description content="Complete SQLite database schema with Prisma ORM implementation"><meta name=twitter:image content="https://act.drmhse.com/images/claude_code_in_action.png"><meta name=twitter:image:alt content="AI Code Terminal - Browser-based development environment with Claude integration"><link rel=icon type=image/svg+xml href=/terminal-icon.svg><link rel=icon type=image/png href=/favicon.png sizes=32x32><link rel=apple-touch-icon href=/apple-touch-icon.png sizes=180x180><meta name=theme-color content="#010411"><meta name=msapplication-TileColor content="#010411"><link rel=preconnect href=https://fonts.googleapis.com><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@300;400;500&family=Space+Grotesk:wght@400;500;700&display=swap" rel=stylesheet><script src=https://unpkg.com/feather-icons></script><script type=application/ld+json>{"@context":"https://schema.org","@type":"SoftwareApplication","name":"AI Code Terminal: The AI-Native Shell","description":"A self-hosted development environment for the post-IDE era. Code from any device with a fast, lightweight, AI-native shell.","url":"https:\/\/act.drmhse.com\/","applicationCategory":"DeveloperApplication","operatingSystem":"Linux, macOS, Windows","offers":{"@type":"Offer","price":"0","priceCurrency":"USD"},"author":{"@type":"Organization","name":"AI Code Terminal"}}</script><link rel=stylesheet href=/css/docs.min.css integrity crossorigin=anonymous></head><body class=docs-site><main><div class="docs-grid bg-gray-900 text-gray-100 min-h-screen"><aside class=docs-sidebar><div class=logo-section><div class="flex items-center space-x-3"><div class=logo-box><img src=/android-chrome-512x512.png alt="AI Code Terminal" class="w-10 h-10 rounded-lg"></div><h2 class="text-lg font-semibold text-gray-100">sections<br>& Links</h2></div></div><nav class="p-4 space-y-2 overflow-y-auto"><div class=nav-section><button class="nav-section-toggle flex items-center justify-between w-full px-3 py-2 text-sm font-medium text-blue-400 hover:bg-blue-600/5 rounded-lg transition-colors" data-section=getting-started>
<span class="uppercase tracking-wider">Getting Started</span>
<svg class="w-4 h-4 transform transition-transform chevron" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg></button><ul class="nav-section-content mt-1 space-y-1 max-h-0 overflow-hidden transition-all duration-300 ease-in-out"><li><a href=https://act.drmhse.com/docs/getting-started/introduction/ class=nav-link>Introduction</a></li><li><a href=https://act.drmhse.com/docs/getting-started/quick-start/ class=nav-link>Quick Start</a></li><li><a href=https://act.drmhse.com/docs/getting-started/installation/ class=nav-link>Installation</a></li><li><a href=https://act.drmhse.com/docs/getting-started/github-oauth/ class=nav-link>GitHub OAuth Setup</a></li><li><a href=https://act.drmhse.com/docs/getting-started/configuration/ class=nav-link>Configuration</a></li></ul></div><div class=nav-section><button class="nav-section-toggle flex items-center justify-between w-full px-3 py-2 text-sm font-medium text-blue-400 hover:bg-blue-600/5 rounded-lg transition-colors" data-section=core-features>
<span class="uppercase tracking-wider">Core Features</span>
<svg class="w-4 h-4 transform transition-transform chevron" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg></button><ul class="nav-section-content mt-1 space-y-1 max-h-0 overflow-hidden transition-all duration-300 ease-in-out"><li><a href=https://act.drmhse.com/docs/core-features/terminal-access/ class=nav-link>Terminal Access</a></li><li><a href=https://act.drmhse.com/docs/core-features/workspace-management/ class=nav-link>Workspace Management</a></li><li><a href=https://act.drmhse.com/docs/core-features/github-integration/ class=nav-link>GitHub Integration</a></li><li><a href=https://act.drmhse.com/docs/core-features/claude-integration/ class=nav-link>Claude Integration</a></li><li><a href=https://act.drmhse.com/docs/core-features/real-time-features/ class=nav-link>Real-time Features</a></li></ul></div><div class=nav-section><button class="nav-section-toggle flex items-center justify-between w-full px-3 py-2 text-sm font-medium text-blue-400 hover:bg-blue-600/5 rounded-lg transition-colors" data-section=authentication>
<span class="uppercase tracking-wider">Authentication</span>
<svg class="w-4 h-4 transform transition-transform chevron" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg></button><ul class="nav-section-content mt-1 space-y-1 max-h-0 overflow-hidden transition-all duration-300 ease-in-out"><li><a href=https://act.drmhse.com/docs/authentication/auth-flow/ class=nav-link>Authentication Flow</a></li><li><a href=https://act.drmhse.com/docs/authentication/security-features/ class=nav-link>Security Features</a></li><li><a href=https://act.drmhse.com/docs/authentication/token-management/ class=nav-link>Token Management</a></li></ul></div><div class=nav-section><button class="nav-section-toggle flex items-center justify-between w-full px-3 py-2 text-sm font-medium text-blue-400 hover:bg-blue-600/5 rounded-lg transition-colors" data-section=api>
<span class="uppercase tracking-wider">API & WebSocket</span>
<svg class="w-4 h-4 transform transition-transform chevron" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg></button><ul class="nav-section-content mt-1 space-y-1 max-h-0 overflow-hidden transition-all duration-300 ease-in-out"><li><a href=https://act.drmhse.com/docs/api/endpoints/ class=nav-link>API Endpoints</a></li><li><a href=https://act.drmhse.com/docs/api/websocket/ class=nav-link>WebSocket Events</a></li></ul></div><div class=nav-section><button class="nav-section-toggle flex items-center justify-between w-full px-3 py-2 text-sm font-medium text-blue-400 hover:bg-blue-600/5 rounded-lg transition-colors" data-section=database>
<span class="uppercase tracking-wider">Database</span>
<svg class="w-4 h-4 transform transition-transform chevron" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg></button><ul class="nav-section-content mt-1 space-y-1 max-h-0 overflow-hidden transition-all duration-300 ease-in-out"><li><a href=https://act.drmhse.com/docs/database/schema/ class="nav-link active">Database Schema</a></li><li><a href=https://act.drmhse.com/docs/database/models/ class=nav-link>Data Models</a></li></ul></div><div class=nav-section><button class="nav-section-toggle flex items-center justify-between w-full px-3 py-2 text-sm font-medium text-blue-400 hover:bg-blue-600/5 rounded-lg transition-colors" data-section=development>
<span class="uppercase tracking-wider">Development</span>
<svg class="w-4 h-4 transform transition-transform chevron" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg></button><ul class="nav-section-content mt-1 space-y-1 max-h-0 overflow-hidden transition-all duration-300 ease-in-out"><li><a href=https://act.drmhse.com/docs/development/setup/ class=nav-link>Development Setup</a></li><li><a href=https://act.drmhse.com/docs/development/testing/ class=nav-link>Testing</a></li></ul></div><div class=nav-section><button class="nav-section-toggle flex items-center justify-between w-full px-3 py-2 text-sm font-medium text-blue-400 hover:bg-blue-600/5 rounded-lg transition-colors" data-section=deployment>
<span class="uppercase tracking-wider">Deployment</span>
<svg class="w-4 h-4 transform transition-transform chevron" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg></button><ul class="nav-section-content mt-1 space-y-1 max-h-0 overflow-hidden transition-all duration-300 ease-in-out"><li><a href=https://act.drmhse.com/docs/deployment/docker/ class=nav-link>Docker Deployment</a></li></ul></div></nav></aside><main class=docs-main><header class=main-header><div class=container><nav class=main-nav><a href=https://act.drmhse.com/ class=logo><span class=prompt-char>></span> AI Code Terminal</a><div class=nav-links><a href=/docs/getting-started/introduction/ class=nav-link><i data-feather=book></i>
<span>Documentation</span>
</a><a href=/getting-started/ class=nav-link><i data-feather=book-open></i>
<span>Getting Started</span>
</a><a href=https://github.com/drmhse/ai-code-terminal target=_blank rel="noopener noreferrer" class=nav-link><i data-feather=github></i>
<span>View on GitHub</span></a></div></nav></div></header><div class=docs-breadcrumbs><nav class="flex items-center space-x-2 text-sm"><a href=/ class="text-gray-400 hover:text-gray-100 transition-colors">Home</a>
<svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg>
<a href=/docs class="text-gray-400 hover:text-gray-100 transition-colors">Documentation</a>
<svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg>
<a href=https://act.drmhse.com/docs/database/ class="text-gray-400 hover:text-gray-100 transition-colors">Database & Storage</a>
<svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg>
<span class="text-blue-400 font-medium">Database Schema</span></nav></div><div class=docs-content><article class="max-w-4xl mx-auto"><header class=mb-8><h1 class="text-3xl lg:text-4xl font-bold text-gray-100 mb-4 leading-tight">Database Schema</h1><p class="text-lg text-gray-300 leading-relaxed mb-6">Complete SQLite database schema with Prisma ORM implementation</p><div class="flex items-center space-x-6 text-sm text-gray-400"><div class="flex items-center space-x-2"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3A9 9 0 113 12a9 9 0 0118 0z"/></svg>
<span>11 min read</span></div></div></header><div class="prose prose-invert prose-lg max-w-none"><h1 id=database-schema>Database Schema</h1><p>AI Code Terminal uses SQLite with Prisma ORM for lightweight, efficient data storage. The schema is designed for single-tenant operation with minimal data requirements while maintaining security and performance.</p><h2 id=database-technology-stack>Database Technology Stack</h2><h3 id=core-components>Core Components</h3><ul><li><strong>Database Engine:</strong> SQLite 3.x</li><li><strong>ORM:</strong> Prisma 5.x</li><li><strong>Query Builder:</strong> Prisma Client</li><li><strong>Migrations:</strong> Prisma Migrate</li><li><strong>Schema Definition:</strong> Prisma Schema Language</li></ul><h3 id=advantages-of-sqlite--prisma>Advantages of SQLite + Prisma</h3><ul><li><strong>Zero Configuration:</strong> No database server setup required</li><li><strong>ACID Compliance:</strong> Full transaction support</li><li><strong>Cross-platform:</strong> Works on all operating systems</li><li><strong>Embedded:</strong> No network overhead</li><li><strong>Type Safety:</strong> Prisma generates TypeScript types</li><li><strong>Migration System:</strong> Version-controlled schema changes</li></ul><h2 id=complete-schema-definition>Complete Schema Definition</h2><h3 id=prisma-schema-file>Prisma Schema File</h3><p><strong>Location:</strong> <code>/prisma/schema.prisma</code></p><pre tabindex=0><code class=language-prisma data-lang=prisma>// This is your Prisma schema file
// Learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = &#34;prisma-client-js&#34;
}

datasource db {
  provider = &#34;sqlite&#34;
  url      = env(&#34;DATABASE_URL&#34;)
}

// Single-tenant settings (singleton pattern)
model Settings {
  id                    String    @id @default(&#34;singleton&#34;)
  githubToken           String?   // Encrypted GitHub OAuth access token
  githubTokenIv         String?   // Initialization vector for token encryption
  githubRefreshToken    String?   // Encrypted GitHub OAuth refresh token  
  githubRefreshTokenIv  String?   // Initialization vector for refresh token
  githubTokenExpiresAt  DateTime? // Token expiration timestamp
  theme                 String?   // Current UI theme preference
  preferences           String?   // JSON string of user preferences
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  @@map(&#34;settings&#34;)
}

// Repository workspaces
model Workspace {
  id            String    @id @default(cuid())
  name          String    @unique // Workspace display name
  githubRepo    String    @unique // &#34;owner/repo&#34; format
  githubUrl     String    // Full GitHub repository URL
  githubId      Int?      // GitHub repository ID
  localPath     String    // Local filesystem path
  branch        String    @default(&#34;main&#34;) // Default branch
  description   String?   // Optional description
  isActive      Boolean   @default(true)
  lastSyncAt    DateTime? // Last Git sync timestamp
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  // Relations
  sessions      Session[] // Terminal sessions in this workspace
  
  @@map(&#34;workspaces&#34;)
}

// Terminal sessions
model Session {
  id               String    @id @default(cuid())
  shellPid         Int?      // Process ID of shell process
  socketId         String?   // Socket.IO connection ID
  shell            String    @default(&#34;bash&#34;) // Shell type (bash, zsh, fish)
  status           String    @default(&#34;active&#34;) // active, paused, terminated
  workingDirectory String?   // Current working directory
  environment      String?   // JSON string of environment variables
  lastActivityAt   DateTime  @default(now())
  createdAt        DateTime  @default(now())
  endedAt          DateTime? // Session termination time
  exitCode         Int?      // Shell exit code
  
  // Relations
  workspaceId      String?
  workspace        Workspace? @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  
  @@map(&#34;sessions&#34;)
}

// Authentication and usage logs
model AuthLog {
  id          String   @id @default(cuid())
  action      String   // login, logout, token_refresh, api_access
  success     Boolean
  ipAddress   String?
  userAgent   String?
  details     String?  // JSON string with additional details
  createdAt   DateTime @default(now())
  
  @@map(&#34;auth_logs&#34;)
}

// System metrics and monitoring
model SystemMetric {
  id          String   @id @default(cuid())
  metric      String   // cpu_usage, memory_usage, disk_usage, active_sessions
  value       Float    // Numeric value
  unit        String?  // percentage, bytes, count, etc.
  metadata    String?  // JSON string with additional data
  createdAt   DateTime @default(now())
  
  // Index for efficient time-series queries
  @@index([metric, createdAt])
  @@map(&#34;system_metrics&#34;)
}
</code></pre><h2 id=data-models-deep-dive>Data Models Deep Dive</h2><h3 id=settings-model>Settings Model</h3><p>The Settings model implements a singleton pattern for single-tenant configuration:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-typescript data-lang=typescript><span style=display:flex><span><span style=color:#75715e>// TypeScript interface (generated by Prisma)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>interface</span> <span style=color:#a6e22e>Settings</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>id</span>: <span style=color:#66d9ef>string</span>;                    <span style=color:#75715e>// Always &#34;singleton&#34;
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#a6e22e>githubToken</span>: <span style=color:#66d9ef>string</span> <span style=color:#f92672>|</span> <span style=color:#66d9ef>null</span>;    <span style=color:#75715e>// Encrypted access token
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#a6e22e>githubTokenIv</span>: <span style=color:#66d9ef>string</span> <span style=color:#f92672>|</span> <span style=color:#66d9ef>null</span>;  <span style=color:#75715e>// Encryption IV
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#a6e22e>githubRefreshToken</span>: <span style=color:#66d9ef>string</span> <span style=color:#f92672>|</span> <span style=color:#66d9ef>null</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>githubRefreshTokenIv</span>: <span style=color:#66d9ef>string</span> <span style=color:#f92672>|</span> <span style=color:#66d9ef>null</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>githubTokenExpiresAt</span>: <span style=color:#66d9ef>Date</span> <span style=color:#f92672>|</span> <span style=color:#66d9ef>null</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>theme</span>: <span style=color:#66d9ef>string</span> <span style=color:#f92672>|</span> <span style=color:#66d9ef>null</span>;          <span style=color:#75715e>// &#34;dark&#34; | &#34;light&#34; | custom
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#a6e22e>preferences</span>: <span style=color:#66d9ef>string</span> <span style=color:#f92672>|</span> <span style=color:#66d9ef>null</span>;    <span style=color:#75715e>// JSON preferences
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#a6e22e>createdAt</span>: <span style=color:#66d9ef>Date</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>updatedAt</span>: <span style=color:#66d9ef>Date</span>;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p><strong>Usage Examples:</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-typescript data-lang=typescript><span style=display:flex><span><span style=color:#75715e>// Get current settings
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>settings</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>prisma</span>.<span style=color:#a6e22e>settings</span>.<span style=color:#a6e22e>findUnique</span>({
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>where</span><span style=color:#f92672>:</span> { <span style=color:#a6e22e>id</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;singleton&#39;</span> }
</span></span><span style=display:flex><span>});
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Update GitHub token
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>await</span> <span style=color:#a6e22e>prisma</span>.<span style=color:#a6e22e>settings</span>.<span style=color:#a6e22e>upsert</span>({
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>where</span><span style=color:#f92672>:</span> { <span style=color:#a6e22e>id</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;singleton&#39;</span> },
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>update</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>githubToken</span>: <span style=color:#66d9ef>encryptedToken</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>githubTokenIv</span>: <span style=color:#66d9ef>iv</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>githubTokenExpiresAt</span>: <span style=color:#66d9ef>expiryDate</span>
</span></span><span style=display:flex><span>  },
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>create</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>id</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;singleton&#39;</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>githubToken</span>: <span style=color:#66d9ef>encryptedToken</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>githubTokenIv</span>: <span style=color:#66d9ef>iv</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>githubTokenExpiresAt</span>: <span style=color:#66d9ef>expiryDate</span>
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>});
</span></span></code></pre></div><h3 id=workspace-model>Workspace Model</h3><p>Represents individual repository workspaces:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-typescript data-lang=typescript><span style=display:flex><span><span style=color:#66d9ef>interface</span> <span style=color:#a6e22e>Workspace</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>id</span>: <span style=color:#66d9ef>string</span>;              <span style=color:#75715e>// CUID identifier
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#a6e22e>name</span>: <span style=color:#66d9ef>string</span>;            <span style=color:#75715e>// Display name (unique)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#a6e22e>githubRepo</span>: <span style=color:#66d9ef>string</span>;      <span style=color:#75715e>// &#34;owner/repository&#34;
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#a6e22e>githubUrl</span>: <span style=color:#66d9ef>string</span>;       <span style=color:#75715e>// Full GitHub URL
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#a6e22e>githubId</span>: <span style=color:#66d9ef>number</span> <span style=color:#f92672>|</span> <span style=color:#66d9ef>null</span>; <span style=color:#75715e>// GitHub repository ID
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#a6e22e>localPath</span>: <span style=color:#66d9ef>string</span>;       <span style=color:#75715e>// Filesystem path
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#a6e22e>branch</span>: <span style=color:#66d9ef>string</span>;          <span style=color:#75715e>// Default branch
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#a6e22e>description</span>: <span style=color:#66d9ef>string</span> <span style=color:#f92672>|</span> <span style=color:#66d9ef>null</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>isActive</span>: <span style=color:#66d9ef>boolean</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>lastSyncAt</span>: <span style=color:#66d9ef>Date</span> <span style=color:#f92672>|</span> <span style=color:#66d9ef>null</span>; <span style=color:#75715e>// Last Git operation
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#a6e22e>createdAt</span>: <span style=color:#66d9ef>Date</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>updatedAt</span>: <span style=color:#66d9ef>Date</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>sessions</span>: <span style=color:#66d9ef>Session</span>[];     <span style=color:#75715e>// Related sessions
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>}
</span></span></code></pre></div><p><strong>Usage Examples:</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-typescript data-lang=typescript><span style=display:flex><span><span style=color:#75715e>// Create new workspace
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>workspace</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>prisma</span>.<span style=color:#a6e22e>workspace</span>.<span style=color:#a6e22e>create</span>({
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>data</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>name</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;my-react-app&#39;</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>githubRepo</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;octocat/my-react-app&#39;</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>githubUrl</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;https://github.com/octocat/my-react-app&#39;</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>githubId</span>: <span style=color:#66d9ef>123456</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>localPath</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;/app/workspaces/my-react-app&#39;</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>branch</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;main&#39;</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>description</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;React application workspace&#39;</span>
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>});
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Get workspace with sessions
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>workspaceWithSessions</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>prisma</span>.<span style=color:#a6e22e>workspace</span>.<span style=color:#a6e22e>findUnique</span>({
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>where</span><span style=color:#f92672>:</span> { <span style=color:#a6e22e>id</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;workspace_id&#39;</span> },
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>include</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>sessions</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>where</span><span style=color:#f92672>:</span> { <span style=color:#a6e22e>status</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;active&#39;</span> }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>});
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Update last sync time
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>await</span> <span style=color:#a6e22e>prisma</span>.<span style=color:#a6e22e>workspace</span>.<span style=color:#a6e22e>update</span>({
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>where</span><span style=color:#f92672>:</span> { <span style=color:#a6e22e>id</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;workspace_id&#39;</span> },
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>data</span><span style=color:#f92672>:</span> { <span style=color:#a6e22e>lastSyncAt</span>: <span style=color:#66d9ef>new</span> Date() }
</span></span><span style=display:flex><span>});
</span></span></code></pre></div><h3 id=session-model>Session Model</h3><p>Terminal session tracking:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-typescript data-lang=typescript><span style=display:flex><span><span style=color:#66d9ef>interface</span> <span style=color:#a6e22e>Session</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>id</span>: <span style=color:#66d9ef>string</span>;                    <span style=color:#75715e>// CUID identifier
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#a6e22e>shellPid</span>: <span style=color:#66d9ef>number</span> <span style=color:#f92672>|</span> <span style=color:#66d9ef>null</span>;       <span style=color:#75715e>// Process ID
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#a6e22e>socketId</span>: <span style=color:#66d9ef>string</span> <span style=color:#f92672>|</span> <span style=color:#66d9ef>null</span>;       <span style=color:#75715e>// Socket.IO connection
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#a6e22e>shell</span>: <span style=color:#66d9ef>string</span>;                 <span style=color:#75715e>// Shell type
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#a6e22e>status</span>: <span style=color:#66d9ef>string</span>;                <span style=color:#75715e>// Session status
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#a6e22e>workingDirectory</span>: <span style=color:#66d9ef>string</span> <span style=color:#f92672>|</span> <span style=color:#66d9ef>null</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>environment</span>: <span style=color:#66d9ef>string</span> <span style=color:#f92672>|</span> <span style=color:#66d9ef>null</span>;    <span style=color:#75715e>// JSON env vars
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#a6e22e>lastActivityAt</span>: <span style=color:#66d9ef>Date</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>createdAt</span>: <span style=color:#66d9ef>Date</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>endedAt</span>: <span style=color:#66d9ef>Date</span> <span style=color:#f92672>|</span> <span style=color:#66d9ef>null</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>exitCode</span>: <span style=color:#66d9ef>number</span> <span style=color:#f92672>|</span> <span style=color:#66d9ef>null</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>workspaceId</span>: <span style=color:#66d9ef>string</span> <span style=color:#f92672>|</span> <span style=color:#66d9ef>null</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>workspace</span>: <span style=color:#66d9ef>Workspace</span> <span style=color:#f92672>|</span> <span style=color:#66d9ef>null</span>;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p><strong>Usage Examples:</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-typescript data-lang=typescript><span style=display:flex><span><span style=color:#75715e>// Create new session
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>session</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>prisma</span>.<span style=color:#a6e22e>session</span>.<span style=color:#a6e22e>create</span>({
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>data</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>shell</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;bash&#39;</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>socketId</span>: <span style=color:#66d9ef>socket.id</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>workspaceId</span>: <span style=color:#66d9ef>workspace.id</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>workingDirectory</span>: <span style=color:#66d9ef>workspace.localPath</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>environment</span>: <span style=color:#66d9ef>JSON.stringify</span>(<span style=color:#a6e22e>process</span>.<span style=color:#a6e22e>env</span>)
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>});
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Update session activity
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>await</span> <span style=color:#a6e22e>prisma</span>.<span style=color:#a6e22e>session</span>.<span style=color:#a6e22e>update</span>({
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>where</span><span style=color:#f92672>:</span> { <span style=color:#a6e22e>id</span>: <span style=color:#66d9ef>session.id</span> },
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>data</span><span style=color:#f92672>:</span> { <span style=color:#a6e22e>lastActivityAt</span>: <span style=color:#66d9ef>new</span> Date() }
</span></span><span style=display:flex><span>});
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Terminate session
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>await</span> <span style=color:#a6e22e>prisma</span>.<span style=color:#a6e22e>session</span>.<span style=color:#a6e22e>update</span>({
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>where</span><span style=color:#f92672>:</span> { <span style=color:#a6e22e>id</span>: <span style=color:#66d9ef>session.id</span> },
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>data</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>status</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;terminated&#39;</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>endedAt</span>: <span style=color:#66d9ef>new</span> Date(),
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>exitCode</span>: <span style=color:#66d9ef>0</span>
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>});
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Clean up old sessions
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>await</span> <span style=color:#a6e22e>prisma</span>.<span style=color:#a6e22e>session</span>.<span style=color:#a6e22e>deleteMany</span>({
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>where</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>status</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;terminated&#39;</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>endedAt</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>lt</span>: <span style=color:#66d9ef>new</span> Date(Date.<span style=color:#a6e22e>now</span>() <span style=color:#f92672>-</span> <span style=color:#ae81ff>24</span> <span style=color:#f92672>*</span> <span style=color:#ae81ff>60</span> <span style=color:#f92672>*</span> <span style=color:#ae81ff>60</span> <span style=color:#f92672>*</span> <span style=color:#ae81ff>1000</span>) <span style=color:#75715e>// 24 hours ago
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>});
</span></span></code></pre></div><h2 id=database-operations>Database Operations</h2><h3 id=prisma-client-setup>Prisma Client Setup</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-typescript data-lang=typescript><span style=display:flex><span><span style=color:#75715e>// prisma/client.ts
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>import</span> { <span style=color:#a6e22e>PrismaClient</span> } <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#39;@prisma/client&#39;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>globalForPrisma</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>globalThis</span> <span style=color:#66d9ef>as</span> <span style=color:#66d9ef>unknown</span> <span style=color:#66d9ef>as</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>prisma</span>: <span style=color:#66d9ef>PrismaClient</span> <span style=color:#f92672>|</span> <span style=color:#66d9ef>undefined</span>;
</span></span><span style=display:flex><span>};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>export</span> <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>prisma</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>globalForPrisma</span>.<span style=color:#a6e22e>prisma</span> <span style=color:#f92672>??</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>PrismaClient</span>({
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>log</span>: <span style=color:#66d9ef>process.env.NODE_ENV</span> <span style=color:#f92672>===</span> <span style=color:#e6db74>&#39;development&#39;</span> <span style=color:#f92672>?</span> [<span style=color:#e6db74>&#39;query&#39;</span>, <span style=color:#e6db74>&#39;error&#39;</span>, <span style=color:#e6db74>&#39;warn&#39;</span>] <span style=color:#f92672>:</span> [<span style=color:#e6db74>&#39;error&#39;</span>],
</span></span><span style=display:flex><span>});
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>process</span>.<span style=color:#a6e22e>env</span>.<span style=color:#a6e22e>NODE_ENV</span> <span style=color:#f92672>!==</span> <span style=color:#e6db74>&#39;production&#39;</span>) {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>globalForPrisma</span>.<span style=color:#a6e22e>prisma</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>prisma</span>;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Graceful shutdown
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>process</span>.<span style=color:#a6e22e>on</span>(<span style=color:#e6db74>&#39;beforeExit&#39;</span>, <span style=color:#66d9ef>async</span> () <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>prisma</span>.<span style=color:#a6e22e>$disconnect</span>();
</span></span><span style=display:flex><span>});
</span></span></code></pre></div><h3 id=common-query-patterns>Common Query Patterns</h3><h4 id=single-tenant-settings-management>Single-Tenant Settings Management</h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-typescript data-lang=typescript><span style=display:flex><span><span style=color:#75715e>// Settings service
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>export</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>SettingsService</span> {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>readonly</span> <span style=color:#a6e22e>SETTINGS_ID</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;singleton&#39;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>async</span> <span style=color:#a6e22e>getSettings() {</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>prisma</span>.<span style=color:#a6e22e>settings</span>.<span style=color:#a6e22e>findUnique</span>({
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>where</span><span style=color:#f92672>:</span> { <span style=color:#a6e22e>id</span>: <span style=color:#66d9ef>this.SETTINGS_ID</span> }
</span></span><span style=display:flex><span>    });
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>async</span> <span style=color:#a6e22e>updateSettings</span>(<span style=color:#a6e22e>data</span>: <span style=color:#66d9ef>Partial</span>&lt;<span style=color:#f92672>Settings</span>&gt;) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>prisma</span>.<span style=color:#a6e22e>settings</span>.<span style=color:#a6e22e>upsert</span>({
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>where</span><span style=color:#f92672>:</span> { <span style=color:#a6e22e>id</span>: <span style=color:#66d9ef>this.SETTINGS_ID</span> },
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>update</span>: <span style=color:#66d9ef>data</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>create</span><span style=color:#f92672>:</span> { <span style=color:#a6e22e>id</span>: <span style=color:#66d9ef>this.SETTINGS_ID</span>, ...<span style=color:#a6e22e>data</span> }
</span></span><span style=display:flex><span>    });
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>async</span> <span style=color:#a6e22e>updateTheme</span>(<span style=color:#a6e22e>theme</span>: <span style=color:#66d9ef>string</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>updateSettings</span>({ <span style=color:#a6e22e>theme</span> });
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>async</span> <span style=color:#a6e22e>getGitHubToken() {</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>settings</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>getSettings</span>();
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>settings</span><span style=color:#f92672>?</span>.<span style=color:#a6e22e>githubToken</span>) {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> Error(<span style=color:#e6db74>&#39;GitHub token not found&#39;</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Decrypt token
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>decrypt</span>({
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>encryptedData</span>: <span style=color:#66d9ef>settings.githubToken</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>iv</span>: <span style=color:#66d9ef>settings.githubTokenIv</span><span style=color:#f92672>!</span>
</span></span><span style=display:flex><span>    });
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h4 id=workspace-management>Workspace Management</h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-typescript data-lang=typescript><span style=display:flex><span><span style=color:#66d9ef>export</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>WorkspaceService</span> {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>async</span> <span style=color:#a6e22e>createWorkspace</span>(<span style=color:#a6e22e>data</span>: <span style=color:#66d9ef>CreateWorkspaceData</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>prisma</span>.<span style=color:#a6e22e>workspace</span>.<span style=color:#a6e22e>create</span>({
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>data</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>        ...<span style=color:#a6e22e>data</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>localPath</span>: <span style=color:#66d9ef>path.join</span>(<span style=color:#a6e22e>process</span>.<span style=color:#a6e22e>env</span>.<span style=color:#a6e22e>WORKSPACE_ROOT</span> <span style=color:#f92672>||</span> <span style=color:#e6db74>&#39;./workspaces&#39;</span>, <span style=color:#a6e22e>data</span>.<span style=color:#a6e22e>name</span>)
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    });
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>async</span> <span style=color:#a6e22e>getActiveWorkspaces() {</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>prisma</span>.<span style=color:#a6e22e>workspace</span>.<span style=color:#a6e22e>findMany</span>({
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>where</span><span style=color:#f92672>:</span> { <span style=color:#a6e22e>isActive</span>: <span style=color:#66d9ef>true</span> },
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>include</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>sessions</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>where</span><span style=color:#f92672>:</span> { <span style=color:#a6e22e>status</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;active&#39;</span> }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>      },
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>orderBy</span><span style=color:#f92672>:</span> { <span style=color:#a6e22e>updatedAt</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;desc&#39;</span> }
</span></span><span style=display:flex><span>    });
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>async</span> <span style=color:#a6e22e>syncWorkspace</span>(<span style=color:#a6e22e>workspaceId</span>: <span style=color:#66d9ef>string</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>prisma</span>.<span style=color:#a6e22e>workspace</span>.<span style=color:#a6e22e>update</span>({
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>where</span><span style=color:#f92672>:</span> { <span style=color:#a6e22e>id</span>: <span style=color:#66d9ef>workspaceId</span> },
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>data</span><span style=color:#f92672>:</span> { <span style=color:#a6e22e>lastSyncAt</span>: <span style=color:#66d9ef>new</span> Date() }
</span></span><span style=display:flex><span>    });
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>async</span> <span style=color:#a6e22e>deleteWorkspace</span>(<span style=color:#a6e22e>workspaceId</span>: <span style=color:#66d9ef>string</span>) {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Cascade delete will handle related sessions
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>prisma</span>.<span style=color:#a6e22e>workspace</span>.<span style=color:#66d9ef>delete</span>({
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>where</span><span style=color:#f92672>:</span> { <span style=color:#a6e22e>id</span>: <span style=color:#66d9ef>workspaceId</span> }
</span></span><span style=display:flex><span>    });
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h4 id=session-management>Session Management</h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-typescript data-lang=typescript><span style=display:flex><span><span style=color:#66d9ef>export</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>SessionService</span> {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>async</span> <span style=color:#a6e22e>createSession</span>(<span style=color:#a6e22e>workspaceId</span>: <span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>socketId</span>: <span style=color:#66d9ef>string</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>prisma</span>.<span style=color:#a6e22e>session</span>.<span style=color:#a6e22e>create</span>({
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>data</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>workspaceId</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>socketId</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>shell</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;bash&#39;</span>
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    });
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>async</span> <span style=color:#a6e22e>getActiveSessions() {</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>prisma</span>.<span style=color:#a6e22e>session</span>.<span style=color:#a6e22e>findMany</span>({
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>where</span><span style=color:#f92672>:</span> { <span style=color:#a6e22e>status</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;active&#39;</span> },
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>include</span><span style=color:#f92672>:</span> { <span style=color:#a6e22e>workspace</span>: <span style=color:#66d9ef>true</span> }
</span></span><span style=display:flex><span>    });
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>async</span> <span style=color:#a6e22e>terminateSession</span>(<span style=color:#a6e22e>sessionId</span>: <span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>exitCode?</span>: <span style=color:#66d9ef>number</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>prisma</span>.<span style=color:#a6e22e>session</span>.<span style=color:#a6e22e>update</span>({
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>where</span><span style=color:#f92672>:</span> { <span style=color:#a6e22e>id</span>: <span style=color:#66d9ef>sessionId</span> },
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>data</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>status</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;terminated&#39;</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>endedAt</span>: <span style=color:#66d9ef>new</span> Date(),
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>exitCode</span>
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    });
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>async</span> <span style=color:#a6e22e>cleanupOldSessions</span>(<span style=color:#a6e22e>olderThanHours</span>: <span style=color:#66d9ef>number</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>24</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>cutoff</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> Date(Date.<span style=color:#a6e22e>now</span>() <span style=color:#f92672>-</span> <span style=color:#a6e22e>olderThanHours</span> <span style=color:#f92672>*</span> <span style=color:#ae81ff>60</span> <span style=color:#f92672>*</span> <span style=color:#ae81ff>60</span> <span style=color:#f92672>*</span> <span style=color:#ae81ff>1000</span>);
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>prisma</span>.<span style=color:#a6e22e>session</span>.<span style=color:#a6e22e>deleteMany</span>({
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>where</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>OR</span><span style=color:#f92672>:</span> [
</span></span><span style=display:flex><span>          { <span style=color:#a6e22e>status</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;terminated&#39;</span>, <span style=color:#a6e22e>endedAt</span><span style=color:#f92672>:</span> { <span style=color:#a6e22e>lt</span>: <span style=color:#66d9ef>cutoff</span> } },
</span></span><span style=display:flex><span>          { <span style=color:#a6e22e>status</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;active&#39;</span>, <span style=color:#a6e22e>lastActivityAt</span><span style=color:#f92672>:</span> { <span style=color:#a6e22e>lt</span>: <span style=color:#66d9ef>cutoff</span> } }
</span></span><span style=display:flex><span>        ]
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    });
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=database-migrations>Database Migrations</h2><h3 id=migration-system>Migration System</h3><p>Prisma Migrate handles schema changes:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># Generate migration</span>
</span></span><span style=display:flex><span>npx prisma migrate dev --name add_github_id_to_workspace
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Apply migrations to production</span>
</span></span><span style=display:flex><span>npx prisma migrate deploy
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Reset database (development only)</span>
</span></span><span style=display:flex><span>npx prisma migrate reset
</span></span></code></pre></div><h3 id=migration-history>Migration History</h3><p>Track all schema changes:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># View migration status</span>
</span></span><span style=display:flex><span>npx prisma migrate status
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># View migration history</span>
</span></span><span style=display:flex><span>ls prisma/migrations/
</span></span></code></pre></div><h3 id=example-migration>Example Migration</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#75715e>-- CreateTable
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>TABLE</span> <span style=color:#e6db74>&#34;workspaces&#34;</span> (
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;id&#34;</span> TEXT <span style=color:#66d9ef>NOT</span> <span style=color:#66d9ef>NULL</span> <span style=color:#66d9ef>PRIMARY</span> <span style=color:#66d9ef>KEY</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;name&#34;</span> TEXT <span style=color:#66d9ef>NOT</span> <span style=color:#66d9ef>NULL</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;githubRepo&#34;</span> TEXT <span style=color:#66d9ef>NOT</span> <span style=color:#66d9ef>NULL</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;githubUrl&#34;</span> TEXT <span style=color:#66d9ef>NOT</span> <span style=color:#66d9ef>NULL</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;githubId&#34;</span> INTEGER,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;localPath&#34;</span> TEXT <span style=color:#66d9ef>NOT</span> <span style=color:#66d9ef>NULL</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;branch&#34;</span> TEXT <span style=color:#66d9ef>NOT</span> <span style=color:#66d9ef>NULL</span> <span style=color:#66d9ef>DEFAULT</span> <span style=color:#e6db74>&#39;main&#39;</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;description&#34;</span> TEXT,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;isActive&#34;</span> BOOLEAN <span style=color:#66d9ef>NOT</span> <span style=color:#66d9ef>NULL</span> <span style=color:#66d9ef>DEFAULT</span> <span style=color:#66d9ef>true</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;lastSyncAt&#34;</span> DATETIME,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;createdAt&#34;</span> DATETIME <span style=color:#66d9ef>NOT</span> <span style=color:#66d9ef>NULL</span> <span style=color:#66d9ef>DEFAULT</span> <span style=color:#66d9ef>CURRENT_TIMESTAMP</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;updatedAt&#34;</span> DATETIME <span style=color:#66d9ef>NOT</span> <span style=color:#66d9ef>NULL</span>
</span></span><span style=display:flex><span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>-- CreateIndex
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>UNIQUE</span> <span style=color:#66d9ef>INDEX</span> <span style=color:#e6db74>&#34;workspaces_name_key&#34;</span> <span style=color:#66d9ef>ON</span> <span style=color:#e6db74>&#34;workspaces&#34;</span>(<span style=color:#e6db74>&#34;name&#34;</span>);
</span></span><span style=display:flex><span><span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>UNIQUE</span> <span style=color:#66d9ef>INDEX</span> <span style=color:#e6db74>&#34;workspaces_githubRepo_key&#34;</span> <span style=color:#66d9ef>ON</span> <span style=color:#e6db74>&#34;workspaces&#34;</span>(<span style=color:#e6db74>&#34;githubRepo&#34;</span>);
</span></span></code></pre></div><h2 id=performance-optimization>Performance Optimization</h2><h3 id=indexing-strategy>Indexing Strategy</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#75715e>-- Automatic indexes on unique fields
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>UNIQUE</span> <span style=color:#66d9ef>INDEX</span> <span style=color:#e6db74>&#34;workspaces_name_key&#34;</span> <span style=color:#66d9ef>ON</span> <span style=color:#e6db74>&#34;workspaces&#34;</span>(<span style=color:#e6db74>&#34;name&#34;</span>);
</span></span><span style=display:flex><span><span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>UNIQUE</span> <span style=color:#66d9ef>INDEX</span> <span style=color:#e6db74>&#34;workspaces_githubRepo_key&#34;</span> <span style=color:#66d9ef>ON</span> <span style=color:#e6db74>&#34;workspaces&#34;</span>(<span style=color:#e6db74>&#34;githubRepo&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>-- Custom indexes for common queries
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>INDEX</span> <span style=color:#e6db74>&#34;sessions_workspace_id_status_idx&#34;</span> <span style=color:#66d9ef>ON</span> <span style=color:#e6db74>&#34;sessions&#34;</span>(<span style=color:#e6db74>&#34;workspaceId&#34;</span>, <span style=color:#e6db74>&#34;status&#34;</span>);
</span></span><span style=display:flex><span><span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>INDEX</span> <span style=color:#e6db74>&#34;sessions_last_activity_idx&#34;</span> <span style=color:#66d9ef>ON</span> <span style=color:#e6db74>&#34;sessions&#34;</span>(<span style=color:#e6db74>&#34;lastActivityAt&#34;</span>);
</span></span><span style=display:flex><span><span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>INDEX</span> <span style=color:#e6db74>&#34;system_metrics_metric_created_idx&#34;</span> <span style=color:#66d9ef>ON</span> <span style=color:#e6db74>&#34;system_metrics&#34;</span>(<span style=color:#e6db74>&#34;metric&#34;</span>, <span style=color:#e6db74>&#34;createdAt&#34;</span>);
</span></span></code></pre></div><h3 id=query-optimization>Query Optimization</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-typescript data-lang=typescript><span style=display:flex><span><span style=color:#75715e>// Efficient workspace queries
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>workspacesWithActiveSessions</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>prisma</span>.<span style=color:#a6e22e>workspace</span>.<span style=color:#a6e22e>findMany</span>({
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>where</span><span style=color:#f92672>:</span> { <span style=color:#a6e22e>isActive</span>: <span style=color:#66d9ef>true</span> },
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>select</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>id</span>: <span style=color:#66d9ef>true</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>name</span>: <span style=color:#66d9ef>true</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>githubRepo</span>: <span style=color:#66d9ef>true</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>lastSyncAt</span>: <span style=color:#66d9ef>true</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>_count</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>select</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>sessions</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>where</span><span style=color:#f92672>:</span> { <span style=color:#a6e22e>status</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;active&#39;</span> }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>});
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Pagination for large datasets
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>getWorkspacesPaginated</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>async</span> (<span style=color:#a6e22e>page</span>: <span style=color:#66d9ef>number</span>, <span style=color:#a6e22e>limit</span>: <span style=color:#66d9ef>number</span>) <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>skip</span> <span style=color:#f92672>=</span> (<span style=color:#a6e22e>page</span> <span style=color:#f92672>-</span> <span style=color:#ae81ff>1</span>) <span style=color:#f92672>*</span> <span style=color:#a6e22e>limit</span>;
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> [<span style=color:#a6e22e>workspaces</span>, <span style=color:#a6e22e>total</span>] <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>Promise</span>.<span style=color:#a6e22e>all</span>([
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>prisma</span>.<span style=color:#a6e22e>workspace</span>.<span style=color:#a6e22e>findMany</span>({
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>skip</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>take</span>: <span style=color:#66d9ef>limit</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>orderBy</span><span style=color:#f92672>:</span> { <span style=color:#a6e22e>updatedAt</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;desc&#39;</span> },
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>include</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>sessions</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>where</span><span style=color:#f92672>:</span> { <span style=color:#a6e22e>status</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;active&#39;</span> },
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>take</span>: <span style=color:#66d9ef>1</span>
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    }),
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>prisma</span>.<span style=color:#a6e22e>workspace</span>.<span style=color:#a6e22e>count</span>({ <span style=color:#a6e22e>where</span><span style=color:#f92672>:</span> { <span style=color:#a6e22e>isActive</span>: <span style=color:#66d9ef>true</span> } })
</span></span><span style=display:flex><span>  ]);
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> { <span style=color:#a6e22e>workspaces</span>, <span style=color:#a6e22e>total</span>, <span style=color:#a6e22e>pages</span>: <span style=color:#66d9ef>Math.ceil</span>(<span style=color:#a6e22e>total</span> <span style=color:#f92672>/</span> <span style=color:#a6e22e>limit</span>) };
</span></span><span style=display:flex><span>};
</span></span></code></pre></div><h2 id=data-integrity-and-validation>Data Integrity and Validation</h2><h3 id=schema-constraints>Schema Constraints</h3><pre tabindex=0><code class=language-prisma data-lang=prisma>model Workspace {
  // Unique constraints
  name        String @unique
  githubRepo  String @unique
  
  // Required fields
  localPath   String
  githubUrl   String
  
  // Default values
  isActive    Boolean @default(true)
  branch      String  @default(&#34;main&#34;)
  
  // Timestamps
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}
</code></pre><h3 id=application-level-validation>Application-Level Validation</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-typescript data-lang=typescript><span style=display:flex><span><span style=color:#66d9ef>import</span> { <span style=color:#a6e22e>z</span> } <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#39;zod&#39;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Validation schemas
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>export</span> <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>CreateWorkspaceSchema</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>z</span>.<span style=color:#66d9ef>object</span>({
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>name</span>: <span style=color:#66d9ef>z.string</span>().<span style=color:#a6e22e>min</span>(<span style=color:#ae81ff>1</span>).<span style=color:#a6e22e>max</span>(<span style=color:#ae81ff>50</span>).<span style=color:#a6e22e>regex</span>(<span style=color:#e6db74>/^[a-zA-Z0-9-_]+$/</span>),
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>githubRepo</span>: <span style=color:#66d9ef>z.string</span>().<span style=color:#a6e22e>regex</span>(<span style=color:#e6db74>/^[a-zA-Z0-9-_.]+\/[a-zA-Z0-9-_.]+$/</span>),
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>githubUrl</span>: <span style=color:#66d9ef>z.string</span>().<span style=color:#a6e22e>url</span>(),
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>description</span>: <span style=color:#66d9ef>z.string</span>().<span style=color:#a6e22e>max</span>(<span style=color:#ae81ff>200</span>).<span style=color:#a6e22e>optional</span>(),
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>branch</span>: <span style=color:#66d9ef>z.string</span>().<span style=color:#a6e22e>min</span>(<span style=color:#ae81ff>1</span>).<span style=color:#66d9ef>default</span>(<span style=color:#e6db74>&#39;main&#39;</span>)
</span></span><span style=display:flex><span>});
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>export</span> <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>UpdateSessionSchema</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>z</span>.<span style=color:#66d9ef>object</span>({
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>status</span>: <span style=color:#66d9ef>z.enum</span>([<span style=color:#e6db74>&#39;active&#39;</span>, <span style=color:#e6db74>&#39;paused&#39;</span>, <span style=color:#e6db74>&#39;terminated&#39;</span>]),
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>workingDirectory</span>: <span style=color:#66d9ef>z.string</span>().<span style=color:#a6e22e>optional</span>(),
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>lastActivityAt</span>: <span style=color:#66d9ef>z.date</span>().<span style=color:#66d9ef>default</span>(() <span style=color:#f92672>=&gt;</span> <span style=color:#66d9ef>new</span> Date())
</span></span><span style=display:flex><span>});
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Usage in API endpoints
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>export</span> <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>createWorkspace</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>async</span> (<span style=color:#a6e22e>req</span>: <span style=color:#66d9ef>Request</span>, <span style=color:#a6e22e>res</span>: <span style=color:#66d9ef>Response</span>) <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>validatedData</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>CreateWorkspaceSchema</span>.<span style=color:#a6e22e>parse</span>(<span style=color:#a6e22e>req</span>.<span style=color:#a6e22e>body</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>workspace</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>WorkspaceService</span>.<span style=color:#a6e22e>createWorkspace</span>(<span style=color:#a6e22e>validatedData</span>);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>json</span>(<span style=color:#a6e22e>workspace</span>);
</span></span><span style=display:flex><span>  } <span style=color:#66d9ef>catch</span> (<span style=color:#a6e22e>error</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>error</span> <span style=color:#66d9ef>instanceof</span> <span style=color:#a6e22e>z</span>.<span style=color:#a6e22e>ZodError</span>) {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>status</span>(<span style=color:#ae81ff>400</span>).<span style=color:#a6e22e>json</span>({ <span style=color:#a6e22e>error</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;Validation failed&#39;</span>, <span style=color:#a6e22e>details</span>: <span style=color:#66d9ef>error.errors</span> });
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>status</span>(<span style=color:#ae81ff>500</span>).<span style=color:#a6e22e>json</span>({ <span style=color:#a6e22e>error</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;Internal server error&#39;</span> });
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>};
</span></span></code></pre></div><h2 id=backup-and-recovery>Backup and Recovery</h2><h3 id=database-backup-strategy>Database Backup Strategy</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e>#!/bin/bash
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#75715e># backup-database.sh</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>DATABASE_PATH<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;./data/database.db&#34;</span>
</span></span><span style=display:flex><span>BACKUP_DIR<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;./backups&#34;</span>
</span></span><span style=display:flex><span>TIMESTAMP<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>date +%Y%m%d_%H%M%S<span style=color:#66d9ef>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Create backup directory</span>
</span></span><span style=display:flex><span>mkdir -p $BACKUP_DIR
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Create backup with timestamp</span>
</span></span><span style=display:flex><span>cp $DATABASE_PATH $BACKUP_DIR/database_backup_$TIMESTAMP.db
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Compress backup</span>
</span></span><span style=display:flex><span>gzip $BACKUP_DIR/database_backup_$TIMESTAMP.db
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Keep only last 7 backups</span>
</span></span><span style=display:flex><span>ls -t $BACKUP_DIR/database_backup_*.db.gz | tail -n +8 | xargs -r rm
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>echo <span style=color:#e6db74>&#34;Database backup completed: database_backup_</span>$TIMESTAMP<span style=color:#e6db74>.db.gz&#34;</span>
</span></span></code></pre></div><h3 id=automated-backup-with-nodejs>Automated Backup with Node.js</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-typescript data-lang=typescript><span style=display:flex><span><span style=color:#66d9ef>import</span> <span style=color:#a6e22e>fs</span> <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#39;fs&#39;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> <span style=color:#a6e22e>path</span> <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#39;path&#39;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> { <span style=color:#a6e22e>execSync</span> } <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#39;child_process&#39;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> <span style=color:#a6e22e>cron</span> <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#39;node-cron&#39;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>DatabaseBackup</span> {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#a6e22e>backupDir</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>path</span>.<span style=color:#a6e22e>join</span>(<span style=color:#a6e22e>process</span>.<span style=color:#a6e22e>cwd</span>(), <span style=color:#e6db74>&#39;backups&#39;</span>);
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#a6e22e>dbPath</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>process</span>.<span style=color:#a6e22e>env</span>.<span style=color:#a6e22e>DATABASE_URL</span><span style=color:#f92672>?</span>.<span style=color:#a6e22e>replace</span>(<span style=color:#e6db74>&#39;file:&#39;</span>, <span style=color:#e6db74>&#39;&#39;</span>) <span style=color:#f92672>||</span> <span style=color:#e6db74>&#39;./data/database.db&#39;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>constructor</span>() {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Ensure backup directory exists
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>fs</span>.<span style=color:#a6e22e>existsSync</span>(<span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>backupDir</span>)) {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>fs</span>.<span style=color:#a6e22e>mkdirSync</span>(<span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>backupDir</span>, { <span style=color:#a6e22e>recursive</span>: <span style=color:#66d9ef>true</span> });
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>async</span> <span style=color:#a6e22e>createBackup</span>()<span style=color:#f92672>:</span> <span style=color:#a6e22e>Promise</span>&lt;<span style=color:#f92672>string</span>&gt; {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>timestamp</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> Date().<span style=color:#a6e22e>toISOString</span>().<span style=color:#a6e22e>replace</span>(<span style=color:#e6db74>/[:.]/g</span>, <span style=color:#e6db74>&#39;-&#39;</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>backupPath</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>path</span>.<span style=color:#a6e22e>join</span>(<span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>backupDir</span>, <span style=color:#e6db74>`database_backup_</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>timestamp</span><span style=color:#e6db74>}</span><span style=color:#e6db74>.db`</span>);
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Copy database file
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>fs</span>.<span style=color:#a6e22e>copyFileSync</span>(<span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>dbPath</span>, <span style=color:#a6e22e>backupPath</span>);
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Compress backup
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>execSync</span>(<span style=color:#e6db74>`gzip &#34;</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>backupPath</span><span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;`</span>);
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Cleanup old backups (keep last 30)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>cleanupOldBackups</span>();
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#e6db74>`</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>backupPath</span><span style=color:#e6db74>}</span><span style=color:#e6db74>.gz`</span>;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#a6e22e>cleanupOldBackups</span>()<span style=color:#f92672>:</span> <span style=color:#66d9ef>void</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>backupFiles</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>fs</span>.<span style=color:#a6e22e>readdirSync</span>(<span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>backupDir</span>)
</span></span><span style=display:flex><span>      .<span style=color:#a6e22e>filter</span>(<span style=color:#a6e22e>file</span> <span style=color:#f92672>=&gt;</span> <span style=color:#a6e22e>file</span>.<span style=color:#a6e22e>startsWith</span>(<span style=color:#e6db74>&#39;database_backup_&#39;</span>) <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>file</span>.<span style=color:#a6e22e>endsWith</span>(<span style=color:#e6db74>&#39;.gz&#39;</span>))
</span></span><span style=display:flex><span>      .<span style=color:#a6e22e>sort</span>()
</span></span><span style=display:flex><span>      .<span style=color:#a6e22e>reverse</span>();
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Remove all but the most recent 30 backups
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>backupFiles</span>.<span style=color:#a6e22e>slice</span>(<span style=color:#ae81ff>30</span>).<span style=color:#a6e22e>forEach</span>(<span style=color:#a6e22e>file</span> <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>fs</span>.<span style=color:#a6e22e>unlinkSync</span>(<span style=color:#a6e22e>path</span>.<span style=color:#a6e22e>join</span>(<span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>backupDir</span>, <span style=color:#a6e22e>file</span>));
</span></span><span style=display:flex><span>    });
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>startAutomatedBackups</span>()<span style=color:#f92672>:</span> <span style=color:#66d9ef>void</span> {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Daily backup at 2 AM
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>cron</span>.<span style=color:#a6e22e>schedule</span>(<span style=color:#e6db74>&#39;0 2 * * *&#39;</span>, <span style=color:#66d9ef>async</span> () <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>backupFile</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>createBackup</span>();
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#e6db74>`Automated backup created: </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>backupFile</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>);
</span></span><span style=display:flex><span>      } <span style=color:#66d9ef>catch</span> (<span style=color:#a6e22e>error</span>) {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>error</span>(<span style=color:#e6db74>&#39;Automated backup failed:&#39;</span>, <span style=color:#a6e22e>error</span>);
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    });
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Initialize automated backups
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>backup</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>DatabaseBackup</span>();
</span></span><span style=display:flex><span><span style=color:#a6e22e>backup</span>.<span style=color:#a6e22e>startAutomatedBackups</span>();
</span></span></code></pre></div><h2 id=monitoring-and-maintenance>Monitoring and Maintenance</h2><h3 id=database-health-checks>Database Health Checks</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-typescript data-lang=typescript><span style=display:flex><span><span style=color:#66d9ef>export</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>DatabaseHealth</span> {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>async</span> <span style=color:#a6e22e>checkHealth</span>()<span style=color:#f92672>:</span> <span style=color:#a6e22e>Promise</span>&lt;<span style=color:#f92672>HealthStatus</span>&gt; {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>      <span style=color:#75715e>// Test connection
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>prisma</span>.<span style=color:#a6e22e>$queryRaw</span><span style=color:#e6db74>`SELECT 1`</span>;
</span></span><span style=display:flex><span>      
</span></span><span style=display:flex><span>      <span style=color:#75715e>// Get database size
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>dbStats</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>getDatabaseStats</span>();
</span></span><span style=display:flex><span>      
</span></span><span style=display:flex><span>      <span style=color:#75715e>// Check for locked tables
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>lockedTables</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>checkForLocks</span>();
</span></span><span style=display:flex><span>      
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>status</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;healthy&#39;</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>size</span>: <span style=color:#66d9ef>dbStats.size</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>tables</span>: <span style=color:#66d9ef>dbStats.tableCount</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>connections</span>: <span style=color:#66d9ef>dbStats.connections</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>locks</span>: <span style=color:#66d9ef>lockedTables</span>
</span></span><span style=display:flex><span>      };
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>catch</span> (<span style=color:#a6e22e>error</span>) {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>status</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;unhealthy&#39;</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>error</span>: <span style=color:#66d9ef>error.message</span>
</span></span><span style=display:flex><span>      };
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>async</span> <span style=color:#a6e22e>getDatabaseStats() {</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>tables</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>prisma</span>.<span style=color:#a6e22e>$queryRaw</span>&lt;<span style=color:#f92672>Array</span><span style=color:#960050;background-color:#1e0010>&lt;</span>{ <span style=color:#a6e22e>name</span><span style=color:#960050;background-color:#1e0010>:</span> <span style=color:#a6e22e>string</span>, <span style=color:#a6e22e>count</span><span style=color:#960050;background-color:#1e0010>:</span> <span style=color:#a6e22e>number</span> }&gt;<span style=color:#f92672>&gt;</span><span style=color:#e6db74>`
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      SELECT name, COUNT(*) as count 
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      FROM sqlite_master 
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      WHERE type=&#39;table&#39;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    `</span>;
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>dbSize</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>prisma</span>.<span style=color:#a6e22e>$queryRaw</span><span style=color:#f92672>&lt;</span>[{ <span style=color:#a6e22e>size</span>: <span style=color:#66d9ef>number</span> }]<span style=color:#f92672>&gt;</span><span style=color:#e6db74>`
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      SELECT page_count * page_size as size 
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      FROM pragma_page_count(), pragma_page_size()
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    `</span>;
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>tableCount</span>: <span style=color:#66d9ef>tables.length</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>size</span>: <span style=color:#66d9ef>dbSize</span>[<span style=color:#ae81ff>0</span>]<span style=color:#f92672>?</span>.<span style=color:#a6e22e>size</span> <span style=color:#f92672>||</span> <span style=color:#ae81ff>0</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>connections</span>: <span style=color:#66d9ef>1</span> <span style=color:#75715e>// SQLite is single-connection
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    };
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=maintenance-tasks>Maintenance Tasks</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-typescript data-lang=typescript><span style=display:flex><span><span style=color:#66d9ef>export</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>DatabaseMaintenance</span> {
</span></span><span style=display:flex><span>  <span style=color:#75715e>// Clean up old data
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>async</span> <span style=color:#a6e22e>runMaintenance</span>()<span style=color:#f92672>:</span> <span style=color:#a6e22e>Promise</span>&lt;<span style=color:#f92672>void</span>&gt; {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>Promise</span>.<span style=color:#a6e22e>all</span>([
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>cleanupOldSessions</span>(),
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>cleanupOldLogs</span>(),
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>cleanupOldMetrics</span>(),
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>vacuum</span>()
</span></span><span style=display:flex><span>    ]);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>async</span> <span style=color:#a6e22e>cleanupOldSessions</span>()<span style=color:#f92672>:</span> <span style=color:#a6e22e>Promise</span>&lt;<span style=color:#f92672>void</span>&gt; {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>cutoff</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> Date(Date.<span style=color:#a6e22e>now</span>() <span style=color:#f92672>-</span> <span style=color:#ae81ff>7</span> <span style=color:#f92672>*</span> <span style=color:#ae81ff>24</span> <span style=color:#f92672>*</span> <span style=color:#ae81ff>60</span> <span style=color:#f92672>*</span> <span style=color:#ae81ff>60</span> <span style=color:#f92672>*</span> <span style=color:#ae81ff>1000</span>); <span style=color:#75715e>// 7 days
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>result</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>prisma</span>.<span style=color:#a6e22e>session</span>.<span style=color:#a6e22e>deleteMany</span>({
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>where</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>status</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;terminated&#39;</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>endedAt</span><span style=color:#f92672>:</span> { <span style=color:#a6e22e>lt</span>: <span style=color:#66d9ef>cutoff</span> }
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    });
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#e6db74>`Cleaned up </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>result</span>.<span style=color:#a6e22e>count</span><span style=color:#e6db74>}</span><span style=color:#e6db74> old sessions`</span>);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>async</span> <span style=color:#a6e22e>cleanupOldLogs</span>()<span style=color:#f92672>:</span> <span style=color:#a6e22e>Promise</span>&lt;<span style=color:#f92672>void</span>&gt; {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>cutoff</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> Date(Date.<span style=color:#a6e22e>now</span>() <span style=color:#f92672>-</span> <span style=color:#ae81ff>30</span> <span style=color:#f92672>*</span> <span style=color:#ae81ff>24</span> <span style=color:#f92672>*</span> <span style=color:#ae81ff>60</span> <span style=color:#f92672>*</span> <span style=color:#ae81ff>60</span> <span style=color:#f92672>*</span> <span style=color:#ae81ff>1000</span>); <span style=color:#75715e>// 30 days
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>result</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>prisma</span>.<span style=color:#a6e22e>authLog</span>.<span style=color:#a6e22e>deleteMany</span>({
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>where</span><span style=color:#f92672>:</span> { <span style=color:#a6e22e>createdAt</span><span style=color:#f92672>:</span> { <span style=color:#a6e22e>lt</span>: <span style=color:#66d9ef>cutoff</span> } }
</span></span><span style=display:flex><span>    });
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#e6db74>`Cleaned up </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>result</span>.<span style=color:#a6e22e>count</span><span style=color:#e6db74>}</span><span style=color:#e6db74> old auth logs`</span>);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>async</span> <span style=color:#a6e22e>vacuum</span>()<span style=color:#f92672>:</span> <span style=color:#a6e22e>Promise</span>&lt;<span style=color:#f92672>void</span>&gt; {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>prisma</span>.<span style=color:#a6e22e>$executeRaw</span><span style=color:#e6db74>`VACUUM`</span>;
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#e6db74>&#39;Database vacuum completed&#39;</span>);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Schedule daily maintenance
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>cron</span>.<span style=color:#a6e22e>schedule</span>(<span style=color:#e6db74>&#39;0 1 * * *&#39;</span>, <span style=color:#66d9ef>async</span> () <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#e6db74>&#39;Running database maintenance...&#39;</span>);
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>DatabaseMaintenance</span>.<span style=color:#a6e22e>runMaintenance</span>();
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#e6db74>&#39;Database maintenance completed&#39;</span>);
</span></span><span style=display:flex><span>});
</span></span></code></pre></div><h2 id=next-steps>Next Steps</h2><ul><li><strong><a href=/docs/database/models/>Data Models</a>:</strong> Detailed model relationships and usage</li><li><strong><a href=/docs/development/setup/>Development Setup</a>:</strong> Database development environment</li><li><strong><a href=/docs/deployment/production/>Production Setup</a>:</strong> Production database configuration</li></ul></div></article></div><div class=docs-nav><div><a href=https://act.drmhse.com/docs/database/models/ class="inline-flex flex-col items-start px-4 py-3 bg-gray-800/50 border border-gray-600 rounded-lg hover:bg-blue-600/5 hover:border-blue-400 transition-all"><span class="text-xs text-gray-400 uppercase tracking-wider mb-1">prev page</span>
<span class="text-gray-100 font-medium text-sm">Data Models</span></a></div><div><div class="text-gray-500 text-sm">next page</div></div></div></main><aside class=docs-toc><div class="sticky top-6"><h3 class="text-sm font-semibold text-gray-100 mb-4 text-center">table<br>of<br>content</h3><div id=table-of-contents class=space-y-1></div></div></aside></div><script>document.addEventListener("DOMContentLoaded",function(){const t=document.querySelectorAll(".nav-section-toggle");t.forEach(e=>{e.addEventListener("click",function(){const n=this.closest(".nav-section"),e=n.querySelector(".nav-section-content"),t=this.querySelector(".chevron");e.style.maxHeight==="0px"||e.style.maxHeight===""?(e.style.maxHeight=e.scrollHeight+"px",t.style.transform="rotate(90deg)"):(e.style.maxHeight="0px",t.style.transform="rotate(0deg)")})});const e=document.querySelector(".nav-link.active");if(e){const t=e.closest(".nav-section");if(t){const e=t.querySelector(".nav-section-content"),n=t.querySelector(".chevron");e.style.maxHeight=e.scrollHeight+"px",n.style.transform="rotate(90deg)"}}function n(){const t=document.querySelectorAll("article h2, article h3, article h4, article h5, article h6"),e=document.getElementById("table-of-contents");if(t.length===0||!e)return;t.forEach((t)=>{t.id||(t.id=t.textContent.toLowerCase().replace(/[^a-z0-9]/g,"-").replace(/-+/g,"-").replace(/^-|-$/g,""));const s=document.createElement("a");s.href="#"+t.id,s.textContent=t.textContent,s.className="block py-1.5 px-3 text-xs text-gray-400 hover:text-gray-100 hover:bg-blue-600/5 rounded transition-colors";const o=parseInt(t.tagName.charAt(1));o>2&&(s.style.paddingLeft=`${(o-2)*12+12}px`,s.style.borderLeft="1px solid rgb(75 85 99)"),e.appendChild(s)});const n=new IntersectionObserver(t=>{t.forEach(t=>{const s=t.target.id,n=e.querySelector(`a[href="#${s}"]`);n&&t.isIntersecting&&(e.querySelectorAll("a").forEach(e=>e.classList.remove("!text-blue-400","bg-blue-600/10","font-medium")),n.classList.add("!text-blue-400","bg-blue-600/10","font-medium"))})},{rootMargin:"-100px 0px -80% 0px"});t.forEach(e=>{n.observe(e)})}n(),document.addEventListener("click",function(e){if(e.target.matches('a[href^="#"]')){e.preventDefault();const t=document.querySelector(e.target.getAttribute("href"));t&&t.scrollIntoView({behavior:"smooth",block:"start"})}})})</script></main><script>feather.replace()</script><script src=/js/docs.js></script></body></html>