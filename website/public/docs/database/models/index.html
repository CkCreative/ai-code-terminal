<!DOCTYPE html>
<html lang="en-us">
<head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
    <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">


<title>Data Models | AI Code Terminal: The AI-Native Shell</title>
<meta name="description" content="Detailed data model relationships, business logic, and usage patterns">
<meta name="keywords" content="AI development, Claude Code, self-hosted terminal, development environment, AI coding, browser terminal, Docker deployment">
<meta name="author" content="AI Code Terminal">
<meta name="robots" content="index, follow">
<link rel="canonical" href="http://localhost:1313/docs/database/models/">


<meta property="og:type" content="article">
<meta property="og:title" content="Data Models | AI Code Terminal: The AI-Native Shell">
<meta property="og:description" content="Detailed data model relationships, business logic, and usage patterns">
<meta property="og:url" content="http://localhost:1313/docs/database/models/">
<meta property="og:site_name" content="AI Code Terminal: The AI-Native Shell">
<meta property="og:image" content="http://localhost:1313/images/claude_code_in_action.png">
<meta property="og:image:width" content="1200">
<meta property="og:image:height" content="630">
<meta property="og:image:alt" content="AI Code Terminal - Browser-based development environment with Claude integration">


<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:title" content="Data Models | AI Code Terminal: The AI-Native Shell">
<meta name="twitter:description" content="Detailed data model relationships, business logic, and usage patterns">
<meta name="twitter:image" content="http://localhost:1313/images/claude_code_in_action.png">
<meta name="twitter:image:alt" content="AI Code Terminal - Browser-based development environment with Claude integration">


<link rel="icon" type="image/svg+xml" href="/terminal-icon.svg">
<link rel="icon" type="image/png" href="/favicon.png" sizes="32x32">
<link rel="apple-touch-icon" href="/apple-touch-icon.png" sizes="180x180">


<meta name="theme-color" content="#010411">
<meta name="msapplication-TileColor" content="#010411">


<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@300;400;500&family=Space+Grotesk:wght@400;500;700&display=swap" rel="stylesheet">


<script src="https://unpkg.com/feather-icons"></script>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "SoftwareApplication",
  "name": "AI Code Terminal: The AI-Native Shell",
  "description": "A self-hosted development environment for the post-IDE era. Code from any device with a fast, lightweight, AI-native shell.",
  "url": "http:\/\/localhost:1313\/",
  "applicationCategory": "DeveloperApplication",
  "operatingSystem": "Linux, macOS, Windows",
  "offers": {
    "@type": "Offer",
    "price": "0",
    "priceCurrency": "USD"
  },
  "author": {
    "@type": "Organization",
    "name": "AI Code Terminal"
  }
}
</script>


<link rel="stylesheet" href="/css/shared.css">

    <link rel="stylesheet" href="/css/docs.css">

</head>
<body class="docs-site">
    
    
    <header>
    <div class="container">
        <nav>
            <a href="http://localhost:1313/" class="logo">
                <span class="prompt-char">&gt;</span> AI Code Terminal
            </a>
            <div class="nav-links">
                <a href="/docs/getting-started/introduction/" class="nav-link">
                    <i data-feather="book"></i>
                    <span>Documentation</span>
                </a>
                <a href="/getting-started/" class="nav-link">
                    <i data-feather="book-open"></i>
                    <span>Getting Started</span>
                </a>
                <a href="https://github.com/drmhse/ai-code-terminal" target="_blank" rel="noopener noreferrer" class="nav-link">
                    <i data-feather="github"></i>
                    <span>View on GitHub</span>
                </a>
            </div>
        </nav>
    </div>
</header>

    <main>
        

<div class="min-h-screen bg-[#010411] text-[#d4dff3]">
  
  
  <button id="mobile-sidebar-toggle" class="lg:hidden fixed top-4 left-4 z-50 p-3 bg-[#0a0c1a] border border-[rgba(67,79,138,0.2)] rounded-lg">
    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
    </svg>
  </button>

  
  <div id="mobile-overlay" class="lg:hidden fixed inset-0 bg-black bg-opacity-50 z-30 hidden"></div>

  <div class="flex pt-20"> 
    
    
    <aside id="docs-sidebar" class="fixed lg:relative w-80 bg-[rgba(1,4,17,0.95)] border-r border-[rgba(67,79,138,0.2)] h-screen lg:h-[calc(100vh-5rem)] overflow-y-auto backdrop-blur-xl z-40 -translate-x-full lg:translate-x-0 transition-transform duration-300">
      
      
      <div class="sticky top-0 bg-[rgba(1,4,17,0.9)] backdrop-blur-sm border-b border-[rgba(67,79,138,0.2)] p-6">
        <div class="flex items-center space-x-3 mb-6">
          <div class="w-8 h-8 bg-[#82aaff] rounded-lg flex items-center justify-center">
            <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
            </svg>
          </div>
          <h3 class="text-lg font-semibold text-[#d4dff3]">Documentation</h3>
        </div>
        
        
        <div class="relative">
          <svg class="absolute left-3 top-3.5 w-4 h-4 text-[#8b9cc2]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
          </svg>
          <input type="text" placeholder="Search docs..." class="w-full pl-10 pr-4 py-3 bg-[rgba(10,12,26,0.6)] border border-[rgba(67,79,138,0.2)] rounded-lg text-[#d4dff3] placeholder-[#8b9cc2] focus:outline-none focus:border-[#82aaff] focus:ring-1 focus:ring-[#82aaff] transition-colors">
        </div>
      </div>

      
      <nav class="p-4 space-y-2">
        
        
        <div class="nav-section">
          <button class="nav-section-toggle flex items-center justify-between w-full px-3 py-2 text-sm font-medium text-[#82aaff] hover:bg-[rgba(130,170,255,0.05)] rounded-lg transition-colors" data-section="getting-started">
            <span class="uppercase tracking-wider">Getting Started</span>
            <svg class="w-4 h-4 transform transition-transform chevron" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
            </svg>
          </button>
          <ul class="nav-section-content mt-1 space-y-1 max-h-0 overflow-hidden transition-all duration-300 ease-in-out">
            
            
            <li>
              <a href="http://localhost:1313/docs/getting-started/introduction/" class="nav-link block py-2 px-6 text-sm text-[#8b9cc2] hover:text-[#d4dff3] hover:bg-[rgba(130,170,255,0.05)] rounded-lg transition-colors ">
                Introduction
              </a>
            </li>
            
            <li>
              <a href="http://localhost:1313/docs/getting-started/quick-start/" class="nav-link block py-2 px-6 text-sm text-[#8b9cc2] hover:text-[#d4dff3] hover:bg-[rgba(130,170,255,0.05)] rounded-lg transition-colors ">
                Quick Start
              </a>
            </li>
            
            <li>
              <a href="http://localhost:1313/docs/getting-started/installation/" class="nav-link block py-2 px-6 text-sm text-[#8b9cc2] hover:text-[#d4dff3] hover:bg-[rgba(130,170,255,0.05)] rounded-lg transition-colors ">
                Installation
              </a>
            </li>
            
            <li>
              <a href="http://localhost:1313/docs/getting-started/github-oauth/" class="nav-link block py-2 px-6 text-sm text-[#8b9cc2] hover:text-[#d4dff3] hover:bg-[rgba(130,170,255,0.05)] rounded-lg transition-colors ">
                GitHub OAuth Setup
              </a>
            </li>
            
            <li>
              <a href="http://localhost:1313/docs/getting-started/configuration/" class="nav-link block py-2 px-6 text-sm text-[#8b9cc2] hover:text-[#d4dff3] hover:bg-[rgba(130,170,255,0.05)] rounded-lg transition-colors ">
                Configuration
              </a>
            </li>
            
            
          </ul>
        </div>

        
        <div class="nav-section">
          <button class="nav-section-toggle flex items-center justify-between w-full px-3 py-2 text-sm font-medium text-[#82aaff] hover:bg-[rgba(130,170,255,0.05)] rounded-lg transition-colors" data-section="core-features">
            <span class="uppercase tracking-wider">Core Features</span>
            <svg class="w-4 h-4 transform transition-transform chevron" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
            </svg>
          </button>
          <ul class="nav-section-content mt-1 space-y-1 max-h-0 overflow-hidden transition-all duration-300 ease-in-out">
            
            
            <li>
              <a href="http://localhost:1313/docs/core-features/terminal-access/" class="nav-link block py-2 px-6 text-sm text-[#8b9cc2] hover:text-[#d4dff3] hover:bg-[rgba(130,170,255,0.05)] rounded-lg transition-colors ">
                Terminal Access
              </a>
            </li>
            
            <li>
              <a href="http://localhost:1313/docs/core-features/workspace-management/" class="nav-link block py-2 px-6 text-sm text-[#8b9cc2] hover:text-[#d4dff3] hover:bg-[rgba(130,170,255,0.05)] rounded-lg transition-colors ">
                Workspace Management
              </a>
            </li>
            
            <li>
              <a href="http://localhost:1313/docs/core-features/github-integration/" class="nav-link block py-2 px-6 text-sm text-[#8b9cc2] hover:text-[#d4dff3] hover:bg-[rgba(130,170,255,0.05)] rounded-lg transition-colors ">
                GitHub Integration
              </a>
            </li>
            
            <li>
              <a href="http://localhost:1313/docs/core-features/claude-integration/" class="nav-link block py-2 px-6 text-sm text-[#8b9cc2] hover:text-[#d4dff3] hover:bg-[rgba(130,170,255,0.05)] rounded-lg transition-colors ">
                Claude Integration
              </a>
            </li>
            
            <li>
              <a href="http://localhost:1313/docs/core-features/real-time-features/" class="nav-link block py-2 px-6 text-sm text-[#8b9cc2] hover:text-[#d4dff3] hover:bg-[rgba(130,170,255,0.05)] rounded-lg transition-colors ">
                Real-time Features
              </a>
            </li>
            
            
          </ul>
        </div>

        
        <div class="nav-section">
          <button class="nav-section-toggle flex items-center justify-between w-full px-3 py-2 text-sm font-medium text-[#82aaff] hover:bg-[rgba(130,170,255,0.05)] rounded-lg transition-colors" data-section="authentication">
            <span class="uppercase tracking-wider">Authentication</span>
            <svg class="w-4 h-4 transform transition-transform chevron" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
            </svg>
          </button>
          <ul class="nav-section-content mt-1 space-y-1 max-h-0 overflow-hidden transition-all duration-300 ease-in-out">
            
            
            <li>
              <a href="http://localhost:1313/docs/authentication/auth-flow/" class="nav-link block py-2 px-6 text-sm text-[#8b9cc2] hover:text-[#d4dff3] hover:bg-[rgba(130,170,255,0.05)] rounded-lg transition-colors ">
                Authentication Flow
              </a>
            </li>
            
            <li>
              <a href="http://localhost:1313/docs/authentication/security-features/" class="nav-link block py-2 px-6 text-sm text-[#8b9cc2] hover:text-[#d4dff3] hover:bg-[rgba(130,170,255,0.05)] rounded-lg transition-colors ">
                Security Features
              </a>
            </li>
            
            <li>
              <a href="http://localhost:1313/docs/authentication/token-management/" class="nav-link block py-2 px-6 text-sm text-[#8b9cc2] hover:text-[#d4dff3] hover:bg-[rgba(130,170,255,0.05)] rounded-lg transition-colors ">
                Token Management
              </a>
            </li>
            
            
          </ul>
        </div>

        
        <div class="nav-section">
          <button class="nav-section-toggle flex items-center justify-between w-full px-3 py-2 text-sm font-medium text-[#82aaff] hover:bg-[rgba(130,170,255,0.05)] rounded-lg transition-colors" data-section="api">
            <span class="uppercase tracking-wider">API & WebSocket</span>
            <svg class="w-4 h-4 transform transition-transform chevron" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
            </svg>
          </button>
          <ul class="nav-section-content mt-1 space-y-1 max-h-0 overflow-hidden transition-all duration-300 ease-in-out">
            
            
            <li>
              <a href="http://localhost:1313/docs/api/endpoints/" class="nav-link block py-2 px-6 text-sm text-[#8b9cc2] hover:text-[#d4dff3] hover:bg-[rgba(130,170,255,0.05)] rounded-lg transition-colors ">
                API Endpoints
              </a>
            </li>
            
            <li>
              <a href="http://localhost:1313/docs/api/websocket/" class="nav-link block py-2 px-6 text-sm text-[#8b9cc2] hover:text-[#d4dff3] hover:bg-[rgba(130,170,255,0.05)] rounded-lg transition-colors ">
                WebSocket Events
              </a>
            </li>
            
            
          </ul>
        </div>

        
        <div class="nav-section">
          <button class="nav-section-toggle flex items-center justify-between w-full px-3 py-2 text-sm font-medium text-[#82aaff] hover:bg-[rgba(130,170,255,0.05)] rounded-lg transition-colors" data-section="database">
            <span class="uppercase tracking-wider">Database</span>
            <svg class="w-4 h-4 transform transition-transform chevron" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
            </svg>
          </button>
          <ul class="nav-section-content mt-1 space-y-1 max-h-0 overflow-hidden transition-all duration-300 ease-in-out">
            
            
            <li>
              <a href="http://localhost:1313/docs/database/schema/" class="nav-link block py-2 px-6 text-sm text-[#8b9cc2] hover:text-[#d4dff3] hover:bg-[rgba(130,170,255,0.05)] rounded-lg transition-colors ">
                Database Schema
              </a>
            </li>
            
            <li>
              <a href="http://localhost:1313/docs/database/models/" class="nav-link block py-2 px-6 text-sm text-[#8b9cc2] hover:text-[#d4dff3] hover:bg-[rgba(130,170,255,0.05)] rounded-lg transition-colors active bg-[rgba(130,170,255,0.1)] !text-[#82aaff] font-medium">
                Data Models
              </a>
            </li>
            
            
          </ul>
        </div>

        
        <div class="nav-section">
          <button class="nav-section-toggle flex items-center justify-between w-full px-3 py-2 text-sm font-medium text-[#82aaff] hover:bg-[rgba(130,170,255,0.05)] rounded-lg transition-colors" data-section="development">
            <span class="uppercase tracking-wider">Development</span>
            <svg class="w-4 h-4 transform transition-transform chevron" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
            </svg>
          </button>
          <ul class="nav-section-content mt-1 space-y-1 max-h-0 overflow-hidden transition-all duration-300 ease-in-out">
            
            
            <li>
              <a href="http://localhost:1313/docs/development/setup/" class="nav-link block py-2 px-6 text-sm text-[#8b9cc2] hover:text-[#d4dff3] hover:bg-[rgba(130,170,255,0.05)] rounded-lg transition-colors ">
                Development Setup
              </a>
            </li>
            
            <li>
              <a href="http://localhost:1313/docs/development/testing/" class="nav-link block py-2 px-6 text-sm text-[#8b9cc2] hover:text-[#d4dff3] hover:bg-[rgba(130,170,255,0.05)] rounded-lg transition-colors ">
                Testing
              </a>
            </li>
            
            
          </ul>
        </div>

        
        <div class="nav-section">
          <button class="nav-section-toggle flex items-center justify-between w-full px-3 py-2 text-sm font-medium text-[#82aaff] hover:bg-[rgba(130,170,255,0.05)] rounded-lg transition-colors" data-section="deployment">
            <span class="uppercase tracking-wider">Deployment</span>
            <svg class="w-4 h-4 transform transition-transform chevron" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
            </svg>
          </button>
          <ul class="nav-section-content mt-1 space-y-1 max-h-0 overflow-hidden transition-all duration-300 ease-in-out">
            
            
            <li>
              <a href="http://localhost:1313/docs/deployment/docker/" class="nav-link block py-2 px-6 text-sm text-[#8b9cc2] hover:text-[#d4dff3] hover:bg-[rgba(130,170,255,0.05)] rounded-lg transition-colors ">
                Docker Deployment
              </a>
            </li>
            
            
          </ul>
        </div>

      </nav>
    </aside>

    
    <main class="flex-1 lg:ml-80">
      
      
      <div class="sticky top-20 bg-[rgba(1,4,17,0.9)] backdrop-blur-sm border-b border-[rgba(67,79,138,0.2)] px-8 py-4 z-10">
        <nav class="flex items-center space-x-2 text-sm">
          <a href="/" class="text-[#8b9cc2] hover:text-[#d4dff3] transition-colors">Home</a>
          <svg class="w-4 h-4 text-[#8b9cc2]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
          </svg>
          <a href="/docs" class="text-[#8b9cc2] hover:text-[#d4dff3] transition-colors">Documentation</a>
          
          <svg class="w-4 h-4 text-[#8b9cc2]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
          </svg>
          <a href="http://localhost:1313/docs/database/" class="text-[#8b9cc2] hover:text-[#d4dff3] transition-colors">Database &amp; Storage</a>
          
          <svg class="w-4 h-4 text-[#8b9cc2]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
          </svg>
          <span class="text-[#82aaff] font-medium">Data Models</span>
        </nav>
      </div>

      <div class="flex">
        
        <article class="flex-1 px-8 py-12 max-w-4xl">
          
          
          <header class="mb-12">
            
            
            <h1 class="text-4xl lg:text-5xl font-bold text-[#d4dff3] mb-6 leading-tight">Data Models</h1>
            
            
            <p class="text-xl text-[#8b9cc2] leading-relaxed mb-8">Detailed data model relationships, business logic, and usage patterns</p>
            
            
            
            <div class="flex items-center space-x-6 text-sm text-[#8b9cc2]">
              
              
              <div class="flex items-center space-x-2">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
                <span>13 min read</span>
              </div>
              
            </div>
            
          </header>

          
          <div class="prose prose-invert prose-lg max-w-none">
            <h1 id="data-models">Data Models</h1>
<p>AI Code Terminal uses a carefully designed data model that supports single-tenant operation, workspace isolation, and real-time session management. This guide covers the business logic, relationships, and usage patterns for each model.</p>
<h2 id="model-relationships-overview">Model Relationships Overview</h2>
<pre tabindex="0"><code class="language-mermaid" data-lang="mermaid">erDiagram
    Settings ||--|| User : &#34;single-tenant&#34;
    Workspace ||--o{ Session : &#34;has-many&#34;
    Workspace ||--o{ AuthLog : &#34;references&#34;
    Session ||--o{ SystemMetric : &#34;monitors&#34;
    
    Settings {
        string id PK &#34;singleton&#34;
        string githubToken &#34;encrypted&#34;
        string githubRefreshToken &#34;encrypted&#34;
        datetime githubTokenExpiresAt
        string theme
        string preferences &#34;JSON&#34;
    }
    
    Workspace {
        string id PK &#34;cuid&#34;
        string name UK &#34;unique&#34;
        string githubRepo UK &#34;owner/repo&#34;
        string githubUrl
        int githubId
        string localPath
        string branch
        boolean isActive
        datetime lastSyncAt
    }
    
    Session {
        string id PK &#34;cuid&#34;
        string workspaceId FK
        int shellPid
        string socketId
        string shell
        string status
        string workingDirectory
        datetime lastActivityAt
    }
</code></pre><h2 id="settings-model-business-logic">Settings Model Business Logic</h2>
<h3 id="single-tenant-configuration">Single-Tenant Configuration</h3>
<p>The Settings model implements the singleton pattern for single-tenant configuration:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-typescript" data-lang="typescript"><span style="display:flex;"><span><span style="color:#66d9ef">export</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">SettingsModel</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">readonly</span> <span style="color:#a6e22e">SINGLETON_ID</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;singleton&#39;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// Ensure only one settings record exists
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">async</span> <span style="color:#a6e22e">getInstance</span>()<span style="color:#f92672">:</span> <span style="color:#a6e22e">Promise</span>&lt;<span style="color:#f92672">Settings</span> <span style="color:#960050;background-color:#1e0010">|</span> <span style="color:#a6e22e">null</span>&gt; {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">prisma</span>.<span style="color:#a6e22e">settings</span>.<span style="color:#a6e22e">findUnique</span>({
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">where</span><span style="color:#f92672">:</span> { <span style="color:#a6e22e">id</span>: <span style="color:#66d9ef">this.SINGLETON_ID</span> }
</span></span><span style="display:flex;"><span>    });
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// Create or update settings (upsert pattern)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">async</span> <span style="color:#a6e22e">upsert</span>(<span style="color:#a6e22e">data</span>: <span style="color:#66d9ef">Partial</span>&lt;<span style="color:#f92672">Omit</span>&lt;<span style="color:#f92672">Settings</span>, <span style="color:#e6db74">&#39;id&#39;</span> <span style="color:#960050;background-color:#1e0010">|</span> <span style="color:#e6db74">&#39;createdAt&#39;</span> <span style="color:#960050;background-color:#1e0010">|</span> <span style="color:#e6db74">&#39;updatedAt&#39;</span>&gt;&gt;) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">prisma</span>.<span style="color:#a6e22e">settings</span>.<span style="color:#a6e22e">upsert</span>({
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">where</span><span style="color:#f92672">:</span> { <span style="color:#a6e22e">id</span>: <span style="color:#66d9ef">this.SINGLETON_ID</span> },
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">update</span><span style="color:#f92672">:</span> {
</span></span><span style="display:flex;"><span>        ...<span style="color:#a6e22e">data</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">updatedAt</span>: <span style="color:#66d9ef">new</span> Date()
</span></span><span style="display:flex;"><span>      },
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">create</span><span style="color:#f92672">:</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">id</span>: <span style="color:#66d9ef">this.SINGLETON_ID</span>,
</span></span><span style="display:flex;"><span>        ...<span style="color:#a6e22e">data</span>
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>    });
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// Specialized methods for common operations
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">async</span> <span style="color:#a6e22e">updateTheme</span>(<span style="color:#a6e22e">theme</span>: <span style="color:#66d9ef">string</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">await</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">upsert</span>({ <span style="color:#a6e22e">theme</span> });
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">async</span> <span style="color:#a6e22e">updatePreferences</span>(<span style="color:#a6e22e">preferences</span>: <span style="color:#66d9ef">Record</span>&lt;<span style="color:#f92672">string</span>, <span style="color:#a6e22e">any</span>&gt;) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">await</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">upsert</span>({
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">preferences</span>: <span style="color:#66d9ef">JSON.stringify</span>(<span style="color:#a6e22e">preferences</span>)
</span></span><span style="display:flex;"><span>    });
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">async</span> <span style="color:#a6e22e">getPreferences</span>()<span style="color:#f92672">:</span> <span style="color:#a6e22e">Promise</span>&lt;<span style="color:#f92672">Record</span>&lt;<span style="color:#f92672">string</span>, <span style="color:#a6e22e">any</span>&gt;&gt; {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">settings</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">getInstance</span>();
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span><span style="color:#a6e22e">settings</span><span style="color:#f92672">?</span>.<span style="color:#a6e22e">preferences</span>) {
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">return</span> {};
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">try</span> {
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">JSON</span>.<span style="color:#a6e22e">parse</span>(<span style="color:#a6e22e">settings</span>.<span style="color:#a6e22e">preferences</span>);
</span></span><span style="display:flex;"><span>    } <span style="color:#66d9ef">catch</span> {
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">return</span> {};
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="github-token-management">GitHub Token Management</h3>
<p>Secure token storage with encryption:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-typescript" data-lang="typescript"><span style="display:flex;"><span><span style="color:#66d9ef">import</span> <span style="color:#a6e22e">crypto</span> <span style="color:#66d9ef">from</span> <span style="color:#e6db74">&#39;crypto&#39;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">export</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">GitHubTokenManager</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#a6e22e">algorithm</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;aes-256-cbc&#39;</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#a6e22e">secretKey</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">crypto</span>.<span style="color:#a6e22e">scryptSync</span>(<span style="color:#a6e22e">process</span>.<span style="color:#a6e22e">env</span>.<span style="color:#a6e22e">JWT_SECRET</span><span style="color:#f92672">!</span>, <span style="color:#e6db74">&#39;salt&#39;</span>, <span style="color:#ae81ff">32</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">static</span> <span style="color:#a6e22e">encrypt</span>(<span style="color:#a6e22e">text</span>: <span style="color:#66d9ef">string</span>)<span style="color:#f92672">:</span> { <span style="color:#a6e22e">encryptedData</span>: <span style="color:#66d9ef">string</span>; <span style="color:#a6e22e">iv</span>: <span style="color:#66d9ef">string</span> } {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">iv</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">crypto</span>.<span style="color:#a6e22e">randomBytes</span>(<span style="color:#ae81ff">16</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">cipher</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">crypto</span>.<span style="color:#a6e22e">createCipher</span>(<span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">algorithm</span>, <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">secretKey</span>);
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">encrypted</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">cipher</span>.<span style="color:#a6e22e">update</span>(<span style="color:#a6e22e">text</span>, <span style="color:#e6db74">&#39;utf8&#39;</span>, <span style="color:#e6db74">&#39;hex&#39;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">encrypted</span> <span style="color:#f92672">+=</span> <span style="color:#a6e22e">cipher</span>.<span style="color:#a6e22e">final</span>(<span style="color:#e6db74">&#39;hex&#39;</span>);
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> {
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">encryptedData</span>: <span style="color:#66d9ef">encrypted</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">iv</span>: <span style="color:#66d9ef">iv.toString</span>(<span style="color:#e6db74">&#39;hex&#39;</span>)
</span></span><span style="display:flex;"><span>    };
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">static</span> <span style="color:#a6e22e">decrypt</span>(<span style="color:#a6e22e">encryptedData</span>: <span style="color:#66d9ef">string</span>, <span style="color:#a6e22e">iv</span>: <span style="color:#66d9ef">string</span>)<span style="color:#f92672">:</span> <span style="color:#66d9ef">string</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">decipher</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">crypto</span>.<span style="color:#a6e22e">createDecipher</span>(<span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">algorithm</span>, <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">secretKey</span>);
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">decrypted</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">decipher</span>.<span style="color:#a6e22e">update</span>(<span style="color:#a6e22e">encryptedData</span>, <span style="color:#e6db74">&#39;hex&#39;</span>, <span style="color:#e6db74">&#39;utf8&#39;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">decrypted</span> <span style="color:#f92672">+=</span> <span style="color:#a6e22e">decipher</span>.<span style="color:#a6e22e">final</span>(<span style="color:#e6db74">&#39;utf8&#39;</span>);
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">decrypted</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">async</span> <span style="color:#a6e22e">storeTokens</span>(<span style="color:#a6e22e">accessToken</span>: <span style="color:#66d9ef">string</span>, <span style="color:#a6e22e">refreshToken</span>: <span style="color:#66d9ef">string</span>, <span style="color:#a6e22e">expiresIn</span>: <span style="color:#66d9ef">number</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">encryptedAccess</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">encrypt</span>(<span style="color:#a6e22e">accessToken</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">encryptedRefresh</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">encrypt</span>(<span style="color:#a6e22e">refreshToken</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">expiresAt</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> Date(Date.<span style="color:#a6e22e">now</span>() <span style="color:#f92672">+</span> <span style="color:#a6e22e">expiresIn</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">1000</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">SettingsModel</span>.<span style="color:#a6e22e">upsert</span>({
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">githubToken</span>: <span style="color:#66d9ef">encryptedAccess.encryptedData</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">githubTokenIv</span>: <span style="color:#66d9ef">encryptedAccess.iv</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">githubRefreshToken</span>: <span style="color:#66d9ef">encryptedRefresh.encryptedData</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">githubRefreshTokenIv</span>: <span style="color:#66d9ef">encryptedRefresh.iv</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">githubTokenExpiresAt</span>: <span style="color:#66d9ef">expiresAt</span>
</span></span><span style="display:flex;"><span>    });
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">async</span> <span style="color:#a6e22e">getAccessToken</span>()<span style="color:#f92672">:</span> <span style="color:#a6e22e">Promise</span>&lt;<span style="color:#f92672">string</span> <span style="color:#960050;background-color:#1e0010">|</span> <span style="color:#a6e22e">null</span>&gt; {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">settings</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">SettingsModel</span>.<span style="color:#a6e22e">getInstance</span>();
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span><span style="color:#a6e22e">settings</span><span style="color:#f92672">?</span>.<span style="color:#a6e22e">githubToken</span> <span style="color:#f92672">||</span> <span style="color:#f92672">!</span><span style="color:#a6e22e">settings</span><span style="color:#f92672">?</span>.<span style="color:#a6e22e">githubTokenIv</span>) {
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">null</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">try</span> {
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">decrypt</span>(<span style="color:#a6e22e">settings</span>.<span style="color:#a6e22e">githubToken</span>, <span style="color:#a6e22e">settings</span>.<span style="color:#a6e22e">githubTokenIv</span>);
</span></span><span style="display:flex;"><span>    } <span style="color:#66d9ef">catch</span> (<span style="color:#a6e22e">error</span>) {
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">error</span>(<span style="color:#e6db74">&#39;Failed to decrypt GitHub token:&#39;</span>, <span style="color:#a6e22e">error</span>);
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">null</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">async</span> <span style="color:#a6e22e">isTokenExpired</span>()<span style="color:#f92672">:</span> <span style="color:#a6e22e">Promise</span>&lt;<span style="color:#f92672">boolean</span>&gt; {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">settings</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">SettingsModel</span>.<span style="color:#a6e22e">getInstance</span>();
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span><span style="color:#a6e22e">settings</span><span style="color:#f92672">?</span>.<span style="color:#a6e22e">githubTokenExpiresAt</span>) {
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">true</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">new</span> Date() <span style="color:#f92672">&gt;=</span> <span style="color:#a6e22e">settings</span>.<span style="color:#a6e22e">githubTokenExpiresAt</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">async</span> <span style="color:#a6e22e">clearTokens() {</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">SettingsModel</span>.<span style="color:#a6e22e">upsert</span>({
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">githubToken</span>: <span style="color:#66d9ef">null</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">githubTokenIv</span>: <span style="color:#66d9ef">null</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">githubRefreshToken</span>: <span style="color:#66d9ef">null</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">githubRefreshTokenIv</span>: <span style="color:#66d9ef">null</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">githubTokenExpiresAt</span>: <span style="color:#66d9ef">null</span>
</span></span><span style="display:flex;"><span>    });
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h2 id="workspace-model-business-logic">Workspace Model Business Logic</h2>
<h3 id="workspace-lifecycle-management">Workspace Lifecycle Management</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-typescript" data-lang="typescript"><span style="display:flex;"><span><span style="color:#66d9ef">export</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">WorkspaceModel</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// Create workspace with validation
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">async</span> <span style="color:#a6e22e">create</span>(<span style="color:#a6e22e">data</span>: <span style="color:#66d9ef">CreateWorkspaceData</span>)<span style="color:#f92672">:</span> <span style="color:#a6e22e">Promise</span>&lt;<span style="color:#f92672">Workspace</span>&gt; {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Validate unique constraints
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">await</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">validateUniqueness</span>(<span style="color:#a6e22e">data</span>.<span style="color:#a6e22e">name</span>, <span style="color:#a6e22e">data</span>.<span style="color:#a6e22e">githubRepo</span>);
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">workspace</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">prisma</span>.<span style="color:#a6e22e">workspace</span>.<span style="color:#a6e22e">create</span>({
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">data</span><span style="color:#f92672">:</span> {
</span></span><span style="display:flex;"><span>        ...<span style="color:#a6e22e">data</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">localPath</span>: <span style="color:#66d9ef">this.generateLocalPath</span>(<span style="color:#a6e22e">data</span>.<span style="color:#a6e22e">name</span>),
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">isActive</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>    });
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Post-creation hooks
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">await</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">onWorkspaceCreated</span>(<span style="color:#a6e22e">workspace</span>);
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">workspace</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">async</span> <span style="color:#a6e22e">validateUniqueness</span>(<span style="color:#a6e22e">name</span>: <span style="color:#66d9ef">string</span>, <span style="color:#a6e22e">githubRepo</span>: <span style="color:#66d9ef">string</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">existing</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">prisma</span>.<span style="color:#a6e22e">workspace</span>.<span style="color:#a6e22e">findFirst</span>({
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">where</span><span style="color:#f92672">:</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">OR</span><span style="color:#f92672">:</span> [
</span></span><span style="display:flex;"><span>          { <span style="color:#a6e22e">name</span> },
</span></span><span style="display:flex;"><span>          { <span style="color:#a6e22e">githubRepo</span> }
</span></span><span style="display:flex;"><span>        ]
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>    });
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">existing</span>) {
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">existing</span>.<span style="color:#a6e22e">name</span> <span style="color:#f92672">===</span> <span style="color:#a6e22e">name</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> Error(<span style="color:#e6db74">`Workspace with name &#34;</span><span style="color:#e6db74">${</span><span style="color:#a6e22e">name</span><span style="color:#e6db74">}</span><span style="color:#e6db74">&#34; already exists`</span>);
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">existing</span>.<span style="color:#a6e22e">githubRepo</span> <span style="color:#f92672">===</span> <span style="color:#a6e22e">githubRepo</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> Error(<span style="color:#e6db74">`Workspace for repository &#34;</span><span style="color:#e6db74">${</span><span style="color:#a6e22e">githubRepo</span><span style="color:#e6db74">}</span><span style="color:#e6db74">&#34; already exists`</span>);
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#a6e22e">generateLocalPath</span>(<span style="color:#a6e22e">name</span>: <span style="color:#66d9ef">string</span>)<span style="color:#f92672">:</span> <span style="color:#66d9ef">string</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">workspaceRoot</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">process</span>.<span style="color:#a6e22e">env</span>.<span style="color:#a6e22e">WORKSPACE_ROOT</span> <span style="color:#f92672">||</span> <span style="color:#e6db74">&#39;./workspaces&#39;</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">path</span>.<span style="color:#a6e22e">join</span>(<span style="color:#a6e22e">workspaceRoot</span>, <span style="color:#a6e22e">name</span>);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">async</span> <span style="color:#a6e22e">onWorkspaceCreated</span>(<span style="color:#a6e22e">workspace</span>: <span style="color:#66d9ef">Workspace</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Log workspace creation
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">AuthLog</span>.<span style="color:#a6e22e">create</span>({
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">action</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;workspace_created&#39;</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">success</span>: <span style="color:#66d9ef">true</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">details</span>: <span style="color:#66d9ef">JSON.stringify</span>({
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">workspaceId</span>: <span style="color:#66d9ef">workspace.id</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">name</span>: <span style="color:#66d9ef">workspace.name</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">githubRepo</span>: <span style="color:#66d9ef">workspace.githubRepo</span>
</span></span><span style="display:flex;"><span>      })
</span></span><span style="display:flex;"><span>    });
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Create initial CLAUDE.md file
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">await</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">generateClaudeFile</span>(<span style="color:#a6e22e">workspace</span>);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// Git operations
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">async</span> <span style="color:#a6e22e">syncWithRemote</span>(<span style="color:#a6e22e">workspaceId</span>: <span style="color:#66d9ef">string</span>, <span style="color:#a6e22e">operation</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;pull&#39;</span> <span style="color:#f92672">|</span> <span style="color:#e6db74">&#39;fetch&#39;</span> <span style="color:#f92672">|</span> <span style="color:#e6db74">&#39;push&#39;</span>)<span style="color:#f92672">:</span> <span style="color:#a6e22e">Promise</span>&lt;<span style="color:#f92672">SyncResult</span>&gt; {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">workspace</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">findByIdOrThrow</span>(<span style="color:#a6e22e">workspaceId</span>);
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">try</span> {
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">result</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">performGitOperation</span>(<span style="color:#a6e22e">workspace</span>, <span style="color:#a6e22e">operation</span>);
</span></span><span style="display:flex;"><span>      
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">// Update sync timestamp
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">prisma</span>.<span style="color:#a6e22e">workspace</span>.<span style="color:#a6e22e">update</span>({
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">where</span><span style="color:#f92672">:</span> { <span style="color:#a6e22e">id</span>: <span style="color:#66d9ef">workspaceId</span> },
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">data</span><span style="color:#f92672">:</span> { <span style="color:#a6e22e">lastSyncAt</span>: <span style="color:#66d9ef">new</span> Date() }
</span></span><span style="display:flex;"><span>      });
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">result</span>;
</span></span><span style="display:flex;"><span>    } <span style="color:#66d9ef">catch</span> (<span style="color:#a6e22e">error</span>) {
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">// Log sync failure
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">AuthLog</span>.<span style="color:#a6e22e">create</span>({
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">action</span><span style="color:#f92672">:</span> <span style="color:#e6db74">`workspace_sync_</span><span style="color:#e6db74">${</span><span style="color:#a6e22e">operation</span><span style="color:#e6db74">}</span><span style="color:#e6db74">`</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">success</span>: <span style="color:#66d9ef">false</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">details</span>: <span style="color:#66d9ef">JSON.stringify</span>({
</span></span><span style="display:flex;"><span>          <span style="color:#a6e22e">workspaceId</span>,
</span></span><span style="display:flex;"><span>          <span style="color:#a6e22e">error</span>: <span style="color:#66d9ef">error.message</span>
</span></span><span style="display:flex;"><span>        })
</span></span><span style="display:flex;"><span>      });
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">throw</span> <span style="color:#a6e22e">error</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">async</span> <span style="color:#a6e22e">performGitOperation</span>(<span style="color:#a6e22e">workspace</span>: <span style="color:#66d9ef">Workspace</span>, <span style="color:#a6e22e">operation</span>: <span style="color:#66d9ef">string</span>)<span style="color:#f92672">:</span> <span style="color:#a6e22e">Promise</span>&lt;<span style="color:#f92672">SyncResult</span>&gt; {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">git</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">simpleGit</span>(<span style="color:#a6e22e">workspace</span>.<span style="color:#a6e22e">localPath</span>);
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">switch</span> (<span style="color:#a6e22e">operation</span>) {
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">case</span> <span style="color:#e6db74">&#39;pull&#39;</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">pullResult</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">git</span>.<span style="color:#a6e22e">pull</span>();
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> {
</span></span><span style="display:flex;"><span>          <span style="color:#a6e22e">operation</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;pull&#39;</span>,
</span></span><span style="display:flex;"><span>          <span style="color:#a6e22e">changes</span>: <span style="color:#66d9ef">pullResult.summary</span>,
</span></span><span style="display:flex;"><span>          <span style="color:#a6e22e">success</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>        };
</span></span><span style="display:flex;"><span>      
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">case</span> <span style="color:#e6db74">&#39;fetch&#39;</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">git</span>.<span style="color:#a6e22e">fetch</span>();
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">status</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">git</span>.<span style="color:#a6e22e">status</span>();
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> {
</span></span><span style="display:flex;"><span>          <span style="color:#a6e22e">operation</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;fetch&#39;</span>,
</span></span><span style="display:flex;"><span>          <span style="color:#a6e22e">behind</span>: <span style="color:#66d9ef">status.behind</span>,
</span></span><span style="display:flex;"><span>          <span style="color:#a6e22e">success</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>        };
</span></span><span style="display:flex;"><span>      
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">case</span> <span style="color:#e6db74">&#39;push&#39;</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">git</span>.<span style="color:#a6e22e">push</span>();
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> {
</span></span><span style="display:flex;"><span>          <span style="color:#a6e22e">operation</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;push&#39;</span>,
</span></span><span style="display:flex;"><span>          <span style="color:#a6e22e">success</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>        };
</span></span><span style="display:flex;"><span>      
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">default</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> Error(<span style="color:#e6db74">`Unsupported git operation: </span><span style="color:#e6db74">${</span><span style="color:#a6e22e">operation</span><span style="color:#e6db74">}</span><span style="color:#e6db74">`</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// Workspace status and monitoring
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">async</span> <span style="color:#a6e22e">getStatus</span>(<span style="color:#a6e22e">workspaceId</span>: <span style="color:#66d9ef">string</span>)<span style="color:#f92672">:</span> <span style="color:#a6e22e">Promise</span>&lt;<span style="color:#f92672">WorkspaceStatus</span>&gt; {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">workspace</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">findByIdOrThrow</span>(<span style="color:#a6e22e">workspaceId</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">git</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">simpleGit</span>(<span style="color:#a6e22e">workspace</span>.<span style="color:#a6e22e">localPath</span>);
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> [<span style="color:#a6e22e">status</span>, <span style="color:#a6e22e">log</span>, <span style="color:#a6e22e">activeSessions</span>] <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">Promise</span>.<span style="color:#a6e22e">all</span>([
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">git</span>.<span style="color:#a6e22e">status</span>(),
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">git</span>.<span style="color:#a6e22e">log</span>({ <span style="color:#a6e22e">maxCount</span>: <span style="color:#66d9ef">1</span> }),
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">prisma</span>.<span style="color:#a6e22e">session</span>.<span style="color:#a6e22e">findMany</span>({
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">where</span><span style="color:#f92672">:</span> {
</span></span><span style="display:flex;"><span>          <span style="color:#a6e22e">workspaceId</span>,
</span></span><span style="display:flex;"><span>          <span style="color:#a6e22e">status</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;active&#39;</span>
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>      })
</span></span><span style="display:flex;"><span>    ]);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> {
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">workspace</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">git</span><span style="color:#f92672">:</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">branch</span>: <span style="color:#66d9ef">status.current</span> <span style="color:#f92672">||</span> <span style="color:#e6db74">&#39;unknown&#39;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">ahead</span>: <span style="color:#66d9ef">status.ahead</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">behind</span>: <span style="color:#66d9ef">status.behind</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">modified</span>: <span style="color:#66d9ef">status.modified</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">staged</span>: <span style="color:#66d9ef">status.staged</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">untracked</span>: <span style="color:#66d9ef">status.not_added</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">lastCommit</span>: <span style="color:#66d9ef">log.latest</span>
</span></span><span style="display:flex;"><span>      },
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">sessions</span>: <span style="color:#66d9ef">activeSessions.length</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">lastActivity</span>: <span style="color:#66d9ef">this.calculateLastActivity</span>(<span style="color:#a6e22e">workspace</span>, <span style="color:#a6e22e">activeSessions</span>)
</span></span><span style="display:flex;"><span>    };
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// Cleanup and maintenance
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">async</span> <span style="color:#a6e22e">cleanupInactive</span>(<span style="color:#a6e22e">inactiveDays</span>: <span style="color:#66d9ef">number</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">30</span>)<span style="color:#f92672">:</span> <span style="color:#a6e22e">Promise</span>&lt;<span style="color:#f92672">number</span>&gt; {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">cutoff</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> Date(Date.<span style="color:#a6e22e">now</span>() <span style="color:#f92672">-</span> <span style="color:#a6e22e">inactiveDays</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">24</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">60</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">60</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">1000</span>);
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">inactiveWorkspaces</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">prisma</span>.<span style="color:#a6e22e">workspace</span>.<span style="color:#a6e22e">findMany</span>({
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">where</span><span style="color:#f92672">:</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">isActive</span>: <span style="color:#66d9ef">false</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">updatedAt</span><span style="color:#f92672">:</span> { <span style="color:#a6e22e">lt</span>: <span style="color:#66d9ef">cutoff</span> },
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">sessions</span><span style="color:#f92672">:</span> {
</span></span><span style="display:flex;"><span>          <span style="color:#a6e22e">none</span><span style="color:#f92672">:</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">status</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;active&#39;</span>
</span></span><span style="display:flex;"><span>          }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>    });
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">cleanedCount</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">const</span> <span style="color:#a6e22e">workspace</span> <span style="color:#66d9ef">of</span> <span style="color:#a6e22e">inactiveWorkspaces</span>) {
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">try</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">await</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">deleteWithCleanup</span>(<span style="color:#a6e22e">workspace</span>.<span style="color:#a6e22e">id</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">cleanedCount</span><span style="color:#f92672">++</span>;
</span></span><span style="display:flex;"><span>      } <span style="color:#66d9ef">catch</span> (<span style="color:#a6e22e">error</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">error</span>(<span style="color:#e6db74">`Failed to cleanup workspace </span><span style="color:#e6db74">${</span><span style="color:#a6e22e">workspace</span>.<span style="color:#a6e22e">id</span><span style="color:#e6db74">}</span><span style="color:#e6db74">:`</span>, <span style="color:#a6e22e">error</span>);
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">cleanedCount</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">async</span> <span style="color:#a6e22e">deleteWithCleanup</span>(<span style="color:#a6e22e">workspaceId</span>: <span style="color:#66d9ef">string</span>)<span style="color:#f92672">:</span> <span style="color:#a6e22e">Promise</span>&lt;<span style="color:#f92672">void</span>&gt; {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">workspace</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">findByIdOrThrow</span>(<span style="color:#a6e22e">workspaceId</span>);
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Remove filesystem directory
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">fs</span>.<span style="color:#a6e22e">existsSync</span>(<span style="color:#a6e22e">workspace</span>.<span style="color:#a6e22e">localPath</span>)) {
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">fs</span>.<span style="color:#a6e22e">promises</span>.<span style="color:#a6e22e">rm</span>(<span style="color:#a6e22e">workspace</span>.<span style="color:#a6e22e">localPath</span>, { <span style="color:#a6e22e">recursive</span>: <span style="color:#66d9ef">true</span> });
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Database cleanup (cascade will handle sessions)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">prisma</span>.<span style="color:#a6e22e">workspace</span>.<span style="color:#66d9ef">delete</span>({
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">where</span><span style="color:#f92672">:</span> { <span style="color:#a6e22e">id</span>: <span style="color:#66d9ef">workspaceId</span> }
</span></span><span style="display:flex;"><span>    });
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Log deletion
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">AuthLog</span>.<span style="color:#a6e22e">create</span>({
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">action</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;workspace_deleted&#39;</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">success</span>: <span style="color:#66d9ef">true</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">details</span>: <span style="color:#66d9ef">JSON.stringify</span>({
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">workspaceId</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">name</span>: <span style="color:#66d9ef">workspace.name</span>
</span></span><span style="display:flex;"><span>      })
</span></span><span style="display:flex;"><span>    });
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="workspace-directory-management">Workspace Directory Management</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-typescript" data-lang="typescript"><span style="display:flex;"><span><span style="color:#66d9ef">export</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">WorkspaceFileManager</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">async</span> <span style="color:#a6e22e">ensureWorkspaceDirectory</span>(<span style="color:#a6e22e">workspace</span>: <span style="color:#66d9ef">Workspace</span>)<span style="color:#f92672">:</span> <span style="color:#a6e22e">Promise</span>&lt;<span style="color:#f92672">void</span>&gt; {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">dir</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">workspace</span>.<span style="color:#a6e22e">localPath</span>;
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span><span style="color:#a6e22e">fs</span>.<span style="color:#a6e22e">existsSync</span>(<span style="color:#a6e22e">dir</span>)) {
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">fs</span>.<span style="color:#a6e22e">promises</span>.<span style="color:#a6e22e">mkdir</span>(<span style="color:#a6e22e">dir</span>, { <span style="color:#a6e22e">recursive</span>: <span style="color:#66d9ef">true</span> });
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Set appropriate permissions (owner read/write/execute)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">fs</span>.<span style="color:#a6e22e">promises</span>.<span style="color:#a6e22e">chmod</span>(<span style="color:#a6e22e">dir</span>, <span style="color:#ae81ff">0</span><span style="color:#a6e22e">o755</span>);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">async</span> <span style="color:#a6e22e">generateClaudeFile</span>(<span style="color:#a6e22e">workspace</span>: <span style="color:#66d9ef">Workspace</span>)<span style="color:#f92672">:</span> <span style="color:#a6e22e">Promise</span>&lt;<span style="color:#f92672">void</span>&gt; {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">claudeFilePath</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">path</span>.<span style="color:#a6e22e">join</span>(<span style="color:#a6e22e">workspace</span>.<span style="color:#a6e22e">localPath</span>, <span style="color:#e6db74">&#39;CLAUDE.md&#39;</span>);
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Don&#39;t overwrite existing CLAUDE.md
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">fs</span>.<span style="color:#a6e22e">existsSync</span>(<span style="color:#a6e22e">claudeFilePath</span>)) {
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">content</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">generateClaudeContent</span>(<span style="color:#a6e22e">workspace</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">fs</span>.<span style="color:#a6e22e">promises</span>.<span style="color:#a6e22e">writeFile</span>(<span style="color:#a6e22e">claudeFilePath</span>, <span style="color:#a6e22e">content</span>, <span style="color:#e6db74">&#39;utf8&#39;</span>);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">async</span> <span style="color:#a6e22e">generateClaudeContent</span>(<span style="color:#a6e22e">workspace</span>: <span style="color:#66d9ef">Workspace</span>)<span style="color:#f92672">:</span> <span style="color:#a6e22e">Promise</span>&lt;<span style="color:#f92672">string</span>&gt; {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">packageJsonPath</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">path</span>.<span style="color:#a6e22e">join</span>(<span style="color:#a6e22e">workspace</span>.<span style="color:#a6e22e">localPath</span>, <span style="color:#e6db74">&#39;package.json&#39;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">projectInfo</span> <span style="color:#f92672">=</span> { <span style="color:#a6e22e">name</span>: <span style="color:#66d9ef">workspace.name</span>, <span style="color:#a6e22e">description</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;&#39;</span> };
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Read project information if available
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">fs</span>.<span style="color:#a6e22e">existsSync</span>(<span style="color:#a6e22e">packageJsonPath</span>)) {
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">try</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">packageJson</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">JSON</span>.<span style="color:#a6e22e">parse</span>(<span style="color:#66d9ef">await</span> <span style="color:#a6e22e">fs</span>.<span style="color:#a6e22e">promises</span>.<span style="color:#a6e22e">readFile</span>(<span style="color:#a6e22e">packageJsonPath</span>, <span style="color:#e6db74">&#39;utf8&#39;</span>));
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">projectInfo</span> <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>          <span style="color:#a6e22e">name</span>: <span style="color:#66d9ef">packageJson.name</span> <span style="color:#f92672">||</span> <span style="color:#a6e22e">workspace</span>.<span style="color:#a6e22e">name</span>,
</span></span><span style="display:flex;"><span>          <span style="color:#a6e22e">description</span>: <span style="color:#66d9ef">packageJson.description</span> <span style="color:#f92672">||</span> <span style="color:#e6db74">&#39;&#39;</span>
</span></span><span style="display:flex;"><span>        };
</span></span><span style="display:flex;"><span>      } <span style="color:#66d9ef">catch</span> (<span style="color:#a6e22e">error</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">warn</span>(<span style="color:#e6db74">&#39;Failed to read package.json:&#39;</span>, <span style="color:#a6e22e">error</span>);
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#e6db74">`# </span><span style="color:#e6db74">${</span><span style="color:#a6e22e">projectInfo</span>.<span style="color:#a6e22e">name</span><span style="color:#e6db74">}</span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">## Project Overview
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"></span><span style="color:#e6db74">${</span><span style="color:#a6e22e">projectInfo</span>.<span style="color:#a6e22e">description</span> <span style="color:#f92672">||</span> <span style="color:#e6db74">&#39;AI Code Terminal workspace for &#39;</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">workspace</span>.<span style="color:#a6e22e">githubRepo</span><span style="color:#e6db74">}</span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">## Repository Information
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">- **GitHub Repository:** </span><span style="color:#e6db74">${</span><span style="color:#a6e22e">workspace</span>.<span style="color:#a6e22e">githubRepo</span><span style="color:#e6db74">}</span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">- **Repository URL:** </span><span style="color:#e6db74">${</span><span style="color:#a6e22e">workspace</span>.<span style="color:#a6e22e">githubUrl</span><span style="color:#e6db74">}</span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">- **Local Path:** </span><span style="color:#e6db74">${</span><span style="color:#a6e22e">workspace</span>.<span style="color:#a6e22e">localPath</span><span style="color:#e6db74">}</span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">- **Default Branch:** </span><span style="color:#e6db74">${</span><span style="color:#a6e22e">workspace</span>.<span style="color:#a6e22e">branch</span><span style="color:#e6db74">}</span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">## Getting Started
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">This workspace was automatically created by AI Code Terminal. You have full access to:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">- Terminal commands
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">- Git operations
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">- File system operations
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">- Claude Code integration
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">## Common Commands
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">\`\`\`bash
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># Git operations
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">git status
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">git pull
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">git push
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># Development
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">npm install
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">npm run dev
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">npm test
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># Claude integration
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">claude chat &#34;Help me understand this codebase&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">claude analyze
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">\`\`\`
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">## Workspace Features
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">- **Real-time terminal:** Full shell access in your browser
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">- **Git integration:** Seamless GitHub operations
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">- **Claude Code:** AI-powered development assistance
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">- **Session persistence:** Your work is automatically saved
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">---
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">*This file was automatically generated by AI Code Terminal*
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">*Last updated: </span><span style="color:#e6db74">${</span><span style="color:#66d9ef">new</span> Date().<span style="color:#a6e22e">toISOString</span>()<span style="color:#e6db74">}</span><span style="color:#e6db74">*
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">`</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">async</span> <span style="color:#a6e22e">getWorkspaceSize</span>(<span style="color:#a6e22e">workspace</span>: <span style="color:#66d9ef">Workspace</span>)<span style="color:#f92672">:</span> <span style="color:#a6e22e">Promise</span>&lt;<span style="color:#f92672">number</span>&gt; {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span><span style="color:#a6e22e">fs</span>.<span style="color:#a6e22e">existsSync</span>(<span style="color:#a6e22e">workspace</span>.<span style="color:#a6e22e">localPath</span>)) {
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">await</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">calculateDirectorySize</span>(<span style="color:#a6e22e">workspace</span>.<span style="color:#a6e22e">localPath</span>);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">async</span> <span style="color:#a6e22e">calculateDirectorySize</span>(<span style="color:#a6e22e">dirPath</span>: <span style="color:#66d9ef">string</span>)<span style="color:#f92672">:</span> <span style="color:#a6e22e">Promise</span>&lt;<span style="color:#f92672">number</span>&gt; {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">files</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">fs</span>.<span style="color:#a6e22e">promises</span>.<span style="color:#a6e22e">readdir</span>(<span style="color:#a6e22e">dirPath</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">size</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">const</span> <span style="color:#a6e22e">file</span> <span style="color:#66d9ef">of</span> <span style="color:#a6e22e">files</span>) {
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">filePath</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">path</span>.<span style="color:#a6e22e">join</span>(<span style="color:#a6e22e">dirPath</span>, <span style="color:#a6e22e">file</span>);
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">stats</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">fs</span>.<span style="color:#a6e22e">promises</span>.<span style="color:#a6e22e">stat</span>(<span style="color:#a6e22e">filePath</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">stats</span>.<span style="color:#a6e22e">isDirectory</span>()) {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">size</span> <span style="color:#f92672">+=</span> <span style="color:#66d9ef">await</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">calculateDirectorySize</span>(<span style="color:#a6e22e">filePath</span>);
</span></span><span style="display:flex;"><span>      } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">size</span> <span style="color:#f92672">+=</span> <span style="color:#a6e22e">stats</span>.<span style="color:#a6e22e">size</span>;
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">size</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h2 id="session-model-business-logic">Session Model Business Logic</h2>
<h3 id="terminal-session-management">Terminal Session Management</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-typescript" data-lang="typescript"><span style="display:flex;"><span><span style="color:#66d9ef">export</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">SessionModel</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// Create new terminal session
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">async</span> <span style="color:#a6e22e">createTerminalSession</span>(
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">workspaceId</span>: <span style="color:#66d9ef">string</span>, 
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">socketId</span>: <span style="color:#66d9ef">string</span>, 
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">options</span>: <span style="color:#66d9ef">SessionOptions</span> <span style="color:#f92672">=</span> {}
</span></span><span style="display:flex;"><span>  )<span style="color:#f92672">:</span> <span style="color:#a6e22e">Promise</span>&lt;<span style="color:#f92672">Session</span>&gt; {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">workspace</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">prisma</span>.<span style="color:#a6e22e">workspace</span>.<span style="color:#a6e22e">findUnique</span>({
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">where</span><span style="color:#f92672">:</span> { <span style="color:#a6e22e">id</span>: <span style="color:#66d9ef">workspaceId</span> }
</span></span><span style="display:flex;"><span>    });
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span><span style="color:#a6e22e">workspace</span>) {
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> Error(<span style="color:#e6db74">`Workspace not found: </span><span style="color:#e6db74">${</span><span style="color:#a6e22e">workspaceId</span><span style="color:#e6db74">}</span><span style="color:#e6db74">`</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">session</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">prisma</span>.<span style="color:#a6e22e">session</span>.<span style="color:#a6e22e">create</span>({
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">data</span><span style="color:#f92672">:</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">workspaceId</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">socketId</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">shell</span>: <span style="color:#66d9ef">options.shell</span> <span style="color:#f92672">||</span> <span style="color:#e6db74">&#39;bash&#39;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">workingDirectory</span>: <span style="color:#66d9ef">workspace.localPath</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">environment</span>: <span style="color:#66d9ef">JSON.stringify</span>(<span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">prepareEnvironment</span>(<span style="color:#a6e22e">workspace</span>, <span style="color:#a6e22e">options</span>.<span style="color:#a6e22e">environment</span>)),
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">status</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;active&#39;</span>
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>    });
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Start terminal process
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">terminalProcess</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">spawnTerminalProcess</span>(<span style="color:#a6e22e">session</span>, <span style="color:#a6e22e">workspace</span>);
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Update session with process info
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">prisma</span>.<span style="color:#a6e22e">session</span>.<span style="color:#a6e22e">update</span>({
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">where</span><span style="color:#f92672">:</span> { <span style="color:#a6e22e">id</span>: <span style="color:#66d9ef">session.id</span> },
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">data</span><span style="color:#f92672">:</span> { <span style="color:#a6e22e">shellPid</span>: <span style="color:#66d9ef">terminalProcess.pid</span> }
</span></span><span style="display:flex;"><span>    });
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#a6e22e">prepareEnvironment</span>(
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">workspace</span>: <span style="color:#66d9ef">Workspace</span>, 
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">customEnv</span>: <span style="color:#66d9ef">Record</span>&lt;<span style="color:#f92672">string</span>, <span style="color:#a6e22e">string</span>&gt; <span style="color:#f92672">=</span> {}
</span></span><span style="display:flex;"><span>  )<span style="color:#f92672">:</span> <span style="color:#a6e22e">Record</span>&lt;<span style="color:#f92672">string</span>, <span style="color:#a6e22e">string</span>&gt; {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> {
</span></span><span style="display:flex;"><span>      ...<span style="color:#a6e22e">process</span>.<span style="color:#a6e22e">env</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">HOME</span>: <span style="color:#66d9ef">workspace.localPath</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">PWD</span>: <span style="color:#66d9ef">workspace.localPath</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">WORKSPACE_NAME</span>: <span style="color:#66d9ef">workspace.name</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">WORKSPACE_REPO</span>: <span style="color:#66d9ef">workspace.githubRepo</span>,
</span></span><span style="display:flex;"><span>      ...<span style="color:#a6e22e">customEnv</span>
</span></span><span style="display:flex;"><span>    };
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">async</span> <span style="color:#a6e22e">spawnTerminalProcess</span>(<span style="color:#a6e22e">session</span>: <span style="color:#66d9ef">Session</span>, <span style="color:#a6e22e">workspace</span>: <span style="color:#66d9ef">Workspace</span>)<span style="color:#f92672">:</span> <span style="color:#a6e22e">Promise</span>&lt;<span style="color:#f92672">ChildProcess</span>&gt; {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">environment</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">JSON</span>.<span style="color:#a6e22e">parse</span>(<span style="color:#a6e22e">session</span>.<span style="color:#a6e22e">environment</span> <span style="color:#f92672">||</span> <span style="color:#e6db74">&#39;{}&#39;</span>);
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">terminalProcess</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">spawn</span>(<span style="color:#a6e22e">session</span>.<span style="color:#a6e22e">shell</span>, [], {
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">cwd</span>: <span style="color:#66d9ef">workspace.localPath</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">env</span>: <span style="color:#66d9ef">environment</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">stdio</span><span style="color:#f92672">:</span> [<span style="color:#e6db74">&#39;pipe&#39;</span>, <span style="color:#e6db74">&#39;pipe&#39;</span>, <span style="color:#e6db74">&#39;pipe&#39;</span>]
</span></span><span style="display:flex;"><span>    });
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Handle process events
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">terminalProcess</span>.<span style="color:#a6e22e">on</span>(<span style="color:#e6db74">&#39;exit&#39;</span>, <span style="color:#66d9ef">async</span> (<span style="color:#a6e22e">code</span>, <span style="color:#a6e22e">signal</span>) <span style="color:#f92672">=&gt;</span> {
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">await</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">handleProcessExit</span>(<span style="color:#a6e22e">session</span>.<span style="color:#a6e22e">id</span>, <span style="color:#a6e22e">code</span>, <span style="color:#a6e22e">signal</span>);
</span></span><span style="display:flex;"><span>    });
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">terminalProcess</span>.<span style="color:#a6e22e">on</span>(<span style="color:#e6db74">&#39;error&#39;</span>, <span style="color:#66d9ef">async</span> (<span style="color:#a6e22e">error</span>) <span style="color:#f92672">=&gt;</span> {
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">await</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">handleProcessError</span>(<span style="color:#a6e22e">session</span>.<span style="color:#a6e22e">id</span>, <span style="color:#a6e22e">error</span>);
</span></span><span style="display:flex;"><span>    });
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">terminalProcess</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// Session activity tracking
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">async</span> <span style="color:#a6e22e">updateActivity</span>(<span style="color:#a6e22e">sessionId</span>: <span style="color:#66d9ef">string</span>)<span style="color:#f92672">:</span> <span style="color:#a6e22e">Promise</span>&lt;<span style="color:#f92672">void</span>&gt; {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">prisma</span>.<span style="color:#a6e22e">session</span>.<span style="color:#a6e22e">update</span>({
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">where</span><span style="color:#f92672">:</span> { <span style="color:#a6e22e">id</span>: <span style="color:#66d9ef">sessionId</span> },
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">data</span><span style="color:#f92672">:</span> { <span style="color:#a6e22e">lastActivityAt</span>: <span style="color:#66d9ef">new</span> Date() }
</span></span><span style="display:flex;"><span>    });
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">async</span> <span style="color:#a6e22e">getActiveSessions</span>(<span style="color:#a6e22e">workspaceId?</span>: <span style="color:#66d9ef">string</span>)<span style="color:#f92672">:</span> <span style="color:#a6e22e">Promise</span>&lt;<span style="color:#f92672">SessionWithWorkspace</span><span style="color:#960050;background-color:#1e0010">[]</span>&gt; {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">prisma</span>.<span style="color:#a6e22e">session</span>.<span style="color:#a6e22e">findMany</span>({
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">where</span><span style="color:#f92672">:</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">status</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;active&#39;</span>,
</span></span><span style="display:flex;"><span>        ...(<span style="color:#a6e22e">workspaceId</span> <span style="color:#f92672">&amp;&amp;</span> { <span style="color:#a6e22e">workspaceId</span> })
</span></span><span style="display:flex;"><span>      },
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">include</span><span style="color:#f92672">:</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">workspace</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>      },
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">orderBy</span><span style="color:#f92672">:</span> { <span style="color:#a6e22e">lastActivityAt</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;desc&#39;</span> }
</span></span><span style="display:flex;"><span>    });
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// Session termination
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">async</span> <span style="color:#a6e22e">terminateSession</span>(<span style="color:#a6e22e">sessionId</span>: <span style="color:#66d9ef">string</span>, <span style="color:#a6e22e">exitCode?</span>: <span style="color:#66d9ef">number</span>)<span style="color:#f92672">:</span> <span style="color:#a6e22e">Promise</span>&lt;<span style="color:#f92672">void</span>&gt; {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">session</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">prisma</span>.<span style="color:#a6e22e">session</span>.<span style="color:#a6e22e">findUnique</span>({
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">where</span><span style="color:#f92672">:</span> { <span style="color:#a6e22e">id</span>: <span style="color:#66d9ef">sessionId</span> }
</span></span><span style="display:flex;"><span>    });
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span><span style="color:#a6e22e">session</span>) {
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> Error(<span style="color:#e6db74">`Session not found: </span><span style="color:#e6db74">${</span><span style="color:#a6e22e">sessionId</span><span style="color:#e6db74">}</span><span style="color:#e6db74">`</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Kill process if still running
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">session</span>.<span style="color:#a6e22e">shellPid</span>) {
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">try</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">process</span>.<span style="color:#a6e22e">kill</span>(<span style="color:#a6e22e">session</span>.<span style="color:#a6e22e">shellPid</span>, <span style="color:#e6db74">&#39;SIGTERM&#39;</span>);
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// Force kill after 5 seconds
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#a6e22e">setTimeout</span>(() <span style="color:#f92672">=&gt;</span> {
</span></span><span style="display:flex;"><span>          <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">session</span>.<span style="color:#a6e22e">shellPid</span>) {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">try</span> {
</span></span><span style="display:flex;"><span>              <span style="color:#a6e22e">process</span>.<span style="color:#a6e22e">kill</span>(<span style="color:#a6e22e">session</span>.<span style="color:#a6e22e">shellPid</span>, <span style="color:#e6db74">&#39;SIGKILL&#39;</span>);
</span></span><span style="display:flex;"><span>            } <span style="color:#66d9ef">catch</span> (<span style="color:#a6e22e">error</span>) {
</span></span><span style="display:flex;"><span>              <span style="color:#75715e">// Process already terminated
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            }
</span></span><span style="display:flex;"><span>          }
</span></span><span style="display:flex;"><span>        }, <span style="color:#ae81ff">5000</span>);
</span></span><span style="display:flex;"><span>      } <span style="color:#66d9ef">catch</span> (<span style="color:#a6e22e">error</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// Process already terminated
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Update session status
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">prisma</span>.<span style="color:#a6e22e">session</span>.<span style="color:#a6e22e">update</span>({
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">where</span><span style="color:#f92672">:</span> { <span style="color:#a6e22e">id</span>: <span style="color:#66d9ef">sessionId</span> },
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">data</span><span style="color:#f92672">:</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">status</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;terminated&#39;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">endedAt</span>: <span style="color:#66d9ef">new</span> Date(),
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">exitCode</span>: <span style="color:#66d9ef">exitCode</span> <span style="color:#f92672">||</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>    });
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">async</span> <span style="color:#a6e22e">handleProcessExit</span>(<span style="color:#a6e22e">sessionId</span>: <span style="color:#66d9ef">string</span>, <span style="color:#a6e22e">code</span>: <span style="color:#66d9ef">number</span> <span style="color:#f92672">|</span> <span style="color:#66d9ef">null</span>, <span style="color:#a6e22e">signal</span>: <span style="color:#66d9ef">NodeJS.Signals</span> <span style="color:#f92672">|</span> <span style="color:#66d9ef">null</span>)<span style="color:#f92672">:</span> <span style="color:#a6e22e">Promise</span>&lt;<span style="color:#f92672">void</span>&gt; {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">prisma</span>.<span style="color:#a6e22e">session</span>.<span style="color:#a6e22e">update</span>({
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">where</span><span style="color:#f92672">:</span> { <span style="color:#a6e22e">id</span>: <span style="color:#66d9ef">sessionId</span> },
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">data</span><span style="color:#f92672">:</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">status</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;terminated&#39;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">endedAt</span>: <span style="color:#66d9ef">new</span> Date(),
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">exitCode</span>: <span style="color:#66d9ef">code</span>
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>    });
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Log session termination
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">AuthLog</span>.<span style="color:#a6e22e">create</span>({
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">action</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;session_terminated&#39;</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">success</span>: <span style="color:#66d9ef">true</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">details</span>: <span style="color:#66d9ef">JSON.stringify</span>({
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">sessionId</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">exitCode</span>: <span style="color:#66d9ef">code</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">signal</span>
</span></span><span style="display:flex;"><span>      })
</span></span><span style="display:flex;"><span>    });
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">async</span> <span style="color:#a6e22e">handleProcessError</span>(<span style="color:#a6e22e">sessionId</span>: <span style="color:#66d9ef">string</span>, <span style="color:#a6e22e">error</span>: <span style="color:#66d9ef">Error</span>)<span style="color:#f92672">:</span> <span style="color:#a6e22e">Promise</span>&lt;<span style="color:#f92672">void</span>&gt; {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">prisma</span>.<span style="color:#a6e22e">session</span>.<span style="color:#a6e22e">update</span>({
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">where</span><span style="color:#f92672">:</span> { <span style="color:#a6e22e">id</span>: <span style="color:#66d9ef">sessionId</span> },
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">data</span><span style="color:#f92672">:</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">status</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;terminated&#39;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">endedAt</span>: <span style="color:#66d9ef">new</span> Date()
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>    });
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Log session error
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">AuthLog</span>.<span style="color:#a6e22e">create</span>({
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">action</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;session_error&#39;</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">success</span>: <span style="color:#66d9ef">false</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">details</span>: <span style="color:#66d9ef">JSON.stringify</span>({
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">sessionId</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">error</span>: <span style="color:#66d9ef">error.message</span>
</span></span><span style="display:flex;"><span>      })
</span></span><span style="display:flex;"><span>    });
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// Session cleanup and maintenance
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">async</span> <span style="color:#a6e22e">cleanupInactiveSessions</span>(<span style="color:#a6e22e">inactiveMinutes</span>: <span style="color:#66d9ef">number</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">60</span>)<span style="color:#f92672">:</span> <span style="color:#a6e22e">Promise</span>&lt;<span style="color:#f92672">number</span>&gt; {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">cutoff</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> Date(Date.<span style="color:#a6e22e">now</span>() <span style="color:#f92672">-</span> <span style="color:#a6e22e">inactiveMinutes</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">60</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">1000</span>);
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">inactiveSessions</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">prisma</span>.<span style="color:#a6e22e">session</span>.<span style="color:#a6e22e">findMany</span>({
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">where</span><span style="color:#f92672">:</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">status</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;active&#39;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">lastActivityAt</span><span style="color:#f92672">:</span> { <span style="color:#a6e22e">lt</span>: <span style="color:#66d9ef">cutoff</span> }
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>    });
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">cleanedCount</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">const</span> <span style="color:#a6e22e">session</span> <span style="color:#66d9ef">of</span> <span style="color:#a6e22e">inactiveSessions</span>) {
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">try</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">await</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">terminateSession</span>(<span style="color:#a6e22e">session</span>.<span style="color:#a6e22e">id</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">cleanedCount</span><span style="color:#f92672">++</span>;
</span></span><span style="display:flex;"><span>      } <span style="color:#66d9ef">catch</span> (<span style="color:#a6e22e">error</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">error</span>(<span style="color:#e6db74">`Failed to cleanup session </span><span style="color:#e6db74">${</span><span style="color:#a6e22e">session</span>.<span style="color:#a6e22e">id</span><span style="color:#e6db74">}</span><span style="color:#e6db74">:`</span>, <span style="color:#a6e22e">error</span>);
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">cleanedCount</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">async</span> <span style="color:#a6e22e">getSessionStatistics</span>()<span style="color:#f92672">:</span> <span style="color:#a6e22e">Promise</span>&lt;<span style="color:#f92672">SessionStatistics</span>&gt; {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> [<span style="color:#a6e22e">active</span>, <span style="color:#a6e22e">total</span>, <span style="color:#a6e22e">recentTerminated</span>] <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">Promise</span>.<span style="color:#a6e22e">all</span>([
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">prisma</span>.<span style="color:#a6e22e">session</span>.<span style="color:#a6e22e">count</span>({ <span style="color:#a6e22e">where</span><span style="color:#f92672">:</span> { <span style="color:#a6e22e">status</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;active&#39;</span> } }),
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">prisma</span>.<span style="color:#a6e22e">session</span>.<span style="color:#a6e22e">count</span>(),
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">prisma</span>.<span style="color:#a6e22e">session</span>.<span style="color:#a6e22e">count</span>({
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">where</span><span style="color:#f92672">:</span> {
</span></span><span style="display:flex;"><span>          <span style="color:#a6e22e">status</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;terminated&#39;</span>,
</span></span><span style="display:flex;"><span>          <span style="color:#a6e22e">endedAt</span><span style="color:#f92672">:</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">gte</span>: <span style="color:#66d9ef">new</span> Date(Date.<span style="color:#a6e22e">now</span>() <span style="color:#f92672">-</span> <span style="color:#ae81ff">24</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">60</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">60</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">1000</span>) <span style="color:#75715e">// Last 24 hours
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>          }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>      })
</span></span><span style="display:flex;"><span>    ]);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> {
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">active</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">total</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">terminated</span>: <span style="color:#66d9ef">recentTerminated</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">averageLifetime</span>: <span style="color:#66d9ef">await</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">calculateAverageSessionLifetime</span>()
</span></span><span style="display:flex;"><span>    };
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">async</span> <span style="color:#a6e22e">calculateAverageSessionLifetime</span>()<span style="color:#f92672">:</span> <span style="color:#a6e22e">Promise</span>&lt;<span style="color:#f92672">number</span>&gt; {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">terminatedSessions</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">prisma</span>.<span style="color:#a6e22e">session</span>.<span style="color:#a6e22e">findMany</span>({
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">where</span><span style="color:#f92672">:</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">status</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;terminated&#39;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">endedAt</span><span style="color:#f92672">:</span> { <span style="color:#a6e22e">not</span>: <span style="color:#66d9ef">null</span> },
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">createdAt</span><span style="color:#f92672">:</span> {
</span></span><span style="display:flex;"><span>          <span style="color:#a6e22e">gte</span>: <span style="color:#66d9ef">new</span> Date(Date.<span style="color:#a6e22e">now</span>() <span style="color:#f92672">-</span> <span style="color:#ae81ff">7</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">24</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">60</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">60</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">1000</span>) <span style="color:#75715e">// Last 7 days
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        }
</span></span><span style="display:flex;"><span>      },
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">select</span><span style="color:#f92672">:</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">createdAt</span>: <span style="color:#66d9ef">true</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">endedAt</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>    });
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">terminatedSessions</span>.<span style="color:#a6e22e">length</span> <span style="color:#f92672">===</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">totalLifetime</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">terminatedSessions</span>.<span style="color:#a6e22e">reduce</span>((<span style="color:#a6e22e">sum</span>, <span style="color:#a6e22e">session</span>) <span style="color:#f92672">=&gt;</span> {
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">lifetime</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">session</span>.<span style="color:#a6e22e">endedAt</span><span style="color:#f92672">!</span>.<span style="color:#a6e22e">getTime</span>() <span style="color:#f92672">-</span> <span style="color:#a6e22e">session</span>.<span style="color:#a6e22e">createdAt</span>.<span style="color:#a6e22e">getTime</span>();
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">sum</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">lifetime</span>;
</span></span><span style="display:flex;"><span>    }, <span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">totalLifetime</span> <span style="color:#f92672">/</span> <span style="color:#a6e22e">terminatedSessions</span>.<span style="color:#a6e22e">length</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h2 id="model-integration-patterns">Model Integration Patterns</h2>
<h3 id="repository-pattern-implementation">Repository Pattern Implementation</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-typescript" data-lang="typescript"><span style="display:flex;"><span><span style="color:#66d9ef">export</span> <span style="color:#66d9ef">abstract</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">BaseRepository</span>&lt;<span style="color:#f92672">T</span>&gt; {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">protected</span> <span style="color:#66d9ef">abstract</span> <span style="color:#a6e22e">model</span>: <span style="color:#66d9ef">any</span>; <span style="color:#75715e">// Prisma model
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">protected</span> <span style="color:#66d9ef">abstract</span> <span style="color:#a6e22e">entityName</span>: <span style="color:#66d9ef">string</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">async</span> <span style="color:#a6e22e">findById</span>(<span style="color:#a6e22e">id</span>: <span style="color:#66d9ef">string</span>)<span style="color:#f92672">:</span> <span style="color:#a6e22e">Promise</span>&lt;<span style="color:#f92672">T</span> <span style="color:#960050;background-color:#1e0010">|</span> <span style="color:#a6e22e">null</span>&gt; {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">await</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">model</span>.<span style="color:#a6e22e">findUnique</span>({ <span style="color:#a6e22e">where</span><span style="color:#f92672">:</span> { <span style="color:#a6e22e">id</span> } });
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">async</span> <span style="color:#a6e22e">findByIdOrThrow</span>(<span style="color:#a6e22e">id</span>: <span style="color:#66d9ef">string</span>)<span style="color:#f92672">:</span> <span style="color:#a6e22e">Promise</span>&lt;<span style="color:#f92672">T</span>&gt; {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">entity</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">findById</span>(<span style="color:#a6e22e">id</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span><span style="color:#a6e22e">entity</span>) {
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> Error(<span style="color:#e6db74">`</span><span style="color:#e6db74">${</span><span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">entityName</span><span style="color:#e6db74">}</span><span style="color:#e6db74"> not found: </span><span style="color:#e6db74">${</span><span style="color:#a6e22e">id</span><span style="color:#e6db74">}</span><span style="color:#e6db74">`</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">entity</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">async</span> <span style="color:#a6e22e">create</span>(<span style="color:#a6e22e">data</span>: <span style="color:#66d9ef">any</span>)<span style="color:#f92672">:</span> <span style="color:#a6e22e">Promise</span>&lt;<span style="color:#f92672">T</span>&gt; {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">await</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">model</span>.<span style="color:#a6e22e">create</span>({ <span style="color:#a6e22e">data</span> });
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">async</span> <span style="color:#a6e22e">update</span>(<span style="color:#a6e22e">id</span>: <span style="color:#66d9ef">string</span>, <span style="color:#a6e22e">data</span>: <span style="color:#66d9ef">any</span>)<span style="color:#f92672">:</span> <span style="color:#a6e22e">Promise</span>&lt;<span style="color:#f92672">T</span>&gt; {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">await</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">model</span>.<span style="color:#a6e22e">update</span>({
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">where</span><span style="color:#f92672">:</span> { <span style="color:#a6e22e">id</span> },
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">data</span>
</span></span><span style="display:flex;"><span>    });
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">async</span> <span style="color:#66d9ef">delete</span>(<span style="color:#a6e22e">id</span>: <span style="color:#66d9ef">string</span>)<span style="color:#f92672">:</span> <span style="color:#a6e22e">Promise</span>&lt;<span style="color:#f92672">T</span>&gt; {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">await</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">model</span>.<span style="color:#66d9ef">delete</span>({ <span style="color:#a6e22e">where</span><span style="color:#f92672">:</span> { <span style="color:#a6e22e">id</span> } });
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">async</span> <span style="color:#a6e22e">findMany</span>(<span style="color:#a6e22e">where?</span>: <span style="color:#66d9ef">any</span>, <span style="color:#a6e22e">include?</span>: <span style="color:#66d9ef">any</span>)<span style="color:#f92672">:</span> <span style="color:#a6e22e">Promise</span>&lt;<span style="color:#f92672">T</span><span style="color:#960050;background-color:#1e0010">[]</span>&gt; {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">await</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">model</span>.<span style="color:#a6e22e">findMany</span>({ <span style="color:#a6e22e">where</span>, <span style="color:#a6e22e">include</span> });
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">async</span> <span style="color:#a6e22e">count</span>(<span style="color:#a6e22e">where?</span>: <span style="color:#66d9ef">any</span>)<span style="color:#f92672">:</span> <span style="color:#a6e22e">Promise</span>&lt;<span style="color:#f92672">number</span>&gt; {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">await</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">model</span>.<span style="color:#a6e22e">count</span>({ <span style="color:#a6e22e">where</span> });
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">export</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">WorkspaceRepository</span> <span style="color:#66d9ef">extends</span> <span style="color:#a6e22e">BaseRepository</span>&lt;<span style="color:#f92672">Workspace</span>&gt; {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">protected</span> <span style="color:#a6e22e">model</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">prisma</span>.<span style="color:#a6e22e">workspace</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">protected</span> <span style="color:#a6e22e">entityName</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;Workspace&#39;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">async</span> <span style="color:#a6e22e">findByName</span>(<span style="color:#a6e22e">name</span>: <span style="color:#66d9ef">string</span>)<span style="color:#f92672">:</span> <span style="color:#a6e22e">Promise</span>&lt;<span style="color:#f92672">Workspace</span> <span style="color:#960050;background-color:#1e0010">|</span> <span style="color:#a6e22e">null</span>&gt; {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">await</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">model</span>.<span style="color:#a6e22e">findUnique</span>({ <span style="color:#a6e22e">where</span><span style="color:#f92672">:</span> { <span style="color:#a6e22e">name</span> } });
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">async</span> <span style="color:#a6e22e">findByGitHubRepo</span>(<span style="color:#a6e22e">githubRepo</span>: <span style="color:#66d9ef">string</span>)<span style="color:#f92672">:</span> <span style="color:#a6e22e">Promise</span>&lt;<span style="color:#f92672">Workspace</span> <span style="color:#960050;background-color:#1e0010">|</span> <span style="color:#a6e22e">null</span>&gt; {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">await</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">model</span>.<span style="color:#a6e22e">findUnique</span>({ <span style="color:#a6e22e">where</span><span style="color:#f92672">:</span> { <span style="color:#a6e22e">githubRepo</span> } });
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">async</span> <span style="color:#a6e22e">findActiveWorkspaces</span>()<span style="color:#f92672">:</span> <span style="color:#a6e22e">Promise</span>&lt;<span style="color:#f92672">Workspace</span><span style="color:#960050;background-color:#1e0010">[]</span>&gt; {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">await</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">model</span>.<span style="color:#a6e22e">findMany</span>({
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">where</span><span style="color:#f92672">:</span> { <span style="color:#a6e22e">isActive</span>: <span style="color:#66d9ef">true</span> },
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">orderBy</span><span style="color:#f92672">:</span> { <span style="color:#a6e22e">updatedAt</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;desc&#39;</span> }
</span></span><span style="display:flex;"><span>    });
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">export</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">SessionRepository</span> <span style="color:#66d9ef">extends</span> <span style="color:#a6e22e">BaseRepository</span>&lt;<span style="color:#f92672">Session</span>&gt; {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">protected</span> <span style="color:#a6e22e">model</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">prisma</span>.<span style="color:#a6e22e">session</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">protected</span> <span style="color:#a6e22e">entityName</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;Session&#39;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">async</span> <span style="color:#a6e22e">findBySocketId</span>(<span style="color:#a6e22e">socketId</span>: <span style="color:#66d9ef">string</span>)<span style="color:#f92672">:</span> <span style="color:#a6e22e">Promise</span>&lt;<span style="color:#f92672">Session</span> <span style="color:#960050;background-color:#1e0010">|</span> <span style="color:#a6e22e">null</span>&gt; {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">await</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">model</span>.<span style="color:#a6e22e">findFirst</span>({ <span style="color:#a6e22e">where</span><span style="color:#f92672">:</span> { <span style="color:#a6e22e">socketId</span> } });
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">async</span> <span style="color:#a6e22e">findActiveSessionsByWorkspace</span>(<span style="color:#a6e22e">workspaceId</span>: <span style="color:#66d9ef">string</span>)<span style="color:#f92672">:</span> <span style="color:#a6e22e">Promise</span>&lt;<span style="color:#f92672">Session</span><span style="color:#960050;background-color:#1e0010">[]</span>&gt; {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">await</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">model</span>.<span style="color:#a6e22e">findMany</span>({
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">where</span><span style="color:#f92672">:</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">workspaceId</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">status</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;active&#39;</span>
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>    });
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="service-layer-pattern">Service Layer Pattern</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-typescript" data-lang="typescript"><span style="display:flex;"><span><span style="color:#66d9ef">export</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">WorkspaceService</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">private</span> <span style="color:#a6e22e">workspaceRepo</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">WorkspaceRepository</span>();
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">private</span> <span style="color:#a6e22e">sessionRepo</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">SessionRepository</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">async</span> <span style="color:#a6e22e">createWorkspace</span>(<span style="color:#a6e22e">data</span>: <span style="color:#66d9ef">CreateWorkspaceRequest</span>)<span style="color:#f92672">:</span> <span style="color:#a6e22e">Promise</span>&lt;<span style="color:#f92672">CreateWorkspaceResponse</span>&gt; {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Business logic validation
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">await</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">validateWorkspaceCreation</span>(<span style="color:#a6e22e">data</span>);
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Create workspace
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">workspace</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">workspaceRepo</span>.<span style="color:#a6e22e">create</span>({
</span></span><span style="display:flex;"><span>      ...<span style="color:#a6e22e">data</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">localPath</span>: <span style="color:#66d9ef">this.generateLocalPath</span>(<span style="color:#a6e22e">data</span>.<span style="color:#a6e22e">name</span>)
</span></span><span style="display:flex;"><span>    });
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Post-creation tasks
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">await</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">setupWorkspaceDirectory</span>(<span style="color:#a6e22e">workspace</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">await</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">cloneRepository</span>(<span style="color:#a6e22e">workspace</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">await</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">generateClaudeFile</span>(<span style="color:#a6e22e">workspace</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> {
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">workspace</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">success</span>: <span style="color:#66d9ef">true</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">message</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;Workspace created successfully&#39;</span>
</span></span><span style="display:flex;"><span>    };
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">async</span> <span style="color:#a6e22e">getWorkspaceWithSessions</span>(<span style="color:#a6e22e">workspaceId</span>: <span style="color:#66d9ef">string</span>)<span style="color:#f92672">:</span> <span style="color:#a6e22e">Promise</span>&lt;<span style="color:#f92672">WorkspaceWithSessions</span>&gt; {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">workspace</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">workspaceRepo</span>.<span style="color:#a6e22e">findByIdOrThrow</span>(<span style="color:#a6e22e">workspaceId</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">sessions</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">sessionRepo</span>.<span style="color:#a6e22e">findActiveSessionsByWorkspace</span>(<span style="color:#a6e22e">workspaceId</span>);
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> {
</span></span><span style="display:flex;"><span>      ...<span style="color:#a6e22e">workspace</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">activeSessions</span>: <span style="color:#66d9ef">sessions</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">sessionCount</span>: <span style="color:#66d9ef">sessions.length</span>
</span></span><span style="display:flex;"><span>    };
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">async</span> <span style="color:#a6e22e">validateWorkspaceCreation</span>(<span style="color:#a6e22e">data</span>: <span style="color:#66d9ef">CreateWorkspaceRequest</span>)<span style="color:#f92672">:</span> <span style="color:#a6e22e">Promise</span>&lt;<span style="color:#f92672">void</span>&gt; {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Check for existing workspace
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">existingByName</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">workspaceRepo</span>.<span style="color:#a6e22e">findByName</span>(<span style="color:#a6e22e">data</span>.<span style="color:#a6e22e">name</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">existingByName</span>) {
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> Error(<span style="color:#e6db74">`Workspace with name &#34;</span><span style="color:#e6db74">${</span><span style="color:#a6e22e">data</span>.<span style="color:#a6e22e">name</span><span style="color:#e6db74">}</span><span style="color:#e6db74">&#34; already exists`</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">existingByRepo</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">workspaceRepo</span>.<span style="color:#a6e22e">findByGitHubRepo</span>(<span style="color:#a6e22e">data</span>.<span style="color:#a6e22e">githubRepo</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">existingByRepo</span>) {
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> Error(<span style="color:#e6db74">`Workspace for repository &#34;</span><span style="color:#e6db74">${</span><span style="color:#a6e22e">data</span>.<span style="color:#a6e22e">githubRepo</span><span style="color:#e6db74">}</span><span style="color:#e6db74">&#34; already exists`</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Check workspace limits
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">activeCount</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">workspaceRepo</span>.<span style="color:#a6e22e">count</span>({ <span style="color:#a6e22e">isActive</span>: <span style="color:#66d9ef">true</span> });
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">maxWorkspaces</span> <span style="color:#f92672">=</span> parseInt(<span style="color:#a6e22e">process</span>.<span style="color:#a6e22e">env</span>.<span style="color:#a6e22e">MAX_WORKSPACES_PER_USER</span> <span style="color:#f92672">||</span> <span style="color:#e6db74">&#39;10&#39;</span>);
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">activeCount</span> <span style="color:#f92672">&gt;=</span> <span style="color:#a6e22e">maxWorkspaces</span>) {
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> Error(<span style="color:#e6db74">`Maximum number of workspaces (</span><span style="color:#e6db74">${</span><span style="color:#a6e22e">maxWorkspaces</span><span style="color:#e6db74">}</span><span style="color:#e6db74">) reached`</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h2 id="type-safety-and-validation">Type Safety and Validation</h2>
<h3 id="generated-types-with-prisma">Generated Types with Prisma</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-typescript" data-lang="typescript"><span style="display:flex;"><span><span style="color:#75715e">// Auto-generated by Prisma
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">export</span> <span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Workspace</span> <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">id</span>: <span style="color:#66d9ef">string</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">name</span>: <span style="color:#66d9ef">string</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">githubRepo</span>: <span style="color:#66d9ef">string</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">githubUrl</span>: <span style="color:#66d9ef">string</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">githubId</span>: <span style="color:#66d9ef">number</span> <span style="color:#f92672">|</span> <span style="color:#66d9ef">null</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">localPath</span>: <span style="color:#66d9ef">string</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">branch</span>: <span style="color:#66d9ef">string</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">description</span>: <span style="color:#66d9ef">string</span> <span style="color:#f92672">|</span> <span style="color:#66d9ef">null</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">isActive</span>: <span style="color:#66d9ef">boolean</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">lastSyncAt</span>: <span style="color:#66d9ef">Date</span> <span style="color:#f92672">|</span> <span style="color:#66d9ef">null</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">createdAt</span>: <span style="color:#66d9ef">Date</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">updatedAt</span>: <span style="color:#66d9ef">Date</span>;
</span></span><span style="display:flex;"><span>};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">export</span> <span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Session</span> <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">id</span>: <span style="color:#66d9ef">string</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">shellPid</span>: <span style="color:#66d9ef">number</span> <span style="color:#f92672">|</span> <span style="color:#66d9ef">null</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">socketId</span>: <span style="color:#66d9ef">string</span> <span style="color:#f92672">|</span> <span style="color:#66d9ef">null</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">shell</span>: <span style="color:#66d9ef">string</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">status</span>: <span style="color:#66d9ef">string</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">workingDirectory</span>: <span style="color:#66d9ef">string</span> <span style="color:#f92672">|</span> <span style="color:#66d9ef">null</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">environment</span>: <span style="color:#66d9ef">string</span> <span style="color:#f92672">|</span> <span style="color:#66d9ef">null</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">lastActivityAt</span>: <span style="color:#66d9ef">Date</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">createdAt</span>: <span style="color:#66d9ef">Date</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">endedAt</span>: <span style="color:#66d9ef">Date</span> <span style="color:#f92672">|</span> <span style="color:#66d9ef">null</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">exitCode</span>: <span style="color:#66d9ef">number</span> <span style="color:#f92672">|</span> <span style="color:#66d9ef">null</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">workspaceId</span>: <span style="color:#66d9ef">string</span> <span style="color:#f92672">|</span> <span style="color:#66d9ef">null</span>;
</span></span><span style="display:flex;"><span>};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Prisma-generated relations
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">export</span> <span style="color:#66d9ef">type</span> <span style="color:#a6e22e">WorkspaceWithSessions</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">Workspace</span> <span style="color:#f92672">&amp;</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">sessions</span>: <span style="color:#66d9ef">Session</span>[];
</span></span><span style="display:flex;"><span>};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">export</span> <span style="color:#66d9ef">type</span> <span style="color:#a6e22e">SessionWithWorkspace</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">Session</span> <span style="color:#f92672">&amp;</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">workspace</span>: <span style="color:#66d9ef">Workspace</span> <span style="color:#f92672">|</span> <span style="color:#66d9ef">null</span>;
</span></span><span style="display:flex;"><span>};
</span></span></code></pre></div><h3 id="runtime-validation-with-zod">Runtime Validation with Zod</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-typescript" data-lang="typescript"><span style="display:flex;"><span><span style="color:#66d9ef">import</span> { <span style="color:#a6e22e">z</span> } <span style="color:#66d9ef">from</span> <span style="color:#e6db74">&#39;zod&#39;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">export</span> <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">CreateWorkspaceSchema</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">z</span>.<span style="color:#66d9ef">object</span>({
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">name</span>: <span style="color:#66d9ef">z.string</span>().<span style="color:#a6e22e">min</span>(<span style="color:#ae81ff">1</span>).<span style="color:#a6e22e">max</span>(<span style="color:#ae81ff">50</span>).<span style="color:#a6e22e">regex</span>(<span style="color:#e6db74">/^[a-zA-Z0-9-_]+$/</span>),
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">githubRepo</span>: <span style="color:#66d9ef">z.string</span>().<span style="color:#a6e22e">regex</span>(<span style="color:#e6db74">/^[a-zA-Z0-9-_.]+\/[a-zA-Z0-9-_.]+$/</span>),
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">githubUrl</span>: <span style="color:#66d9ef">z.string</span>().<span style="color:#a6e22e">url</span>(),
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">githubId</span>: <span style="color:#66d9ef">z.number</span>().<span style="color:#a6e22e">int</span>().<span style="color:#a6e22e">positive</span>().<span style="color:#a6e22e">optional</span>(),
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">branch</span>: <span style="color:#66d9ef">z.string</span>().<span style="color:#a6e22e">min</span>(<span style="color:#ae81ff">1</span>).<span style="color:#66d9ef">default</span>(<span style="color:#e6db74">&#39;main&#39;</span>),
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">description</span>: <span style="color:#66d9ef">z.string</span>().<span style="color:#a6e22e">max</span>(<span style="color:#ae81ff">200</span>).<span style="color:#a6e22e">optional</span>()
</span></span><span style="display:flex;"><span>});
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">export</span> <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">UpdateSessionSchema</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">z</span>.<span style="color:#66d9ef">object</span>({
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">status</span>: <span style="color:#66d9ef">z.enum</span>([<span style="color:#e6db74">&#39;active&#39;</span>, <span style="color:#e6db74">&#39;paused&#39;</span>, <span style="color:#e6db74">&#39;terminated&#39;</span>]),
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">workingDirectory</span>: <span style="color:#66d9ef">z.string</span>().<span style="color:#a6e22e">optional</span>(),
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">environment</span>: <span style="color:#66d9ef">z.record</span>(<span style="color:#a6e22e">z</span>.<span style="color:#66d9ef">string</span>()).<span style="color:#a6e22e">optional</span>()
</span></span><span style="display:flex;"><span>});
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">export</span> <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">SessionOptionsSchema</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">z</span>.<span style="color:#66d9ef">object</span>({
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">shell</span>: <span style="color:#66d9ef">z.enum</span>([<span style="color:#e6db74">&#39;bash&#39;</span>, <span style="color:#e6db74">&#39;zsh&#39;</span>, <span style="color:#e6db74">&#39;fish&#39;</span>]).<span style="color:#66d9ef">default</span>(<span style="color:#e6db74">&#39;bash&#39;</span>),
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">environment</span>: <span style="color:#66d9ef">z.record</span>(<span style="color:#a6e22e">z</span>.<span style="color:#66d9ef">string</span>()).<span style="color:#a6e22e">optional</span>(),
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">workingDirectory</span>: <span style="color:#66d9ef">z.string</span>().<span style="color:#a6e22e">optional</span>()
</span></span><span style="display:flex;"><span>});
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Usage in services
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">export</span> <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">validateAndCreateWorkspace</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">async</span> (<span style="color:#a6e22e">data</span>: <span style="color:#66d9ef">unknown</span>) <span style="color:#f92672">=&gt;</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">validatedData</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">CreateWorkspaceSchema</span>.<span style="color:#a6e22e">parse</span>(<span style="color:#a6e22e">data</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">WorkspaceService</span>.<span style="color:#a6e22e">createWorkspace</span>(<span style="color:#a6e22e">validatedData</span>);
</span></span><span style="display:flex;"><span>};
</span></span></code></pre></div><h2 id="performance-optimization">Performance Optimization</h2>
<h3 id="query-optimization-patterns">Query Optimization Patterns</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-typescript" data-lang="typescript"><span style="display:flex;"><span><span style="color:#75715e">// Efficient queries with selective loading
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">export</span> <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">getWorkspaceDashboard</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">async</span> () <span style="color:#f92672">=&gt;</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">prisma</span>.<span style="color:#a6e22e">workspace</span>.<span style="color:#a6e22e">findMany</span>({
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">where</span><span style="color:#f92672">:</span> { <span style="color:#a6e22e">isActive</span>: <span style="color:#66d9ef">true</span> },
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">select</span><span style="color:#f92672">:</span> {
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">id</span>: <span style="color:#66d9ef">true</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">name</span>: <span style="color:#66d9ef">true</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">githubRepo</span>: <span style="color:#66d9ef">true</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">lastSyncAt</span>: <span style="color:#66d9ef">true</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">updatedAt</span>: <span style="color:#66d9ef">true</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">_count</span><span style="color:#f92672">:</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">select</span><span style="color:#f92672">:</span> {
</span></span><span style="display:flex;"><span>          <span style="color:#a6e22e">sessions</span><span style="color:#f92672">:</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">where</span><span style="color:#f92672">:</span> { <span style="color:#a6e22e">status</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;active&#39;</span> }
</span></span><span style="display:flex;"><span>          }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>    },
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">orderBy</span><span style="color:#f92672">:</span> { <span style="color:#a6e22e">updatedAt</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;desc&#39;</span> },
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">take</span>: <span style="color:#66d9ef">10</span>
</span></span><span style="display:flex;"><span>  });
</span></span><span style="display:flex;"><span>};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Batch operations for efficiency
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">export</span> <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">updateMultipleSessionActivity</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">async</span> (<span style="color:#a6e22e">sessionIds</span>: <span style="color:#66d9ef">string</span>[]) <span style="color:#f92672">=&gt;</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">now</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> Date();
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">prisma</span>.<span style="color:#a6e22e">session</span>.<span style="color:#a6e22e">updateMany</span>({
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">where</span><span style="color:#f92672">:</span> {
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">id</span><span style="color:#f92672">:</span> { <span style="color:#66d9ef">in</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">sessionIds</span> }
</span></span><span style="display:flex;"><span>    },
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">data</span><span style="color:#f92672">:</span> {
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">lastActivityAt</span>: <span style="color:#66d9ef">now</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  });
</span></span><span style="display:flex;"><span>};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Optimized counting with filters
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">export</span> <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">getSystemStats</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">async</span> () <span style="color:#f92672">=&gt;</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> [<span style="color:#a6e22e">workspaceStats</span>, <span style="color:#a6e22e">sessionStats</span>] <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">Promise</span>.<span style="color:#a6e22e">all</span>([
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">prisma</span>.<span style="color:#a6e22e">workspace</span>.<span style="color:#a6e22e">groupBy</span>({
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">by</span><span style="color:#f92672">:</span> [<span style="color:#e6db74">&#39;isActive&#39;</span>],
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">_count</span><span style="color:#f92672">:</span> { <span style="color:#a6e22e">id</span>: <span style="color:#66d9ef">true</span> }
</span></span><span style="display:flex;"><span>    }),
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">prisma</span>.<span style="color:#a6e22e">session</span>.<span style="color:#a6e22e">groupBy</span>({
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">by</span><span style="color:#f92672">:</span> [<span style="color:#e6db74">&#39;status&#39;</span>],
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">_count</span><span style="color:#f92672">:</span> { <span style="color:#a6e22e">id</span>: <span style="color:#66d9ef">true</span> }
</span></span><span style="display:flex;"><span>    })
</span></span><span style="display:flex;"><span>  ]);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">workspaces</span>: <span style="color:#66d9ef">workspaceStats</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">sessions</span>: <span style="color:#66d9ef">sessionStats</span>
</span></span><span style="display:flex;"><span>  };
</span></span><span style="display:flex;"><span>};
</span></span></code></pre></div><h2 id="next-steps">Next Steps</h2>
<ul>
<li><strong><a href="/docs/development/setup/">Development Setup</a>:</strong> Development environment configuration</li>
<li><strong><a href="/docs/development/testing/">Testing</a>:</strong> Model testing strategies</li>
<li><strong><a href="/docs/deployment/production/">Production Setup</a>:</strong> Production data considerations</li>
</ul>

          </div>

          
          <nav class="flex justify-between items-center mt-16 pt-8 border-t border-[rgba(67,79,138,0.2)]">
            <div>
              
            </div>
            <div>
              
              <a href="http://localhost:1313/docs/database/schema/" class="inline-flex flex-col items-end px-6 py-4 bg-[rgba(10,12,26,0.5)] border border-[rgba(67,79,138,0.2)] rounded-lg hover:bg-[rgba(130,170,255,0.05)] hover:border-[#82aaff] transition-all transform hover:-translate-y-1">
                <span class="text-xs text-[#8b9cc2] uppercase tracking-wider mb-1">Next</span>
                <span class="text-[#d4dff3] font-medium">Database Schema</span>
              </a>
              
            </div>
          </nav>
        </article>

        
        <aside class="hidden xl:block w-80 p-8 sticky top-32 self-start max-h-[calc(100vh-8rem)] overflow-y-auto">
          <div class="bg-[rgba(10,12,26,0.3)] border border-[rgba(67,79,138,0.2)] rounded-lg p-6">
            <h3 class="flex items-center text-[#82aaff] font-medium mb-4">
              <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h7"></path>
              </svg>
              On This Page
            </h3>
            <div id="table-of-contents" class="space-y-1">
              
            </div>
          </div>
        </aside>

      </div>
    </main>
  </div>
</div>


<script>
document.addEventListener('DOMContentLoaded', function() {
  
  const mobileSidebarToggle = document.getElementById('mobile-sidebar-toggle');
  const mobileOverlay = document.getElementById('mobile-overlay');
  const sidebar = document.getElementById('docs-sidebar');

  function toggleMobileSidebar() {
    sidebar.classList.toggle('-translate-x-full');
    mobileOverlay.classList.toggle('hidden');
    document.body.classList.toggle('overflow-hidden');
  }

  mobileSidebarToggle.addEventListener('click', toggleMobileSidebar);
  mobileOverlay.addEventListener('click', toggleMobileSidebar);

  
  const navSectionToggles = document.querySelectorAll('.nav-section-toggle');
  
  navSectionToggles.forEach(toggle => {
    toggle.addEventListener('click', function() {
      const section = this.closest('.nav-section');
      const content = section.querySelector('.nav-section-content');
      const chevron = this.querySelector('.chevron');
      
      if (content.style.maxHeight === '0px' || content.style.maxHeight === '') {
        content.style.maxHeight = content.scrollHeight + 'px';
        chevron.style.transform = 'rotate(90deg)';
      } else {
        content.style.maxHeight = '0px';
        chevron.style.transform = 'rotate(0deg)';
      }
    });
  });

  
  const activeLink = document.querySelector('.nav-link.active');
  if (activeLink) {
    const section = activeLink.closest('.nav-section');
    if (section) {
      const content = section.querySelector('.nav-section-content');
      const chevron = section.querySelector('.chevron');
      content.style.maxHeight = content.scrollHeight + 'px';
      chevron.style.transform = 'rotate(90deg)';
    }
  }

  
  function generateTableOfContents() {
    const headings = document.querySelectorAll('article h2, article h3, article h4, article h5, article h6');
    const toc = document.getElementById('table-of-contents');
    
    if (headings.length === 0 || !toc) return;

    headings.forEach((heading, index) => {
      
      if (!heading.id) {
        heading.id = heading.textContent.toLowerCase().replace(/[^a-z0-9]/g, '-').replace(/-+/g, '-').replace(/^-|-$/g, '');
      }

      const link = document.createElement('a');
      link.href = '#' + heading.id;
      link.textContent = heading.textContent;
      link.className = 'block py-1.5 px-3 text-sm text-[#8b9cc2] hover:text-[#d4dff3] hover:bg-[rgba(130,170,255,0.05)] rounded transition-colors';
      
      
      const level = parseInt(heading.tagName.charAt(1));
      if (level > 2) {
        link.style.paddingLeft = `${(level - 2) * 16 + 12}px`;
        link.style.borderLeft = '1px solid rgba(67,79,138,0.2)';
      }

      toc.appendChild(link);
    });

    
    const observer = new IntersectionObserver((entries) => {
      entries.forEach((entry) => {
        const id = entry.target.id;
        const link = toc.querySelector(`a[href="#${id}"]`);
        if (link) {
          if (entry.isIntersecting) {
            toc.querySelectorAll('a').forEach(l => l.classList.remove('!text-[#82aaff]', 'bg-[rgba(130,170,255,0.1)]', 'font-medium'));
            link.classList.add('!text-[#82aaff]', 'bg-[rgba(130,170,255,0.1)]', 'font-medium');
          }
        }
      });
    }, { rootMargin: '-100px 0px -80% 0px' });

    headings.forEach((heading) => {
      observer.observe(heading);
    });
  }

  generateTableOfContents();

  
  document.addEventListener('click', function(e) {
    if (e.target.matches('a[href^="#"]')) {
      e.preventDefault();
      const target = document.querySelector(e.target.getAttribute('href'));
      if (target) {
        target.scrollIntoView({ behavior: 'smooth', block: 'start' });
      }
    }
  });
});
</script>

    </main>

    <footer class="fade-in-section">
    <div class="container">
        <p>&copy; 2025 AI Code Terminal. A statement on developer sovereignty.</p>
    </div>
</footer>
    
<script>
    feather.replace();
</script>

    <script src="/js/docs.js"></script>

</body>
</html>