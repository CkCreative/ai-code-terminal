<!doctype html><html lang=en-us><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><title>Token Management | AI Code Terminal: The AI-Native Shell</title><meta name=description content="Comprehensive token lifecycle management including JWT and OAuth token handling"><meta name=keywords content="AI development,Claude Code,self-hosted terminal,development environment,AI coding,browser terminal,Docker deployment"><meta name=author content="AI Code Terminal"><meta name=robots content="index, follow"><link rel=canonical href=https://act.drmhse.com/docs/authentication/token-management/><meta property="og:type" content="article"><meta property="og:title" content="Token Management | AI Code Terminal: The AI-Native Shell"><meta property="og:description" content="Comprehensive token lifecycle management including JWT and OAuth token handling"><meta property="og:url" content="https://act.drmhse.com/docs/authentication/token-management/"><meta property="og:site_name" content="AI Code Terminal: The AI-Native Shell"><meta property="og:image" content="https://act.drmhse.com/images/claude_code_in_action.png"><meta property="og:image:width" content="1200"><meta property="og:image:height" content="630"><meta property="og:image:alt" content="AI Code Terminal - Browser-based development environment with Claude integration"><meta name=twitter:card content="summary_large_image"><meta name=twitter:title content="Token Management | AI Code Terminal: The AI-Native Shell"><meta name=twitter:description content="Comprehensive token lifecycle management including JWT and OAuth token handling"><meta name=twitter:image content="https://act.drmhse.com/images/claude_code_in_action.png"><meta name=twitter:image:alt content="AI Code Terminal - Browser-based development environment with Claude integration"><link rel=icon type=image/svg+xml href=/terminal-icon.svg><link rel=icon type=image/png href=/favicon.png sizes=32x32><link rel=apple-touch-icon href=/apple-touch-icon.png sizes=180x180><meta name=theme-color content="#010411"><meta name=msapplication-TileColor content="#010411"><link rel=preconnect href=https://fonts.googleapis.com><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@300;400;500&family=Space+Grotesk:wght@400;500;700&display=swap" rel=stylesheet><script src=https://unpkg.com/feather-icons></script><script type=application/ld+json>{"@context":"https://schema.org","@type":"SoftwareApplication","name":"AI Code Terminal: The AI-Native Shell","description":"A self-hosted development environment for the post-IDE era. Code from any device with a fast, lightweight, AI-native shell.","url":"https:\/\/act.drmhse.com\/","applicationCategory":"DeveloperApplication","operatingSystem":"Linux, macOS, Windows","offers":{"@type":"Offer","price":"0","priceCurrency":"USD"},"author":{"@type":"Organization","name":"AI Code Terminal"}}</script><link rel=stylesheet href=/css/docs.min.css integrity crossorigin=anonymous></head><body class=docs-site><main><div class="docs-grid bg-gray-900 text-gray-100 min-h-screen"><aside class=docs-sidebar><div class=logo-section><div class="flex items-center space-x-3"><div class=logo-box><img src=/android-chrome-512x512.png alt="AI Code Terminal" class="w-10 h-10 rounded-lg"></div><h2 class="text-lg font-semibold text-gray-100">sections<br>& Links</h2></div></div><nav class="p-4 space-y-2 overflow-y-auto"><div class=nav-section><button class="nav-section-toggle flex items-center justify-between w-full px-3 py-2 text-sm font-medium text-blue-400 hover:bg-blue-600/5 rounded-lg transition-colors" data-section=getting-started>
<span class="uppercase tracking-wider">Getting Started</span>
<svg class="w-4 h-4 transform transition-transform chevron" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg></button><ul class="nav-section-content mt-1 space-y-1 max-h-0 overflow-hidden transition-all duration-300 ease-in-out"><li><a href=https://act.drmhse.com/docs/getting-started/introduction/ class=nav-link>Introduction</a></li><li><a href=https://act.drmhse.com/docs/getting-started/quick-start/ class=nav-link>Quick Start</a></li><li><a href=https://act.drmhse.com/docs/getting-started/installation/ class=nav-link>Installation</a></li><li><a href=https://act.drmhse.com/docs/getting-started/github-oauth/ class=nav-link>GitHub OAuth Setup</a></li><li><a href=https://act.drmhse.com/docs/getting-started/configuration/ class=nav-link>Configuration</a></li></ul></div><div class=nav-section><button class="nav-section-toggle flex items-center justify-between w-full px-3 py-2 text-sm font-medium text-blue-400 hover:bg-blue-600/5 rounded-lg transition-colors" data-section=core-features>
<span class="uppercase tracking-wider">Core Features</span>
<svg class="w-4 h-4 transform transition-transform chevron" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg></button><ul class="nav-section-content mt-1 space-y-1 max-h-0 overflow-hidden transition-all duration-300 ease-in-out"><li><a href=https://act.drmhse.com/docs/core-features/terminal-access/ class=nav-link>Terminal Access</a></li><li><a href=https://act.drmhse.com/docs/core-features/workspace-management/ class=nav-link>Workspace Management</a></li><li><a href=https://act.drmhse.com/docs/core-features/github-integration/ class=nav-link>GitHub Integration</a></li><li><a href=https://act.drmhse.com/docs/core-features/claude-integration/ class=nav-link>Claude Integration</a></li><li><a href=https://act.drmhse.com/docs/core-features/real-time-features/ class=nav-link>Real-time Features</a></li></ul></div><div class=nav-section><button class="nav-section-toggle flex items-center justify-between w-full px-3 py-2 text-sm font-medium text-blue-400 hover:bg-blue-600/5 rounded-lg transition-colors" data-section=authentication>
<span class="uppercase tracking-wider">Authentication</span>
<svg class="w-4 h-4 transform transition-transform chevron" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg></button><ul class="nav-section-content mt-1 space-y-1 max-h-0 overflow-hidden transition-all duration-300 ease-in-out"><li><a href=https://act.drmhse.com/docs/authentication/auth-flow/ class=nav-link>Authentication Flow</a></li><li><a href=https://act.drmhse.com/docs/authentication/security-features/ class=nav-link>Security Features</a></li><li><a href=https://act.drmhse.com/docs/authentication/token-management/ class="nav-link active">Token Management</a></li></ul></div><div class=nav-section><button class="nav-section-toggle flex items-center justify-between w-full px-3 py-2 text-sm font-medium text-blue-400 hover:bg-blue-600/5 rounded-lg transition-colors" data-section=api>
<span class="uppercase tracking-wider">API & WebSocket</span>
<svg class="w-4 h-4 transform transition-transform chevron" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg></button><ul class="nav-section-content mt-1 space-y-1 max-h-0 overflow-hidden transition-all duration-300 ease-in-out"><li><a href=https://act.drmhse.com/docs/api/endpoints/ class=nav-link>API Endpoints</a></li><li><a href=https://act.drmhse.com/docs/api/websocket/ class=nav-link>WebSocket Events</a></li></ul></div><div class=nav-section><button class="nav-section-toggle flex items-center justify-between w-full px-3 py-2 text-sm font-medium text-blue-400 hover:bg-blue-600/5 rounded-lg transition-colors" data-section=database>
<span class="uppercase tracking-wider">Database</span>
<svg class="w-4 h-4 transform transition-transform chevron" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg></button><ul class="nav-section-content mt-1 space-y-1 max-h-0 overflow-hidden transition-all duration-300 ease-in-out"><li><a href=https://act.drmhse.com/docs/database/schema/ class=nav-link>Database Schema</a></li><li><a href=https://act.drmhse.com/docs/database/models/ class=nav-link>Data Models</a></li></ul></div><div class=nav-section><button class="nav-section-toggle flex items-center justify-between w-full px-3 py-2 text-sm font-medium text-blue-400 hover:bg-blue-600/5 rounded-lg transition-colors" data-section=development>
<span class="uppercase tracking-wider">Development</span>
<svg class="w-4 h-4 transform transition-transform chevron" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg></button><ul class="nav-section-content mt-1 space-y-1 max-h-0 overflow-hidden transition-all duration-300 ease-in-out"><li><a href=https://act.drmhse.com/docs/development/setup/ class=nav-link>Development Setup</a></li><li><a href=https://act.drmhse.com/docs/development/testing/ class=nav-link>Testing</a></li></ul></div><div class=nav-section><button class="nav-section-toggle flex items-center justify-between w-full px-3 py-2 text-sm font-medium text-blue-400 hover:bg-blue-600/5 rounded-lg transition-colors" data-section=deployment>
<span class="uppercase tracking-wider">Deployment</span>
<svg class="w-4 h-4 transform transition-transform chevron" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg></button><ul class="nav-section-content mt-1 space-y-1 max-h-0 overflow-hidden transition-all duration-300 ease-in-out"><li><a href=https://act.drmhse.com/docs/deployment/docker/ class=nav-link>Docker Deployment</a></li></ul></div></nav></aside><main class=docs-main><header class=main-header><div class=container><nav class=main-nav><a href=https://act.drmhse.com/ class=logo><span class=prompt-char>></span> AI Code Terminal</a><div class=nav-links><a href=/docs/getting-started/introduction/ class=nav-link><i data-feather=book></i>
<span>Documentation</span>
</a><a href=/getting-started/ class=nav-link><i data-feather=book-open></i>
<span>Getting Started</span>
</a><a href=https://github.com/drmhse/ai-code-terminal target=_blank rel="noopener noreferrer" class=nav-link><i data-feather=github></i>
<span>View on GitHub</span></a></div></nav></div></header><div class=docs-breadcrumbs><nav class="flex items-center space-x-2 text-sm"><a href=/ class="text-gray-400 hover:text-gray-100 transition-colors">Home</a>
<svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg>
<a href=/docs class="text-gray-400 hover:text-gray-100 transition-colors">Documentation</a>
<svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg>
<a href=https://act.drmhse.com/docs/authentication/ class="text-gray-400 hover:text-gray-100 transition-colors">Authentication & Security</a>
<svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg>
<span class="text-blue-400 font-medium">Token Management</span></nav></div><div class=docs-content><article class="max-w-4xl mx-auto"><header class=mb-8><h1 class="text-3xl lg:text-4xl font-bold text-gray-100 mb-4 leading-tight">Token Management</h1><p class="text-lg text-gray-300 leading-relaxed mb-6">Comprehensive token lifecycle management including JWT and OAuth token handling</p><div class="flex items-center space-x-6 text-sm text-gray-400"><div class="flex items-center space-x-2"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3A9 9 0 113 12a9 9 0 0118 0z"/></svg>
<span>8 min read</span></div></div></header><div class="prose prose-invert prose-lg max-w-none"><h1 id=token-management>Token Management</h1><p>AI Code Terminal implements comprehensive token management for both JWT session tokens and GitHub OAuth tokens, ensuring secure authentication and seamless user experience.</p><h2 id=token-types-overview>Token Types Overview</h2><h3 id=jwt-session-tokens>JWT Session Tokens</h3><p><strong>Purpose:</strong> Client-side session management<br><strong>Lifetime:</strong> 7 days (configurable)<br><strong>Storage:</strong> Client localStorage + optional HttpOnly cookies<br><strong>Scope:</strong> Application authentication and authorization</p><h3 id=github-oauth-access-tokens>GitHub OAuth Access Tokens</h3><p><strong>Purpose:</strong> GitHub API access<br><strong>Lifetime:</strong> 8 hours (GitHub default)<br><strong>Storage:</strong> Encrypted in server database<br><strong>Scope:</strong> GitHub repository and user data access</p><h3 id=github-oauth-refresh-tokens>GitHub OAuth Refresh Tokens</h3><p><strong>Purpose:</strong> Automatic access token renewal<br><strong>Lifetime:</strong> 6 months (GitHub default)<br><strong>Storage:</strong> Encrypted in server database<br><strong>Scope:</strong> Token refresh operations</p><h2 id=jwt-token-lifecycle>JWT Token Lifecycle</h2><h3 id=token-creation>Token Creation</h3><p>JWT tokens are created after successful OAuth authentication:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>createJWTToken</span> <span style=color:#f92672>=</span> (<span style=color:#a6e22e>user</span>, <span style=color:#a6e22e>githubToken</span>) =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>payload</span> <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// User identification
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>userId</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>user</span>.<span style=color:#a6e22e>id</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>username</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>user</span>.<span style=color:#a6e22e>login</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>email</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>user</span>.<span style=color:#a6e22e>email</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>avatarUrl</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>user</span>.<span style=color:#a6e22e>avatar_url</span>,
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Token metadata
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>iat</span><span style=color:#f92672>:</span> Math.<span style=color:#a6e22e>floor</span>(Date.<span style=color:#a6e22e>now</span>() <span style=color:#f92672>/</span> <span style=color:#ae81ff>1000</span>),
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>exp</span><span style=color:#f92672>:</span> Math.<span style=color:#a6e22e>floor</span>(Date.<span style=color:#a6e22e>now</span>() <span style=color:#f92672>/</span> <span style=color:#ae81ff>1000</span>) <span style=color:#f92672>+</span> (<span style=color:#ae81ff>7</span> <span style=color:#f92672>*</span> <span style=color:#ae81ff>24</span> <span style=color:#f92672>*</span> <span style=color:#ae81ff>60</span> <span style=color:#f92672>*</span> <span style=color:#ae81ff>60</span>), <span style=color:#75715e>// 7 days
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>iss</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;ai-code-terminal&#39;</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>aud</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;terminal-user&#39;</span>,
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Additional claims
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>role</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;user&#39;</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>permissions</span><span style=color:#f92672>:</span> [<span style=color:#e6db74>&#39;workspace:create&#39;</span>, <span style=color:#e6db74>&#39;workspace:delete&#39;</span>, <span style=color:#e6db74>&#39;terminal:access&#39;</span>],
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>sessionId</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>crypto</span>.<span style=color:#a6e22e>randomUUID</span>()
</span></span><span style=display:flex><span>  };
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>options</span> <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>algorithm</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;HS256&#39;</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>header</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>typ</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;JWT&#39;</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>alg</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;HS256&#39;</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  };
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>jwt</span>.<span style=color:#a6e22e>sign</span>(<span style=color:#a6e22e>payload</span>, <span style=color:#a6e22e>process</span>.<span style=color:#a6e22e>env</span>.<span style=color:#a6e22e>JWT_SECRET</span>, <span style=color:#a6e22e>options</span>);
</span></span><span style=display:flex><span>};
</span></span></code></pre></div><h3 id=token-storage>Token Storage</h3><p>Multiple storage strategies for different use cases:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#75715e>// Client-side storage options
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>storeJWTToken</span> <span style=color:#f92672>=</span> (<span style=color:#a6e22e>token</span>) =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#75715e>// Primary storage: localStorage for SPA functionality
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#a6e22e>localStorage</span>.<span style=color:#a6e22e>setItem</span>(<span style=color:#e6db74>&#39;jwt_token&#39;</span>, <span style=color:#a6e22e>token</span>);
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>  <span style=color:#75715e>// Secondary storage: sessionStorage for tab-specific sessions
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#a6e22e>sessionStorage</span>.<span style=color:#a6e22e>setItem</span>(<span style=color:#e6db74>&#39;jwt_backup&#39;</span>, <span style=color:#a6e22e>token</span>);
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>  <span style=color:#75715e>// Optional: HttpOnly cookie for additional security
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#75715e>// Set by server, not accessible to JavaScript
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>};
</span></span></code></pre></div><h3 id=token-validation>Token Validation</h3><p>Comprehensive token validation on each request:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>validateJWTToken</span> <span style=color:#f92672>=</span> (<span style=color:#a6e22e>token</span>) =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Verify signature and basic claims
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>decoded</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>jwt</span>.<span style=color:#a6e22e>verify</span>(<span style=color:#a6e22e>token</span>, <span style=color:#a6e22e>process</span>.<span style=color:#a6e22e>env</span>.<span style=color:#a6e22e>JWT_SECRET</span>, {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>algorithms</span><span style=color:#f92672>:</span> [<span style=color:#e6db74>&#39;HS256&#39;</span>],
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>issuer</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;ai-code-terminal&#39;</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>audience</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;terminal-user&#39;</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>clockTolerance</span><span style=color:#f92672>:</span> <span style=color:#ae81ff>30</span> <span style=color:#75715e>// 30 seconds
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    });
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Additional validation
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>now</span> <span style=color:#f92672>=</span> Math.<span style=color:#a6e22e>floor</span>(Date.<span style=color:#a6e22e>now</span>() <span style=color:#f92672>/</span> <span style=color:#ae81ff>1000</span>);
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Check if token is expired
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>decoded</span>.<span style=color:#a6e22e>exp</span> <span style=color:#f92672>&lt;=</span> <span style=color:#a6e22e>now</span>) {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> Error(<span style=color:#e6db74>&#39;Token expired&#39;</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Check if token was issued in the future (clock skew protection)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>decoded</span>.<span style=color:#a6e22e>iat</span> <span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>now</span> <span style=color:#f92672>+</span> <span style=color:#ae81ff>60</span>) {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> Error(<span style=color:#e6db74>&#39;Token issued in future&#39;</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Validate required claims
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>decoded</span>.<span style=color:#a6e22e>userId</span> <span style=color:#f92672>||</span> <span style=color:#f92672>!</span><span style=color:#a6e22e>decoded</span>.<span style=color:#a6e22e>username</span>) {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> Error(<span style=color:#e6db74>&#39;Missing required claims&#39;</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Check tenant validation
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>decoded</span>.<span style=color:#a6e22e>username</span> <span style=color:#f92672>!==</span> <span style=color:#a6e22e>process</span>.<span style=color:#a6e22e>env</span>.<span style=color:#a6e22e>TENANT_GITHUB_USERNAME</span>) {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> Error(<span style=color:#e6db74>&#39;Unauthorized tenant user&#39;</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>decoded</span>;
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>  } <span style=color:#66d9ef>catch</span> (<span style=color:#a6e22e>error</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> Error(<span style=color:#e6db74>`Token validation failed: </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>error</span>.<span style=color:#a6e22e>message</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>};
</span></span></code></pre></div><h3 id=token-refresh-strategy>Token Refresh Strategy</h3><p>JWT tokens cannot be refreshed (by design), requiring OAuth re-authentication:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>handleJWTExpiration</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>async</span> (<span style=color:#a6e22e>expiredToken</span>) =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Attempt to use refresh token for GitHub OAuth
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>newGitHubTokens</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>refreshGitHubTokens</span>();
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Create new JWT with fresh GitHub tokens
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>userInfo</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>getGitHubUserInfo</span>(<span style=color:#a6e22e>newGitHubTokens</span>.<span style=color:#a6e22e>access_token</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>newJWT</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>createJWTToken</span>(<span style=color:#a6e22e>userInfo</span>, <span style=color:#a6e22e>newGitHubTokens</span>.<span style=color:#a6e22e>access_token</span>);
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>newJWT</span>;
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>  } <span style=color:#66d9ef>catch</span> (<span style=color:#a6e22e>error</span>) {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Refresh failed, require full re-authentication
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> Error(<span style=color:#e6db74>&#39;Re-authentication required&#39;</span>);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>};
</span></span></code></pre></div><h2 id=oauth-token-lifecycle>OAuth Token Lifecycle</h2><h3 id=access-token-management>Access Token Management</h3><p>GitHub OAuth access tokens have limited lifetime and require careful management:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>manageGitHubTokens</span> <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>  <span style=color:#75715e>// Store tokens securely
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>async</span> <span style=color:#a6e22e>store</span>(<span style=color:#a6e22e>tokens</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>encryptedAccess</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>encrypt</span>(<span style=color:#a6e22e>tokens</span>.<span style=color:#a6e22e>access_token</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>encryptedRefresh</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>tokens</span>.<span style=color:#a6e22e>refresh_token</span> <span style=color:#f92672>?</span> <span style=color:#a6e22e>encrypt</span>(<span style=color:#a6e22e>tokens</span>.<span style=color:#a6e22e>refresh_token</span>) <span style=color:#f92672>:</span> <span style=color:#66d9ef>null</span>;
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>prisma</span>.<span style=color:#a6e22e>settings</span>.<span style=color:#a6e22e>upsert</span>({
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>where</span><span style=color:#f92672>:</span> { <span style=color:#a6e22e>id</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;singleton&#39;</span> },
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>update</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>githubToken</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>encryptedAccess</span>.<span style=color:#a6e22e>encryptedData</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>githubTokenIv</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>encryptedAccess</span>.<span style=color:#a6e22e>iv</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>githubRefreshToken</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>encryptedRefresh</span><span style=color:#f92672>?</span>.<span style=color:#a6e22e>encryptedData</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>githubRefreshTokenIv</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>encryptedRefresh</span><span style=color:#f92672>?</span>.<span style=color:#a6e22e>iv</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>githubTokenExpiresAt</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>new</span> Date(Date.<span style=color:#a6e22e>now</span>() <span style=color:#f92672>+</span> (<span style=color:#a6e22e>tokens</span>.<span style=color:#a6e22e>expires_in</span> <span style=color:#f92672>*</span> <span style=color:#ae81ff>1000</span>))
</span></span><span style=display:flex><span>      },
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>create</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>id</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;singleton&#39;</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>githubToken</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>encryptedAccess</span>.<span style=color:#a6e22e>encryptedData</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>githubTokenIv</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>encryptedAccess</span>.<span style=color:#a6e22e>iv</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>githubRefreshToken</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>encryptedRefresh</span><span style=color:#f92672>?</span>.<span style=color:#a6e22e>encryptedData</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>githubRefreshTokenIv</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>encryptedRefresh</span><span style=color:#f92672>?</span>.<span style=color:#a6e22e>iv</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>githubTokenExpiresAt</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>new</span> Date(Date.<span style=color:#a6e22e>now</span>() <span style=color:#f92672>+</span> (<span style=color:#a6e22e>tokens</span>.<span style=color:#a6e22e>expires_in</span> <span style=color:#f92672>*</span> <span style=color:#ae81ff>1000</span>))
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    });
</span></span><span style=display:flex><span>  },
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>  <span style=color:#75715e>// Retrieve and decrypt tokens
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>async</span> <span style=color:#a6e22e>retrieve</span>() {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>settings</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>prisma</span>.<span style=color:#a6e22e>settings</span>.<span style=color:#a6e22e>findUnique</span>({
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>where</span><span style=color:#f92672>:</span> { <span style=color:#a6e22e>id</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;singleton&#39;</span> }
</span></span><span style=display:flex><span>    });
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>settings</span><span style=color:#f92672>?</span>.<span style=color:#a6e22e>githubToken</span>) {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> Error(<span style=color:#e6db74>&#39;No GitHub token stored&#39;</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>accessToken</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>decrypt</span>({
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>encryptedData</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>settings</span>.<span style=color:#a6e22e>githubToken</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>iv</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>settings</span>.<span style=color:#a6e22e>githubTokenIv</span>
</span></span><span style=display:flex><span>    });
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> <span style=color:#a6e22e>refreshToken</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>settings</span>.<span style=color:#a6e22e>githubRefreshToken</span>) {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>refreshToken</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>decrypt</span>({
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>encryptedData</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>settings</span>.<span style=color:#a6e22e>githubRefreshToken</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>iv</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>settings</span>.<span style=color:#a6e22e>githubRefreshTokenIv</span>
</span></span><span style=display:flex><span>      });
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>access_token</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>accessToken</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>refresh_token</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>refreshToken</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>expires_at</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>settings</span>.<span style=color:#a6e22e>githubTokenExpiresAt</span>
</span></span><span style=display:flex><span>    };
</span></span><span style=display:flex><span>  },
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>  <span style=color:#75715e>// Check if token needs refresh
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#a6e22e>needsRefresh</span>(<span style=color:#a6e22e>expiresAt</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>now</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> Date();
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>expiry</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> Date(<span style=color:#a6e22e>expiresAt</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>timeUntilExpiry</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>expiry</span>.<span style=color:#a6e22e>getTime</span>() <span style=color:#f92672>-</span> <span style=color:#a6e22e>now</span>.<span style=color:#a6e22e>getTime</span>();
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>fifteenMinutes</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>15</span> <span style=color:#f92672>*</span> <span style=color:#ae81ff>60</span> <span style=color:#f92672>*</span> <span style=color:#ae81ff>1000</span>;
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>timeUntilExpiry</span> <span style=color:#f92672>&lt;</span> <span style=color:#a6e22e>fifteenMinutes</span>;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>};
</span></span></code></pre></div><h3 id=automatic-token-refresh>Automatic Token Refresh</h3><p>Automatic refresh before expiration:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>refreshGitHubTokens</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>async</span> () =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>currentTokens</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>manageGitHubTokens</span>.<span style=color:#a6e22e>retrieve</span>();
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>currentTokens</span>.<span style=color:#a6e22e>refresh_token</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> Error(<span style=color:#e6db74>&#39;No refresh token available&#39;</span>);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>manageGitHubTokens</span>.<span style=color:#a6e22e>needsRefresh</span>(<span style=color:#a6e22e>currentTokens</span>.<span style=color:#a6e22e>expires_at</span>)) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>currentTokens</span>; <span style=color:#75715e>// Still valid
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  }
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>response</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>fetch</span>(<span style=color:#e6db74>&#39;https://github.com/login/oauth/access_token&#39;</span>, {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>method</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;POST&#39;</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>headers</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#39;Accept&#39;</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;application/json&#39;</span>,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#39;Content-Type&#39;</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;application/json&#39;</span>,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#39;User-Agent&#39;</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;AI-Code-Terminal/2.0&#39;</span>
</span></span><span style=display:flex><span>      },
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>body</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>JSON</span>.<span style=color:#a6e22e>stringify</span>({
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>client_id</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>process</span>.<span style=color:#a6e22e>env</span>.<span style=color:#a6e22e>GITHUB_CLIENT_ID</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>client_secret</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>process</span>.<span style=color:#a6e22e>env</span>.<span style=color:#a6e22e>GITHUB_CLIENT_SECRET</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>refresh_token</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>currentTokens</span>.<span style=color:#a6e22e>refresh_token</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>grant_type</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;refresh_token&#39;</span>
</span></span><span style=display:flex><span>      })
</span></span><span style=display:flex><span>    });
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>response</span>.<span style=color:#a6e22e>ok</span>) {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> Error(<span style=color:#e6db74>`Token refresh failed: </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>response</span>.<span style=color:#a6e22e>status</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>newTokens</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>response</span>.<span style=color:#a6e22e>json</span>();
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Store new tokens
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>manageGitHubTokens</span>.<span style=color:#a6e22e>store</span>(<span style=color:#a6e22e>newTokens</span>);
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>newTokens</span>;
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>  } <span style=color:#66d9ef>catch</span> (<span style=color:#a6e22e>error</span>) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>error</span>(<span style=color:#e6db74>&#39;GitHub token refresh failed:&#39;</span>, <span style=color:#a6e22e>error</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> Error(<span style=color:#e6db74>&#39;Token refresh failed, re-authentication required&#39;</span>);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>};
</span></span></code></pre></div><h3 id=token-revocation>Token Revocation</h3><p>Secure token revocation for logout:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>revokeGitHubTokens</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>async</span> () =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>tokens</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>manageGitHubTokens</span>.<span style=color:#a6e22e>retrieve</span>();
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Revoke access token
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>fetch</span>(<span style=color:#e6db74>`https://api.github.com/applications/</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>process</span>.<span style=color:#a6e22e>env</span>.<span style=color:#a6e22e>GITHUB_CLIENT_ID</span><span style=color:#e6db74>}</span><span style=color:#e6db74>/token`</span>, {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>method</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;DELETE&#39;</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>headers</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#39;Authorization&#39;</span><span style=color:#f92672>:</span> <span style=color:#e6db74>`Basic </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>Buffer</span>.<span style=color:#a6e22e>from</span>(<span style=color:#e6db74>`</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>process</span>.<span style=color:#a6e22e>env</span>.<span style=color:#a6e22e>GITHUB_CLIENT_ID</span><span style=color:#e6db74>}</span><span style=color:#e6db74>:</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>process</span>.<span style=color:#a6e22e>env</span>.<span style=color:#a6e22e>GITHUB_CLIENT_SECRET</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>).<span style=color:#a6e22e>toString</span>(<span style=color:#e6db74>&#39;base64&#39;</span>)<span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#39;Accept&#39;</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;application/vnd.github.v3+json&#39;</span>,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#39;User-Agent&#39;</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;AI-Code-Terminal/2.0&#39;</span>
</span></span><span style=display:flex><span>      },
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>body</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>JSON</span>.<span style=color:#a6e22e>stringify</span>({
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>access_token</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>tokens</span>.<span style=color:#a6e22e>access_token</span>
</span></span><span style=display:flex><span>      })
</span></span><span style=display:flex><span>    });
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Clear stored tokens
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>prisma</span>.<span style=color:#a6e22e>settings</span>.<span style=color:#a6e22e>update</span>({
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>where</span><span style=color:#f92672>:</span> { <span style=color:#a6e22e>id</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;singleton&#39;</span> },
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>data</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>githubToken</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>null</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>githubTokenIv</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>null</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>githubRefreshToken</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>null</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>githubRefreshTokenIv</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>null</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>githubTokenExpiresAt</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>null</span>
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    });
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>  } <span style=color:#66d9ef>catch</span> (<span style=color:#a6e22e>error</span>) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>error</span>(<span style=color:#e6db74>&#39;Token revocation failed:&#39;</span>, <span style=color:#a6e22e>error</span>);
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Still clear local tokens even if revocation failed
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>manageGitHubTokens</span>.<span style=color:#a6e22e>clear</span>();
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>};
</span></span></code></pre></div><h2 id=token-security>Token Security</h2><h3 id=encryption-implementation>Encryption Implementation</h3><p>Strong encryption for token storage:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>tokenEncryption</span> <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>algorithm</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;aes-256-cbc&#39;</span>,
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>encrypt</span>(<span style=color:#a6e22e>text</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>key</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>deriveKey</span>();
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>iv</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>crypto</span>.<span style=color:#a6e22e>randomBytes</span>(<span style=color:#ae81ff>16</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>cipher</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>crypto</span>.<span style=color:#a6e22e>createCipher</span>(<span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>algorithm</span>, <span style=color:#a6e22e>key</span>);
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> <span style=color:#a6e22e>encrypted</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>cipher</span>.<span style=color:#a6e22e>update</span>(<span style=color:#a6e22e>text</span>, <span style=color:#e6db74>&#39;utf8&#39;</span>, <span style=color:#e6db74>&#39;hex&#39;</span>);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>encrypted</span> <span style=color:#f92672>+=</span> <span style=color:#a6e22e>cipher</span>.<span style=color:#66d9ef>final</span>(<span style=color:#e6db74>&#39;hex&#39;</span>);
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>iv</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>iv</span>.<span style=color:#a6e22e>toString</span>(<span style=color:#e6db74>&#39;hex&#39;</span>),
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>encryptedData</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>encrypted</span>
</span></span><span style=display:flex><span>    };
</span></span><span style=display:flex><span>  },
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>decrypt</span>(<span style=color:#a6e22e>data</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>key</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>deriveKey</span>();
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>decipher</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>crypto</span>.<span style=color:#a6e22e>createDecipher</span>(<span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>algorithm</span>, <span style=color:#a6e22e>key</span>);
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> <span style=color:#a6e22e>decrypted</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>decipher</span>.<span style=color:#a6e22e>update</span>(<span style=color:#a6e22e>data</span>.<span style=color:#a6e22e>encryptedData</span>, <span style=color:#e6db74>&#39;hex&#39;</span>, <span style=color:#e6db74>&#39;utf8&#39;</span>);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>decrypted</span> <span style=color:#f92672>+=</span> <span style=color:#a6e22e>decipher</span>.<span style=color:#66d9ef>final</span>(<span style=color:#e6db74>&#39;utf8&#39;</span>);
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>decrypted</span>;
</span></span><span style=display:flex><span>  },
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>deriveKey</span>() {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Derive encryption key from JWT secret
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>crypto</span>.<span style=color:#a6e22e>scryptSync</span>(<span style=color:#a6e22e>process</span>.<span style=color:#a6e22e>env</span>.<span style=color:#a6e22e>JWT_SECRET</span>, <span style=color:#e6db74>&#39;ai-code-terminal-salt&#39;</span>, <span style=color:#ae81ff>32</span>);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>};
</span></span></code></pre></div><h3 id=token-sanitization>Token Sanitization</h3><p>Remove tokens from memory after use:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>sanitizeTokens</span> <span style=color:#f92672>=</span> (<span style=color:#a6e22e>tokenObject</span>) =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#75715e>// Overwrite token values in memory
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  Object.<span style=color:#a6e22e>keys</span>(<span style=color:#a6e22e>tokenObject</span>).<span style=color:#a6e22e>forEach</span>(<span style=color:#a6e22e>key</span> =&gt; {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#66d9ef>typeof</span> <span style=color:#a6e22e>tokenObject</span>[<span style=color:#a6e22e>key</span>] <span style=color:#f92672>===</span> <span style=color:#e6db74>&#39;string&#39;</span>) {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>length</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>tokenObject</span>[<span style=color:#a6e22e>key</span>].<span style=color:#a6e22e>length</span>;
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>tokenObject</span>[<span style=color:#a6e22e>key</span>] <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;*&#39;</span>.<span style=color:#a6e22e>repeat</span>(<span style=color:#a6e22e>length</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  });
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>  <span style=color:#75715e>// Force garbage collection if available
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>global</span>.<span style=color:#a6e22e>gc</span>) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>global</span>.<span style=color:#a6e22e>gc</span>();
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>};
</span></span></code></pre></div><h3 id=secure-token-transmission>Secure Token Transmission</h3><p>Best practices for token transmission:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#75715e>// Secure headers for token transmission
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>secureTokenHeaders</span> <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>  <span style=color:#e6db74>&#39;Cache-Control&#39;</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;no-cache, no-store, must-revalidate&#39;</span>,
</span></span><span style=display:flex><span>  <span style=color:#e6db74>&#39;Pragma&#39;</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;no-cache&#39;</span>,
</span></span><span style=display:flex><span>  <span style=color:#e6db74>&#39;Expires&#39;</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;0&#39;</span>,
</span></span><span style=display:flex><span>  <span style=color:#e6db74>&#39;X-Content-Type-Options&#39;</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;nosniff&#39;</span>
</span></span><span style=display:flex><span>};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Token response with security headers
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>app</span>.<span style=color:#a6e22e>post</span>(<span style=color:#e6db74>&#39;/api/auth/token&#39;</span>, (<span style=color:#a6e22e>req</span>, <span style=color:#a6e22e>res</span>) =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#75715e>// Set security headers
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  Object.<span style=color:#a6e22e>entries</span>(<span style=color:#a6e22e>secureTokenHeaders</span>).<span style=color:#a6e22e>forEach</span>(([<span style=color:#a6e22e>header</span>, <span style=color:#a6e22e>value</span>]) =&gt; {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>setHeader</span>(<span style=color:#a6e22e>header</span>, <span style=color:#a6e22e>value</span>);
</span></span><span style=display:flex><span>  });
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>  <span style=color:#75715e>// Return token with metadata
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>json</span>({
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>access_token</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>jwtToken</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>token_type</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;Bearer&#39;</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>expires_in</span><span style=color:#f92672>:</span> <span style=color:#ae81ff>7</span> <span style=color:#f92672>*</span> <span style=color:#ae81ff>24</span> <span style=color:#f92672>*</span> <span style=color:#ae81ff>60</span> <span style=color:#f92672>*</span> <span style=color:#ae81ff>60</span>, <span style=color:#75715e>// 7 days
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>scope</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;terminal:access&#39;</span>
</span></span><span style=display:flex><span>  });
</span></span><span style=display:flex><span>});
</span></span></code></pre></div><h2 id=token-monitoring-and-analytics>Token Monitoring and Analytics</h2><h3 id=token-usage-tracking>Token Usage Tracking</h3><p>Monitor token usage patterns:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>tokenMetrics</span> <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>async</span> <span style=color:#a6e22e>trackTokenUsage</span>(<span style=color:#a6e22e>tokenId</span>, <span style=color:#a6e22e>action</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>prisma</span>.<span style=color:#a6e22e>tokenUsage</span>.<span style=color:#a6e22e>create</span>({
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>data</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>tokenId</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>action</span>, <span style=color:#75715e>// &#39;created&#39;, &#39;validated&#39;, &#39;refreshed&#39;, &#39;revoked&#39;
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#a6e22e>timestamp</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>new</span> Date(),
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>ipAddress</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>req</span>.<span style=color:#a6e22e>ip</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>userAgent</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>req</span>.<span style=color:#a6e22e>get</span>(<span style=color:#e6db74>&#39;User-Agent&#39;</span>)
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    });
</span></span><span style=display:flex><span>  },
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>async</span> <span style=color:#a6e22e>getTokenStats</span>(<span style=color:#a6e22e>timeframe</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;24h&#39;</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>since</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> Date(Date.<span style=color:#a6e22e>now</span>() <span style=color:#f92672>-</span> (<span style=color:#ae81ff>24</span> <span style=color:#f92672>*</span> <span style=color:#ae81ff>60</span> <span style=color:#f92672>*</span> <span style=color:#ae81ff>60</span> <span style=color:#f92672>*</span> <span style=color:#ae81ff>1000</span>));
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>prisma</span>.<span style=color:#a6e22e>tokenUsage</span>.<span style=color:#a6e22e>groupBy</span>({
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>by</span><span style=color:#f92672>:</span> [<span style=color:#e6db74>&#39;action&#39;</span>],
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>where</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>timestamp</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>gte</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>since</span>
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>      },
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>_count</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>action</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    });
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>};
</span></span></code></pre></div><h3 id=security-monitoring>Security Monitoring</h3><p>Monitor for token-related security events:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>securityMonitoring</span> <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>async</span> <span style=color:#a6e22e>checkSuspiciousActivity</span>(<span style=color:#a6e22e>userId</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>oneHour</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> Date(Date.<span style=color:#a6e22e>now</span>() <span style=color:#f92672>-</span> (<span style=color:#ae81ff>60</span> <span style=color:#f92672>*</span> <span style=color:#ae81ff>60</span> <span style=color:#f92672>*</span> <span style=color:#ae81ff>1000</span>));
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>recentFailures</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>prisma</span>.<span style=color:#a6e22e>authenticationLog</span>.<span style=color:#a6e22e>count</span>({
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>where</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>userId</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>success</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>false</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>timestamp</span><span style=color:#f92672>:</span> { <span style=color:#a6e22e>gte</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>oneHour</span> }
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    });
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>recentFailures</span> <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>5</span>) {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>alertSecurityTeam</span>(<span style=color:#e6db74>&#39;Multiple failed authentications&#39;</span>, {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>userId</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>failureCount</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>recentFailures</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>timeframe</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;1 hour&#39;</span>
</span></span><span style=display:flex><span>      });
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  },
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>async</span> <span style=color:#a6e22e>detectTokenAnomaly</span>(<span style=color:#a6e22e>tokenId</span>, <span style=color:#a6e22e>currentRequest</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>recentUsage</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>prisma</span>.<span style=color:#a6e22e>tokenUsage</span>.<span style=color:#a6e22e>findMany</span>({
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>where</span><span style=color:#f92672>:</span> { <span style=color:#a6e22e>tokenId</span> },
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>orderBy</span><span style=color:#f92672>:</span> { <span style=color:#a6e22e>timestamp</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;desc&#39;</span> },
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>take</span><span style=color:#f92672>:</span> <span style=color:#ae81ff>10</span>
</span></span><span style=display:flex><span>    });
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Check for unusual patterns
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>uniqueIPs</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>Set</span>(<span style=color:#a6e22e>recentUsage</span>.<span style=color:#a6e22e>map</span>(<span style=color:#a6e22e>usage</span> =&gt; <span style=color:#a6e22e>usage</span>.<span style=color:#a6e22e>ipAddress</span>));
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>uniqueIPs</span>.<span style=color:#a6e22e>size</span> <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>3</span>) {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>flagSuspiciousToken</span>(<span style=color:#a6e22e>tokenId</span>, <span style=color:#e6db74>&#39;Multiple IP addresses&#39;</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>};
</span></span></code></pre></div><h2 id=token-best-practices>Token Best Practices</h2><h3 id=development-best-practices>Development Best Practices</h3><ol><li><strong>Never Log Tokens</strong> - Ensure tokens never appear in logs</li><li><strong>Use Environment Variables</strong> - Store secrets in environment variables</li><li><strong>Implement Token Rotation</strong> - Regular token refresh</li><li><strong>Validate All Claims</strong> - Comprehensive JWT validation</li><li><strong>Monitor Token Usage</strong> - Track and alert on anomalies</li></ol><h3 id=production-best-practices>Production Best Practices</h3><ol><li><strong>Strong Secrets</strong> - Use cryptographically secure JWT secrets</li><li><strong>HTTPS Only</strong> - All token transmission over HTTPS</li><li><strong>Short Lifetimes</strong> - Minimize token lifetime</li><li><strong>Regular Rotation</strong> - Rotate refresh tokens periodically</li><li><strong>Audit Logging</strong> - Log all token operations</li></ol><h3 id=security-checklist>Security Checklist</h3><ul><li><input disabled type=checkbox> JWT secrets are at least 32 characters</li><li><input disabled type=checkbox> Tokens are encrypted at rest</li><li><input disabled type=checkbox> Token transmission uses HTTPS</li><li><input disabled type=checkbox> Expired tokens are properly cleaned up</li><li><input disabled type=checkbox> Token revocation is implemented</li><li><input disabled type=checkbox> Suspicious activity is monitored</li><li><input disabled type=checkbox> Token lifetime is appropriate</li><li><input disabled type=checkbox> Refresh mechanism is secure</li></ul><h2 id=troubleshooting-token-issues>Troubleshooting Token Issues</h2><h3 id=common-token-problems>Common Token Problems</h3><p><strong>Token Expired Error</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#75715e>// Handle expired JWT
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>error</span>.<span style=color:#a6e22e>name</span> <span style=color:#f92672>===</span> <span style=color:#e6db74>&#39;TokenExpiredError&#39;</span>) {
</span></span><span style=display:flex><span>  <span style=color:#75715e>// Attempt refresh if possible
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>newToken</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>refreshTokens</span>();
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> { <span style=color:#a6e22e>token</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>newToken</span>, <span style=color:#a6e22e>requiresReauth</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>false</span> };
</span></span><span style=display:flex><span>  } <span style=color:#66d9ef>catch</span> (<span style=color:#a6e22e>refreshError</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> { <span style=color:#a6e22e>token</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>null</span>, <span style=color:#a6e22e>requiresReauth</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>true</span> };
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p><strong>Invalid Token Format</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#75715e>// Validate token format
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>validateTokenFormat</span> <span style=color:#f92672>=</span> (<span style=color:#a6e22e>token</span>) =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>token</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> Error(<span style=color:#e6db74>&#39;Token is required&#39;</span>);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>parts</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>token</span>.<span style=color:#a6e22e>split</span>(<span style=color:#e6db74>&#39;.&#39;</span>);
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>parts</span>.<span style=color:#a6e22e>length</span> <span style=color:#f92672>!==</span> <span style=color:#ae81ff>3</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> Error(<span style=color:#e6db74>&#39;Invalid JWT format&#39;</span>);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>token</span>;
</span></span><span style=display:flex><span>};
</span></span></code></pre></div><p><strong>GitHub API Rate Limiting</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#75715e>// Handle GitHub API rate limits
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>makeGitHubAPICall</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>async</span> (<span style=color:#a6e22e>endpoint</span>, <span style=color:#a6e22e>token</span>) =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>response</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>fetch</span>(<span style=color:#a6e22e>endpoint</span>, {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>headers</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#39;Authorization&#39;</span><span style=color:#f92672>:</span> <span style=color:#e6db74>`Bearer </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>token</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>,
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#39;Accept&#39;</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;application/vnd.github.v3+json&#39;</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  });
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>response</span>.<span style=color:#a6e22e>status</span> <span style=color:#f92672>===</span> <span style=color:#ae81ff>403</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>rateLimitReset</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>response</span>.<span style=color:#a6e22e>headers</span>.<span style=color:#a6e22e>get</span>(<span style=color:#e6db74>&#39;x-ratelimit-reset&#39;</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>rateLimitReset</span>) {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>resetTime</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> Date(parseInt(<span style=color:#a6e22e>rateLimitReset</span>) <span style=color:#f92672>*</span> <span style=color:#ae81ff>1000</span>);
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> Error(<span style=color:#e6db74>`Rate limit exceeded. Resets at </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>resetTime</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>response</span>;
</span></span><span style=display:flex><span>};
</span></span></code></pre></div><h2 id=emergency-token-procedures>Emergency Token Procedures</h2><h3 id=token-compromise-response>Token Compromise Response</h3><p>If token compromise is suspected:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>emergencyTokenRevocation</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>async</span> (<span style=color:#a6e22e>reason</span>) =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Revoke all GitHub tokens
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>revokeGitHubTokens</span>();
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Clear all stored tokens
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>prisma</span>.<span style=color:#a6e22e>settings</span>.<span style=color:#a6e22e>deleteMany</span>({});
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Log security incident
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>securityLogger</span>.<span style=color:#a6e22e>error</span>(<span style=color:#e6db74>&#39;Emergency Token Revocation&#39;</span>, {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>reason</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>timestamp</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>new</span> Date().<span style=color:#a6e22e>toISOString</span>(),
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>action</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;all_tokens_revoked&#39;</span>
</span></span><span style=display:flex><span>    });
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Force re-authentication for all clients
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>io</span>.<span style=color:#a6e22e>emit</span>(<span style=color:#e6db74>&#39;force-logout&#39;</span>, { <span style=color:#a6e22e>reason</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;Security incident&#39;</span> });
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>  } <span style=color:#66d9ef>catch</span> (<span style=color:#a6e22e>error</span>) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>securityLogger</span>.<span style=color:#a6e22e>error</span>(<span style=color:#e6db74>&#39;Emergency revocation failed&#39;</span>, { <span style=color:#a6e22e>error</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>error</span>.<span style=color:#a6e22e>message</span> });
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>};
</span></span></code></pre></div><h3 id=token-recovery-procedures>Token Recovery Procedures</h3><p>Procedures for token recovery after incidents:</p><ol><li><strong>Verify Security</strong> - Ensure threat is eliminated</li><li><strong>Generate New Secrets</strong> - Create new JWT secrets</li><li><strong>Clear All Tokens</strong> - Remove all stored tokens</li><li><strong>Force Re-authentication</strong> - Require fresh login</li><li><strong>Monitor Activity</strong> - Watch for continued threats</li><li><strong>Document Incident</strong> - Record details for future prevention</li></ol><h2 id=next-steps>Next Steps</h2><ul><li><strong><a href=/docs/api/endpoints/>API Endpoints</a>:</strong> API authentication requirements</li><li><strong><a href=/docs/api/websocket/>WebSocket Events</a>:</strong> Real-time authentication</li><li><strong><a href=/docs/database/schema/>Database Schema</a>:</strong> Token storage implementation</li></ul></div></article></div><div class=docs-nav><div><div class="text-gray-500 text-sm">prev page</div></div><div><a href=https://act.drmhse.com/docs/authentication/security-features/ class="inline-flex flex-col items-end px-4 py-3 bg-gray-800/50 border border-gray-600 rounded-lg hover:bg-blue-600/5 hover:border-blue-400 transition-all"><span class="text-xs text-gray-400 uppercase tracking-wider mb-1">next page</span>
<span class="text-gray-100 font-medium text-sm">Security Features</span></a></div></div></main><aside class=docs-toc><div class="sticky top-6"><h3 class="text-sm font-semibold text-gray-100 mb-4 text-center">table<br>of<br>content</h3><div id=table-of-contents class=space-y-1></div></div></aside></div><script>document.addEventListener("DOMContentLoaded",function(){const t=document.querySelectorAll(".nav-section-toggle");t.forEach(e=>{e.addEventListener("click",function(){const n=this.closest(".nav-section"),e=n.querySelector(".nav-section-content"),t=this.querySelector(".chevron");e.style.maxHeight==="0px"||e.style.maxHeight===""?(e.style.maxHeight=e.scrollHeight+"px",t.style.transform="rotate(90deg)"):(e.style.maxHeight="0px",t.style.transform="rotate(0deg)")})});const e=document.querySelector(".nav-link.active");if(e){const t=e.closest(".nav-section");if(t){const e=t.querySelector(".nav-section-content"),n=t.querySelector(".chevron");e.style.maxHeight=e.scrollHeight+"px",n.style.transform="rotate(90deg)"}}function n(){const t=document.querySelectorAll("article h2, article h3, article h4, article h5, article h6"),e=document.getElementById("table-of-contents");if(t.length===0||!e)return;t.forEach((t)=>{t.id||(t.id=t.textContent.toLowerCase().replace(/[^a-z0-9]/g,"-").replace(/-+/g,"-").replace(/^-|-$/g,""));const s=document.createElement("a");s.href="#"+t.id,s.textContent=t.textContent,s.className="block py-1.5 px-3 text-xs text-gray-400 hover:text-gray-100 hover:bg-blue-600/5 rounded transition-colors";const o=parseInt(t.tagName.charAt(1));o>2&&(s.style.paddingLeft=`${(o-2)*12+12}px`,s.style.borderLeft="1px solid rgb(75 85 99)"),e.appendChild(s)});const n=new IntersectionObserver(t=>{t.forEach(t=>{const s=t.target.id,n=e.querySelector(`a[href="#${s}"]`);n&&t.isIntersecting&&(e.querySelectorAll("a").forEach(e=>e.classList.remove("!text-blue-400","bg-blue-600/10","font-medium")),n.classList.add("!text-blue-400","bg-blue-600/10","font-medium"))})},{rootMargin:"-100px 0px -80% 0px"});t.forEach(e=>{n.observe(e)})}n(),document.addEventListener("click",function(e){if(e.target.matches('a[href^="#"]')){e.preventDefault();const t=document.querySelector(e.target.getAttribute("href"));t&&t.scrollIntoView({behavior:"smooth",block:"start"})}})})</script></main><script>feather.replace()</script><script src=/js/docs.js></script></body></html>